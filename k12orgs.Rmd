---
title: "K12Orgs"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
library(gmodels)
library(infer)


```

```{r themes and shapefiles}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

regions <- read_csv("Data/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))


color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "grey", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)


```

<br>

# Prep data

Up next is combining the school locations. The MN Department of Education uses their own codes for Minnesota counties and don't relate to countyfp. So I'm going to import their codes and combine them with the countyfp since that's what I'm used to using. I'm also going to import the EDR and planning regions for each county allowing me to analyze the data at various regional levels.

```{r k12 orgs county codes and regions}
k12.county.codes <- read_csv("Data/SLEDS/K12 Org/K12-county-codes.csv")

zip <- read_xlsx("Data/Join docs/zip-city-county.xlsx")

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         edr = ifelse(Name == "Minnesota", "Minnesota", edr) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))

  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))


color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

```

<br>

```{r k12org original data}
k12.org.original <- read_xlsx("Data/SLEDS/K12 Org/K12Orgs 20220629.xlsx") %>%
  distinct(K12OrganizationID, .keep_all = TRUE) %>%
  drop_na(K12OrganizationID) %>%
  mutate(K12OrganizationID = as.integer(K12OrganizationID))

head(k12.org.original)

names(k12.org.original)
```

<br>

This dataset provides each school institution as of June 29, 2022. This isn't a list of each school but rather a list of each K12OrganizationID. Each school will have multiple K12OrganizationID. I'm not sure why and this would be something to ask Meredith.

My goal is to join my standardized region and county code data with this document which will then be joined to the master enrollment document. Unfortunatley the main data does not include county name but rather their own code for county. So I will join their codes with the county names and then use my counties.regions data to bring together the remaining regions.

<br>

```{r k12org joining county and regional data}
k12.org.master <- k12.org.original %>%
  select(K12OrganizationID, County, DistrictName) %>%
  left_join(k12.county.codes[,c(1,2)], by = c("County" = "county.code")) %>%
  rename(county.name = 4) %>%
  mutate(county.name = str_replace(county.name, " County", "")) %>%
  select(K12OrganizationID, DistrictName, county.name) %>%
  mutate(county.name = str_replace(county.name, "Saint Louis", "St. Louis")) %>%
  left_join(counties.regions, by = c("county.name" = "Name")) %>%
  select(-Dem_RUCA, -planning.region, -mif)

head(k12.org.master)

names(k12.org.master)
```

<br>

The k12org master data has `r comma(nrow(k12.org.master), accuracy = 1)` K12OrganizationIDs and `r comma(ncol(k12.org.master), accuracy = 1)` columns. 

Now, I want to calculate how many years each PersonID attended a school in Southwest Minnesota. To do this, I will need to import the original k12Enrollment dataset, join with the K12Organization dataset so I can filter it by EDR and sum up the years by each distinct PersonID.

<br>

```{r years attended SW high school}
enrollment.original <- read_csv("Data/SLEDS/K12 Enrollment/K12Enrollment.csv")  %>%
  mutate(PersonID = as.integer(PersonID),
         K12OrganizationID = as.integer(K12OrganizationID)) %>%
  drop_na(PersonID)

enrollment.k12org <- enrollment.original %>%
  left_join(k12.org.master[,c(1, 6)], by = "K12OrganizationID") %>%
  filter(edr %in% c("EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 8 - Southwest")) %>%
  mutate(year.attended = as.integer(str_sub(K12EnrTimeID, 1, 4)))

years.attended <- enrollment.k12org %>%
  group_by(PersonID, year.attended) %>%
  distinct(PersonID) %>%
  ungroup() %>%
  group_by(PersonID) %>%
  summarise(n.years.attended = n()) %>%
  ungroup()

head(years.attended)

names(years.attended)
```

<br>

Next, I will join both the Organization dataset and the years attended dataset with our master enrollment data using the K12OrganizationID. I will also make sure that all observations from EDR 6E, 6W and 8.

<br>

```{r k12org joining with master enrollment}
graduates <- read_csv("Data/SLEDS/K12 Enrollment/K12Enrollment-master.csv")

master <- graduates %>%
  left_join(k12.org.master, by = "K12OrganizationID") %>%
  left_join(years.attended, by = "PersonID") %>%
  filter(edr %in% c("EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 8 - Southwest"))

head(master)

names(master)

```

<br>

After filtering the dataset so that all observations are from EDR 6E, 6W or 8, there are `r comma(nrow(master), accuracy = 1)` observations. There are `r comma(ncol(master), accuracy = 1)` columns in the master dataset so far.


<br>

# Summary of K12Org

Lets summarize the graduates to see their high schools rural-ness and location. In addition, now that we have joined the graduates and high school location together, we can see if there are any statistically significant differences in the percentage of students based on the demographic information (female, free or reduced free lunch, etc...).

## 

## Summary of high school location

Lets breakdown the graduates by which regions they graduated from. 

Nearly three-quarters of the observations graduated from a county categorized as "town/rural mix". The next highest was 15.7% from urban/town/rural mix and 14.5% from entirely rural.

<br>

```{r prep k12orgs summary, include=FALSE}
k12.org.summary.ruca <- master %>%
  tabyl(Dem_Desc) %>%
  select(Dem_Desc, n, percent) %>%
  mutate(percent = scales::percent(percent, accuracy = .1))

k12.org.summary.edr <- master %>%
  tabyl(edr) %>%
  select(edr, n, percent) %>%
  mutate(percent = scales::percent(percent, accuracy = .1)) %>%
  filter(edr != "Minnesota")
```

```{r table k12orgs ruca summary, echo=FALSE}
datatable(k12.org.summary.ruca, class = "cell-border stripe", filter = "top")

```

<br>

The percentage of graduates coming from EDR 8 and EDR 6E are pretty evenly split with 44% coming from EDR 8 and 37% coming from 6E. EDR 6W had the fewest with 19% of observations originating from a high school in that region.

<br>

```{r table k12orgs eddr summary, echo=FALSE}

datatable(k12.org.summary.edr, class = "cell-border stripe", filter = "top")
```

<br>

Below is a map with the percentages of graduates graduating from high schools located within each county. The schools with the highest percent of graduates/observations are located in Kandiyohi, Lyon and McLeod counties. Each of those have between 11% and 12% of high school graduates since 2008. 

<br>

```{r map k12orgs summary county, echo=FALSE}
mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))


k12.org.summary.county <- master %>%
  tabyl(county.name) %>%
  left_join(counties.regions, by = c("county.name" = "Name")) %>%
  right_join(mn_counties[,c(4,7)], by = "countyfp")

k12.org.summary.county.map <- ggplot(k12.org.summary.county) +
  geom_sf_interactive(color = "grey85", aes(geometry = geometry, fill = percent, data_id = countyfp, tooltip = paste(county.name, "\nNumber of observations: ", comma(n, accuracy = 1), "\nPercent of total observations: ", percent(percent, accuracy = .1), sep = ""))) +
  theme_sf+
  scale_fill_fermenter(palette = "PuBu", direction = 1, labels = scales::percent) +
  labs(title = "Percent of high school graduates by county location of school") +
  theme(legend.box.margin = margin(50, 0, 0, -100),
        text = element_text(size = 18))

girafe(ggobj = k12.org.summary.county.map, height_svg = 10, width_svg = 10) %>%
  girafe_options(opts_sizing(rescale = FALSE))

```

<br>


## Summary of student demographics{.tabset}

<br>

The following analysis looks to see if there are any statistical differences due to rural-ness and geographic location of the high school for the following graduate demographics;

* Were eligible for free or reduced lunch at some point in the dataset
* Are Female
* Have been homeless at some point in the dataset
* Had limited english proficiency at some point in the dataset
* Had non english speakders in home at some point in the dataset
* Participated in a PSEO course at some point in the dataset.

Lets start with the cross-tabs based on RUCA categories. 

The cross-tabs below indicate that there are 4 demographic variables that have proportions statistically different across RUCA categories. Each of the variables are indicated with an asterisk. 

* Free or reduced lunch: a statistically significant lower percentage of graduates from high schools in urban/town/rural mix counties receive free or reduced lunch.
* Limited english proficiency: statistically significantly lower percentage of graduates from high schools in urban/town/rural mix and entirely rural counties were categorized as having limited english proficiency.
*Non-english speaker at home: a significantly lower percentage of graduates from high schools in urban/town/rural mix and entirely rural counties were categorized as having someone in the household where english wasn't the primary language.
* PSEO: a siginficantly higher percentage of graduates from high schools in Urban/town/rural mix counties participated in a PSEO program.

<br>


### RUCA Free or reduced lunch*

Although 39.2% of the total number of graduates in the dataset receive free or reduced lunch, only 29.2% of graduates from high schools in urban/town/rural mix counties did. 

<br>

```{r cross-tabs free and reduced lunch ruca}
CrossTable(master$Dem_Desc, master$economic.status, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>

```{r chart free and reduced lunch ruca}
k12.dem.free.lunch.ruca <- master %>%
  group_by(Dem_Desc) %>%
  summarise(n = n(),
           free.lunch = sum(economic.status)) %>%
  ungroup() %>%
  mutate(pct = free.lunch / n,
         total.pct = sum(free.lunch) / sum(n),
         data_id = as.character(seq(n()))) 

k12.dem.free.lunch.ruca.plot <- ggplot(k12.dem.free.lunch.ruca, aes(Dem_Desc, pct, fill = Dem_Desc)) +
  geom_hline(yintercept = k12.dem.free.lunch.ruca$total.pct, color = "black") +
  geom_col_interactive(size = 5, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nTotal graduates: ", comma(n, accuracy = 1), "\nGraduates received free or reduced lunch: ", comma(free.lunch, accuracy = 1), "\nPercent of total graduates: ", percent(pct, accuracy = .1), sep = ""))) +
  annotate(geom = "text",
           x = 3,
           y = .42,
           label = "All graduates percent, 39.2%",
           size = 5) +
  labs(x="", y = "", color="", title = "Percent of graduates receiving free or reduced lunch")+
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  theme_line+
  scale_fill_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = k12.dem.free.lunch.ruca.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

### RUCA Female

<br>

```{r cross-tabs female ruca}
CrossTable(master$edr, master$Gender, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>

### RUCA Homeless

<br>

```{r cross-tabs homeless ruca}
CrossTable(master$edr, master$HomelessIndicator, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>

### RUCA Limited english*

Although 2.1% of all graduates since 2008 were categorized as having limited english proficiency at least once from their Sophomore to Senior grade levels, the percentage was significantly lower at high schools in urban/town/rural mix counties (.8%) and entirely rural counties (1.2%).

<br>

```{r cross-tabs limited english ruca}
CrossTable(master$Dem_Desc, master$LimitedEnglishProficiencyIndicator, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>

```{r chart limited english ruca}
k12.limited.english.ruca <- master %>%
  group_by(Dem_Desc, LimitedEnglishProficiencyIndicator) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  spread(key = LimitedEnglishProficiencyIndicator,
         value = n) %>%
  mutate(pct = Y / (Y+N),
         total.pct = sum(Y) / (sum(N) + sum(Y)),
         data_id = as.character(seq(n())))

k12.limited.english.ruca.plot <- ggplot(k12.limited.english.ruca, aes(Dem_Desc, pct, fill = Dem_Desc)) +
  geom_hline(yintercept = k12.limited.english.ruca$total.pct, color = "black") +
  geom_col_interactive(size = 5, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nTotal graduates: ", comma(N+Y, accuracy = 1), "\nGraduates with limited english proficiency: ", comma(Y, accuracy = 1), "\nPercent of total graduates: ", percent(pct, accuracy = .1), sep = ""))) +
  annotate(geom = "text",
           x = 3,
           y = .023,
           label = "All graduates percent, 2.1%",
           size = 5) +
  labs(x="", y = "", color="", title = "Percent of graduates with limited english proficiency")+
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  theme_line+
  scale_fill_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = k12.limited.english.ruca.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

### RUCA Non-english in home*

This is the same as limited english proficiency. Statistically lower percentages in urban/town/rural mix and entirely rural counties.

<br>

```{r cross-tabs non english at home ruca}
CrossTable(master$edr, master$non.english.home, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>

```{r chart non-english at home ruca}
k12.non.english.home.ruca <- master %>%
  group_by(Dem_Desc) %>%
  summarise(n = n(),
            non.english = sum(non.english.home)) %>%
  ungroup() %>%
  mutate(pct = non.english / n,
         total.pct = sum(non.english) / sum(n),
         data_id = seq(n()))
  
k12.non.english.home.ruca.plot <- ggplot(k12.non.english.home.ruca, aes(Dem_Desc, pct, fill = Dem_Desc)) +
  geom_hline(yintercept = k12.non.english.home.ruca$total.pct, color = "black") +
  geom_col_interactive(size = 5, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nTotal graduates: ", comma(n, accuracy = 1), "\nGraduates with non-english speaker at home: ", comma(non.english, accuracy = 1), "\nPercent of total graduates: ", percent(pct, accuracy = .1), sep = ""))) +
  annotate(geom = "text",
           x = 3,
           y = .09,
           label = "All graduates percent, 8.7%",
           size = 5) +
  labs(x="", y = "", color="", title = "Percent of graduates with non-english speaker at home")+
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  theme_line+
  scale_fill_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = k12.non.english.home.ruca.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

### RUCA PSEO*

Although 34.7% of all graduates participating in PSEO, there was a significantly higher percentage from high schools in urban/town/rural mix counties (39.9%)

<br>

```{r cross-tabs PSEO ruca}
CrossTable(master$edr, master$pseo.participant, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>

```{r chart pseo ruca}
k12.pseo.ruca<- master %>%
  group_by(Dem_Desc) %>%
  summarise(n = n(),
            pseo.participant = sum(pseo.participant)) %>%
  ungroup() %>%
  mutate(pct = pseo.participant / n,
         total.pct = sum(pseo.participant) / sum(n),
         data_id = seq(n()))
  
k12.pseo.ruca.plot <- ggplot(k12.pseo.ruca, aes(Dem_Desc, pct, fill = Dem_Desc)) +
  geom_hline(yintercept = k12.pseo.ruca$total.pct, color = "black") +
  geom_col_interactive(size = 5, aes(data_id = data_id, tooltip = paste(Dem_Desc, "\nTotal graduates: ", comma(n, accuracy = 1), "\nGraduates participated in PSEO: ", comma(pseo.participant, accuracy = 1), "\nPercent of total graduates: ", percent(pct, accuracy = .1), sep = ""))) +
  annotate(geom = "text",
           x = 2,
           y = .37,
           label = "All graduates percent, 34.7%",
           size = 5) +
  labs(x="", y = "", color="", title = "Percent of graduates participated in PSEO")+
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  theme_line+
  scale_fill_manual(values= color.ruca,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = k12.pseo.ruca.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

## {.unnumbered .unlisted .toc-ignore .tabset}

Next we will look at the cross-tabs by EDR. As expected, the variables with relationships are the same as the RUCA categories (indicated by the asterisk).

* Free or reduced lunch: a statistically significant lower percentage of graduates from high schools in EDR 6E receive free or reduced lunch.
* Limited english proficiency: statistically significantly lower percentage of graduates from high schools in EDR 6W were categorized as having limited english proficiency.
* Non-english speaker at home: a significantly lower percentage of graduates from high schools in EDR 6W  were categorized as having someone in the household where english wasn't the primary language.
* PSEO: a significantly higher percentage of graduates from high schools in EDR 6E counties participated in a PSEO program.

<br>

### EDR Free or reduced lunch*

Although 39.2% of the total number of graduates in the dataset receive free or reduced lunch, only 35.2% of graduates from high schools in EDR 6E did.

<br>

```{r cross-tabs free and reduced lunch edr}
CrossTable(master$edr, master$economic.status, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>

```{r chart free and reduced lunch edr}
k12.dem.free.lunch.edr <- master %>%
  group_by(edr) %>%
  summarise(n = n(),
           free.lunch = sum(economic.status)) %>%
  ungroup() %>%
  mutate(pct = free.lunch / n,
         total.pct = sum(free.lunch) / sum(n),
         data_id = as.character(seq(n()))) 

k12.dem.free.lunch.edr.plot <- ggplot(k12.dem.free.lunch.edr, aes(edr, pct, fill = edr)) +
  geom_hline(yintercept = k12.dem.free.lunch.edr$total.pct, color = "black") +
  geom_col_interactive(size = 5, aes(data_id = data_id, tooltip = paste(edr, "\nTotal graduates: ", comma(n, accuracy = 1), "\nGraduates received free or reduced lunch: ", comma(free.lunch, accuracy = 1), "\nPercent of total graduates: ", percent(pct, accuracy = .1), sep = ""))) +
  annotate(geom = "text",
           x = 1,
           y = .42,
           label = "All graduates percent, 39.2%",
           size = 5) +
  labs(x="", y = "", color="", title = "Percent of graduates receiving free or reduced lunch")+
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  theme_line+
  scale_fill_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = k12.dem.free.lunch.edr.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

### EDR Female

<br>

```{r cross-tabs female edr}
CrossTable(master$edr, master$Gender, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>

### EDR Homeless

<br>

```{r cross-tabs homeless edr}
CrossTable(master$edr, master$HomelessIndicator, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>

### EDR Limited english*

Although 2.1% of all graduates since 2008 were categorized as having limited english proficiency at least once from their Sophomore to Senior grade levels, the percentage was significantly lower at high schools in EDR 6W with .6%.

<br>

```{r cross-tabs limited english edr}
CrossTable(master$edr, master$LimitedEnglishProficiencyIndicator, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>

```{r chart limited english edr}
k12.limited.english.edr <- master %>%
  group_by(edr, LimitedEnglishProficiencyIndicator) %>%
  summarise(n = n()) %>%
  ungroup() %>%
  spread(key = LimitedEnglishProficiencyIndicator,
         value = n) %>%
  mutate(pct = Y / (Y+N),
         total.pct = sum(Y) / (sum(N) + sum(Y)),
         data_id = as.character(seq(n())))

k12.limited.english.edr.plot <- ggplot(k12.limited.english.edr, aes(edr, pct, fill = edr)) +
  geom_hline(yintercept = k12.limited.english.edr$total.pct, color = "black") +
  geom_col_interactive(size = 5, aes(data_id = data_id, tooltip = paste(edr, "\nTotal graduates: ", comma(N+Y, accuracy = 1), "\nGraduates with limited english proficiency: ", comma(Y, accuracy = 1), "\nPercent of total graduates: ", percent(pct, accuracy = .1), sep = ""))) +
  annotate(geom = "text",
           x = 2,
           y = .023,
           label = "All graduates percent, 2.1%",
           size = 5) +
  labs(x="", y = "", color="", title = "Percent of graduates with limited english proficiency")+
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  theme_line+
  scale_fill_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = k12.limited.english.edr.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

### EDR Non-english in home*

This is the same as limited english proficiency. Statistically lower percentages in EDR 6W.

<br>

```{r cross-tabs non english at home edr}
CrossTable(master$edr, master$non.english.home, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>

```{r chart non-english at home edr}
k12.non.english.home.edr <- master %>%
  group_by(edr) %>%
  summarise(n = n(),
            non.english = sum(non.english.home)) %>%
  ungroup() %>%
  mutate(pct = non.english / n,
         total.pct = sum(non.english) / sum(n),
         data_id = seq(n()))
  
k12.non.english.home.edr.plot <- ggplot(k12.non.english.home.edr, aes(edr, pct, fill = edr)) +
  geom_hline(yintercept = k12.non.english.home.edr$total.pct, color = "black") +
  geom_col_interactive(size = 5, aes(data_id = data_id, tooltip = paste(edr, "\nTotal graduates: ", comma(n, accuracy = 1), "\nGraduates with non-english speaker at home: ", comma(non.english, accuracy = 1), "\nPercent of total graduates: ", percent(pct, accuracy = .1), sep = ""))) +
  annotate(geom = "text",
           x = 2,
           y = .09,
           label = "All graduates percent, 8.7%",
           size = 5) +
  labs(x="", y = "", color="", title = "Percent of graduates with non-english speaker at home")+
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  theme_line+
  scale_fill_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = k12.non.english.home.edr.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

### EDR PSEO*

Although 34.7% of all graduates participating in PSEO, there was a significantly higher percentage from high schools in EDR 6E with 36.0%.

<br>

```{r cross-tabs PSEO edr}
CrossTable(master$edr, master$pseo.participant, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>

```{r chart pseo edr}
k12.pseo.edr<- master %>%
  group_by(edr) %>%
  summarise(n = n(),
            pseo.participant = sum(pseo.participant)) %>%
  ungroup() %>%
  mutate(pct = pseo.participant / n,
         total.pct = sum(pseo.participant) / sum(n),
         data_id = seq(n()))
  
k12.pseo.edr.plot <- ggplot(k12.pseo.edr, aes(edr, pct, fill = edr)) +
  geom_hline(yintercept = k12.pseo.edr$total.pct, color = "black") +
  geom_col_interactive(size = 5, aes(data_id = data_id, tooltip = paste(edr, "\nTotal graduates: ", comma(n, accuracy = 1), "\nGraduates participated in PSEO: ", comma(pseo.participant, accuracy = 1), "\nPercent of total graduates: ", percent(pct, accuracy = .1), sep = ""))) +
  annotate(geom = "text",
           x = 2,
           y = .37,
           label = "All graduates percent, 34.7%",
           size = 5) +
  labs(x="", y = "", color="", title = "Percent of graduates participated in PSEO")+
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, size = 5) +
  scale_y_continuous(labels=scales::percent)+
  theme_line+
  scale_fill_manual(values= color.edr,
                     guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))

  girafe(ggobj = k12.pseo.edr.plot, width_svg = 10, height_svg = 7) %>%
    girafe_options(opts_selection(type = "none"),
                   opts_toolbar(saveaspng = FALSE),
                   opts_sizing(rescale = FALSE))


```

<br>

# Summary of years attended

First, lets see the distribution of the number of years attending a Southwest High School within this dataset.

A large majority of students (~30,000 students) attended a Southwest MN High School for 4 years. A few attended for longer than that, which is largely due to students who attended a CTE course after they graduated for special training.

<br>

```{r n years attending distribution}
  n.years.distribution.map <- ggplot(master, aes(n.years.attended)) +
    geom_histogram() +
    labs(x="", y = "", color="", title = "Distribution of the number of years attending a\nSouthwest MN High School in dataset")+
    scale_y_continuous(labels=scales::comma)+
  theme_bar + 
    theme(legend.position = "none",
          text = element_text(size = 18))


girafe(ggobj = n.years.distribution.map, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))

```

<br>

Next, we will look at the summary statistics for the entire dataset.

As expected, the median is 4 years while the average was just a bit lower with 3.78 years.

<br>


```{r years attended summary statisics}
n.years.attended.summary.total <- master %>%
  summarise(n = comma(n(), accuracy = 1),
            mean = comma(mean(n.years.attended), accuracy = .01),
            median = comma(median(n.years.attended), accuracy = 1),
            standard.deviation = comma(sd(n.years.attended), accuracy = 0.01)) 

datatable(n.years.attended.summary.total,
          options = list(
            columnDefs = list(list(className = "dt-center", targets = 1:4))
          ))
```

<br>

Next we will check to see if there are any significant differences by using the t-test for the mean by RUCA groups as well as a summary for each of the RUCA groups.

The ANOVA table indicates that there is a statistically significant difference in the average number of years students attended a Southwest MN High School in the dataset between RUCA groups. In particular, the mean for the Entirely Rural group is significantly different than both the town/rural mix and urban/town/rural mix county group.

The table shows that the average number of years attended for entirely rural high schools is 3.72 vs. 3.80 and 3.79 for town/rura mix and urban/town/rural mix county groups. 

<br>

# {.unnumbered .unlisted .toc-ignore .tabset}

## Summary table - RUCA

```{r n years attended summary ruca}
n.years.attended.summary.ruca <- master %>%
  group_by(Dem_Desc) %>%
  summarise(n = comma(n(), accuracy = 1),
            mean = comma(mean(n.years.attended), accuracy = .01),
            median = comma(median(n.years.attended), accuracy = 1),
            sd = comma(sd(n.years.attended), accuracy = .01)) %>%
  ungroup()

datatable(n.years.attended.summary.ruca, class = "cell-border stripe", filter = "top", rownames = FALSE, options = list(
  columnDefs = list(list(className = "dt-center", targets = 1:4))
))
```

## ANOVA - RUCA

```{r n years attended t test average ruca}
summary <- aov(n.years.attended ~ Dem_Desc, data = master)

summary(summary)

TukeyHSD(summary)
```

# {.unnumbered .unlisted .toc-ignore .tabset}

Next we will do the same analysis for EDRs.

The ANOVA test shows that the p-value isn't at the threshold to reject the NULL hypothesis (p-value < .01). Therefore, we consider the means of the number of years attended by students at a Southwest MN High School to not be different between EDRs. 

<br>

## Summary table - EDR

```{r n years attended summary edr}
n.years.attended.summary.edr <- master %>%
  group_by(edr) %>%
  summarise(n = comma(n(), accuracy = 1),
            mean = comma(mean(n.years.attended), accuracy = .01),
            median = comma(median(n.years.attended), accuracy = 1),
            sd = comma(sd(n.years.attended), accuracy = .01)) %>%
  ungroup()

datatable(n.years.attended.summary.edr, class = "cell-border stripe", filter = "top", rownames = FALSE, options = list(
  columnDefs = list(list(className = "dt-center", targets = 1:4))
))
```

## ANOVA - EDR

```{r n years attended t test average edr}
summary.edr <- aov(n.years.attended ~ edr, data = master)

summary(summary.edr)

TukeyHSD(summary.edr)
```


<br>

```{r write master, include=FALSE}
write_csv(master, "Data/SLEDS/Masters/Master-1.csv")

```