---
title: "PSEO"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
library(gmodels)
```

```{r themes and join docs, include=FALSE}
theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial"))


mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))

```

<br>

# Data prep - PSEOCourses

Let's check out the PSEO courses dataset.

<br>

```{r pseo courses original}
pseo.courses.original <- read_csv("Data/SLEDS/PSEO/PSEOCourses.csv")

head(pseo.courses.original)

names(pseo.courses.original)
```

<br>

This dataset has `r comma(pseo.courses.original %>% nrow(), accuracy = 1)` rows and `r comma(pseo.courses.original %>% ncol(), accuracy = 1)` columns. The definitions for the columns are;

* opeid: Identification code for the institution.
* InstitutionName: Name
* CourseName: Name of course
* CourseSubject: Code identifying the subject. The table is long so here's a [link](https://sleds.mn.gov/dataDictionary/4792).
* CountStudents: I guess the number of students in the course for the fiscal year?
* firstYearofData: No idea
* lastyearofdata: No idea

At this point I have no idea what this dataset is for?

# Data prep - PSEOStudent

Let's check the PSEO Student dataset.


<br>

```{r pseo student original}
pseo.student.original <- read_csv("Data/SLEDS/PSEO/PSEOStudent.csv") %>%
  mutate(PersonID = as.integer(PersonID),
         CourseGrade = as.factor(CourseGrade))

head(pseo.student.original)

names(pseo.student.original)
```

<br>

There are `r comma(pseo.student.original %>% nrow(), accuracy = 1)` rows and `r comma(pseo.student.original %>% ncol(), accuracy = 1)` columns in this dataset. The column definitions are;

* FiscalYear: School year
* TimeID: No idea
* TermYear: Year of term
* TermSeason: Fall, Spring or Summer
* OPEID: Identification of institution
* InstitutionName: Name
* GradeLevel: Grade of student when taking the course
* CourseName: Name of course taken
* CourseNoOfCredits: Number of credits if course is completed.
* CourseProgramCode: No definition given
* CourseSubject: Code of subject. Table provided [here](https://sleds.mn.gov/dataDictionary/4792)
* CourseSubjectDescription: Description of 1-24 codes
* CourseGrade: Grade given in course.

In the master dataset, I already have a column on whether a student has taken a PSEO course. Therefore, there is only two pieces of information that I want from these two datasets and that is the total credits of PSEO coursework taken by each PersonID as well as the number of courses. 

So, first I will delete any instances where the PersonID received a failing grade (F, I (incomplete), WF). Then, I will just group the dataset by PersonID, and count the number of instances a single PersonID is in the dataset which will give me the number of courses and sum up the number of credits. 

<br>

```{r pseo n courses and n credits}
pseo.n.credits.courses <- pseo.student.original %>%
  filter(!CourseGrade %in% c("F", "I", "WF")) %>%
  droplevels() %>%
  group_by(PersonID) %>%
  summarize(n.pseo.courses = n(),
            n.pseo.credits = sum(CourseNoOfCredits, na.rm = TRUE)) %>%
  ungroup()

head(pseo.n.credits.courses)

names(pseo.n.credits.courses)
```

<br>

In this dataset there are `r comma(pseo.n.credits.courses %>% nrow(), accuracy = 1)` rows and `r comma(pseo.n.credits.courses %>% ncol(), accuracy = 1)` columns. This seems kind of crazy. In the master dataset I have 13,235 students who've taken PSEO. That's about 35% of the PersonID. 

Now we can join this with the masterdata set.

<br>

