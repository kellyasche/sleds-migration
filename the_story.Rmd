---
title: "The story"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

<style type="text/css">
   .main-container {max-width: 100%;}
   .row {display: flex;}
   .column {flex: 50%;}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
library(gmodels)
library(fastDummies)
library(car)
library(glmnet)
library(glmnetUtils)
library(pscl)
library(sjPlot)
library(ggforce)
library(tigris)
library(ggsankey)
library(ggalluvial)
```

```{r join docs, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

regions <- read_csv("Data/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))

dem.desc.county <- read_csv("Data/Join docs/Master-ruca-county.csv")



color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "grey", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")


mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

us_boundary <- read_sf("Data/Shapefiles/US shapefiles/cb_2018_us_state_500k.shp", quiet = TRUE) %>%
  shift_geometry()

states.color = c("Meaningful emp SW" = "#d73027", "Meaningful emp MN" = "#fc8d59", "Attending ps" = "#fee090",  "Not meaningful, not attending ps" = "#e0f3f8", "No MN emp record, not attending ps" = "#91bfdb")

updated.states.color = c("Meaningful emp SW" = "#d73027", "Meaningful emp MN" = "#fc8d59", "Attending ps" = "#fee090",  "Not meaningful, not attending ps" = "#e0f3f8", "No MN emp record" = "#91bfdb")
```

```{r master}
original <- read_csv("Data/SLEDS/Masters/After analysis/Master-meaningful-emp-sw.csv") 

ps.grad.location <- read_csv("Data/SLEDS/Masters/Post secondary/Master-post-secondary-location.csv") %>%
  rename(ps.grad = 2,
         ps.state = 7,
         ps.county = 11,
         ps.edr = 14,
         ps.pr = 15)

master <- original %>%
  left_join(ps.grad.location[,c(1,2,7,11,14,15)], by = "PersonID") 
```

<br>

Scarcity in the workforce isn't new for Southwest Minnesota, but it's severity is increasing. Demographic changes and economic growth are all contributing to the problem. And the long-term trends don't signify any changes. 

Due to this issue, leaders are looking to invest in programs and initiatives that will help grow the workforce. There are two ways in which to do this;

1. Recruit new households into the region from other regions; and
2. Retain more people.

This research looks at the second option, and in particular, education's role in retaining young people after graduating high school. 

It's well recorded that since the 1970s, education has played a dominant role in training our workforce to meet the economic demands. However, there is also a lot of evidence showing that education has encouraged young people to leave rural areas to find greater economic opportunity. In the 1960s, 70, and 80s, this made sense due to clear advantages of working in living in metropolitan areas. But those days are gone, and the local, rural opportunities for people can match, or even exceed, those afforded in metropolitan regions. Leaders are now looking at education as a tool to grow their local, rural workforce and it's role in promoting local opportunities.

In this analysis, we examine the employment trends of individuals that have graduated from a Southwest high school. These trends are broken into 5 different employment states starting with individuals that graduated in 2008 until 2019.

1. The individual has meaningful workforce participation in Southwest Minnesota.
2. The individual has meaningful workforce participation in Minnesota, but not Southwest.
3. The individual does not have meaningful workforce participation.
4. The individual is attending post-secondary.
5. The individual does not have a Minnesota employment record and is not attending post-secondary

The time variable isn't a normal "year" type variable since we are concerned with patterns among the individuls for each year after they graduate high school. So in this case, we follow the following time pattern;

* grad.year.0 = the year individuals graduate
* grad.year.1 = one year after graduating high school
* grad.year.2 = two years after graduating.

For example, if we examining the patterns of employment states for all individuals one year after they graduate high school, there would be numerous years because some individuals graduated in 2008, therefore we are examining their employment state in 2009, versus others that graduated in 2010, in which we are examining their employment state in 2011. Both will be considered "grad.year.1".

Due to this method, the number of people we can examine will shrink as the "grad.year" increases. As an example, consider someone that graduated in 2015. Once we get to "grad.year.5", the data would have to be in 2020, but we only have data to 2019. So this individual would be eliminated from the grad.year.5 through grad.year.11 time variables.

The following chart provides the number of individuals that we are examining for each "grad.year.x". Labels are used at one year after graduation, 5 years after graduation, and 10 years after graduation due to those being the primary years at which we are assessing employment states for each individual. As the chart shows, we have nearly 35,000 individuals to assess at one year after graduation, nearly 23,000 at 5 years after graduation, and nearly 7,000 at ten years after graduation.

<br>

```{r n individuals for each grad year}
master.states <- read_csv("Data/SLEDS/Masters/States/annual-states.csv") 

five.states <- master.states %>%
  mutate(states = ifelse(county.match == "Meaningful emp - match", 1, 99),
         states = ifelse(edr.match == "Meaningful emp - match" & county.match != "Meaningful emp - match", 2, states),
         states = ifelse(region.match == "Meaningful emp - match" & county.match != "Meaningful emp - match" & edr.match != "Meaningful emp - match", 3, states),
         states = ifelse(state.match == "Meaningful emp - match" & county.match != "Meaningful emp - match" & edr.match != "Meaningful emp - match" & region.match != "Meaningful emp - match", 4, states),
         states = ifelse(state.match == "After 2019", 0, states),
         states = ifelse(ps.attend == "ps.attend" & !(states %in% c(0,1,2,3,4)), 5, states),
         states = ifelse(ps.attend == "ps.not.attend" & state.match == "MN emp record - not meaningful", 6, states),
         states = ifelse(ps.attend == "ps.not.attend" & state.match == "No MN emp record", 7, states),
         states = ifelse(states == 0, "After 2019", states),
         states = ifelse(states == "1", "Meaningful emp County", states),
         states = ifelse(states == "2", "Meaningful emp EDR", states),
         states = ifelse(states == "3", "Meaningful emp SW", states),
         states = ifelse(states == "4", "Meaningful emp MN", states),
         states = ifelse(states == "5", "Attending ps", states),
         states = ifelse(states == "6", "Not meaningful, not attending ps", states),
         states = ifelse(states == "7", "No MN emp record, not attending ps", states),
         states = as.factor(states),
         states = fct_relevel(states, "Meaningful emp County", "Meaningful emp EDR", "Meaningful emp SW", "Meaningful emp MN", "Attending ps", "Not meaningful, not attending ps", "No MN emp record, not attending ps", "After 2019"),
         five.states = ifelse(states %in% c("Meaningful emp County", "Meaningful emp EDR", "Meaningful emp SW"), "Meaningful workforce SW", as.character(states)),
         five.states = str_replace(five.states, "Not meaningful, not attending ps", "Not meaningful"),
         five.states = str_replace(five.states, "No MN emp record, not attending ps", "No MN emp record"),
         five.states = str_replace(five.states, "Meaningful emp MN", "Meaningful workforce MN"),
         five.states = as.factor(five.states),
         five.states = fct_relevel(five.states, "Meaningful workforce SW", "Meaningful workforce MN", "Attending ps", "Not meaningful", "No MN emp record", "After 2019"),
         grad.year = fct_relevel(grad.year, "grad.year.0", "grad.year.1", "grad.year.2", "grad.year.3", "grad.year.4", "grad.year.5", "grad.year.6", "grad.year.7", "grad.year.8", "grad.year.9", "grad.year.10", "grad.year.11"))

five.states.n <- five.states %>%
  filter(states != "After 2019") %>%
  group_by(grad.year) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(data_id = seq(n()))

plot <- ggplot(five.states.n, aes(grad.year, n)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Grad year: ", grad.year, "\nNumber of individuals: ", comma(n), sep = ""))) +
  geom_label(data = filter(five.states.n, grad.year %in% c("grad.year.1", "grad.year.5", "grad.year.10")), aes(label = comma(n)), show.legend = FALSE) +
  labs(x="Years after graduating high school", y = "", color="", title = "Number of individuals in each grad year", subtitle = "The following analysis assesses individuals of their state of employment at one, five, and\nten years after graduating high school\n")+
  scale_y_continuous(labels=scales::comma) +
  theme_line+
  theme(legend.position = "none",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = .9))

girafe(ggobj = plot, width_svg = 10, height_svg = 7) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_toolbar(saveaspng = FALSE),
                 opts_sizing(rescale = FALSE))


```

<br>

# Employment state trends

The current workforce shortage is not a short-term trend. Demographic shifts and economic growth are creating a scenario in which labor and jobs are moving in opposite directions - laborforce is going down while job creation is going up. 

<br>

**Chart showing this trend**

<br>

Because of this, economic development is looking to find ways to grow the labor force in sustainable ways rather than trying to find short-term solutions. In order to change these labor force trends, we need to analyze the current trends and see where there are opportunities for future labor force growth.

Therefore, this analysis is concerned with who, and who doesn't, have "meaningful workforce participation" in Southwest Minnesota. Meaningful workforce participation is defined as an individual employed for 1,000+ plus hours or more for a single employer in one calendar year. This will make sure that we are not considering summer jobs in between college semesters as "meaningful". Although important, it's not what economic developers are concerned about.

So, in order to track these trends in meaningful workforoce participation, for each grad.year.x, we are assessing each individual's "state of employment". Each individual is categorized for each grad.year.x using the following definitions;

1. **Meaningful workforce - Southwest:** The individual has worked 1,000+ hours for an employer in Southwest Minnesota over the calendar year.
2. **Meaningful workforce - Minnesota:** The individual has worked 1,000+ hours for an employer located in Minnesota, but not Southwest, over the calendar year.
3. **Attending ps:** The individual is attending post-secondary.
4. **Not meaningful:** The individual is working in Minnesota or Southwest but does not meet the "meaningful employment" criteria, and is not attending post-secondary.
5. **No MN emp record:** The individual is not working in Minnesota and is not attending post-secondary.

It's important to note that not having a MN employment record can mean a number of different scenarios. For example, any individual with a federal job position (i.e. post-office), will not have a MN employment record. In addition, individuals serving in the military, self-employed, or a stay-at-home parent would be in this group.

The following chart provides the proportion of individuals for each grad.year.x in each employment state. There are a couple of trends that are important;

1. The proportion of individuals that have meaningful workforce participation in Southwest grows quickly with 12% of individuals having meaningful employment in Southwest one year after graduating to 23% by five years after graduating. However, growth stalls out after that.
2. The proportion of individuals that have meaningful workforce participation in Minnesota but not Southwest grows slowly at first, but balloons by five year after graduating high school, which coincides with a decrease in the proportion of individuals attending post-secondary. 
3. The proportion of individuals that do not have a Minnesota employment record and are not attending post-secondary grows throughout the grad.year.x timeframe. 36% of the individuals eleven years after graduating high school do not have a MN employment record and are not attending post-secondary.

<br>

```{r prop employment state}
prop.states <- five.states %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.0", "grad.year.1", "grad.year.2", "grad.year.3", "grad.year.4", "grad.year.5", "grad.year.6", "grad.year.7", "grad.year.8", "grad.year.9", "grad.year.10", "grad.year.11")) %>%
  group_by(grad.year, five.states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  filter(five.states != "After 2019") %>%
  group_by(grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  complete(grad.year, five.states, fill = list(n = 0, pct = 0)) %>%
  mutate(data_id = seq(n()),
         grad.year = as.factor(grad.year),
         axis = as.numeric(grad.year) - 1) 

plot <- ggplot(prop.states, aes(as.numeric(grad.year)-1, pct, fill = five.states, group = five.states)) +
  geom_area() +
  geom_label(aes(x = 7, y = .85, label = "Meaningful workforce SW"), size = 5, color = "white", fill = "transparent") +
  geom_label(aes(x = 7, y = .65, label = "Meaningful workforce MN"), size = 5, color = "white", fill = "transparent") +
  geom_label(aes(x = 6, y = .47, label = "Attending ps"), size = 5, color = "black", fill = "transparent") +
  geom_label(aes(x = 7, y = .35, label = "Not meaningful"), size = 5, color = "black", fill = "transparent") +
  geom_label(aes(x = 7, y = .15, label = "No MN emp record"), size = 5, color = "black", fill = "transparent") +
  labs(x="Grad Year", y = "Proportion of individuals", color="", title = "Percent share by year(s) after graduating high school")+
  scale_y_continuous(labels=scales::percent)+
  scale_x_continuous(breaks = seq(0, 20, 2)) +
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 7, "RdYlBu"),
                    guide = guide_legend(ncol = 2)) +
  theme(legend.position = "none",
        text = element_text(size = 18))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

The goal of our analysis was to determine what factors may play a role in these proportions - are there educational or demographic variables that may increase or decrease the proportions within these employment states.

<br>

# Meaningful workforce participation in Southwest

The chart below shows the proportion of individuals for each grad year +X that had meaningful workforce participation in Southwest Minnesota. The proportion of individuals for each year after graduating high school grows significantly for the first 4 years, but than stalls out at 25%.

<br>

```{r prop meaningful emp SW}
meaningful.emp.sw.prop <- prop.states %>%
  filter(five.states == "Meaningful workforce SW")

plot <- ggplot(meaningful.emp.sw.prop, aes(x = as.numeric(grad.year) - 1, pct)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste("Grad year +X: ", grad.year, "\nEmployment state: ", five.states, "\nNumber in this employment state: ", comma(n), "\nProportion of individuals in this employment state: ", percent(pct, accuracy = .1), sep = "")), fill = "#d73027") +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9), fill = "#d73027") +
  geom_text(aes(y = pct / 2, label = paste("N = \n", comma(n), sep = "")), show.legend = FALSE) +
  labs(x="\nYears after graduating high school", y = "", color="", title = "Percent share of individuals in each year after graduating high\nschool meaningful workforce participation in Southwest Minnesota", subtitle = "The proportion grows quickly but stalls 4 years after graduation")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

## Factors

The primary factors are variables/characteristics of the individual that may lead them to more likely have meaningful employment for an employer located in Southwest Minnesota. This isn't necessarily where they live.

Analysis shows that these individuals are more likely to;

* have attained a 2-year degree or less;
* have taken more CTE courses and deeper involvement in CTE programming; and
* have not taken college prep classes and tests in high school such as the ACT.

Let's look at each of these themes in order of significance.

<br>

### Post-secondary attendance and location

Whether an individual attended a post-secondary institution, the types of institution attended, the location of the post-secondary institution, and the highest credential earned are all strongly related to whether an individual has meaningful employment in Southwest Minnesota throughout their years after graduating high school.


#### Highest credential earned

When looking at the highest credential earned, there is a significantly larger proportion of individuals with an associate degree or less of a credential with meaningful workforce participation in Southwest Minnesota. 

The highest credential earned is categorized by the following;

* No college: never attended a post-secondary institution.
* Some college: attended college but never graduated with a credential
* Less than Associate Degree: individuals that received a certificate or other credential but isn't an Associate degree or higher.
* Associate Degree: this category includes all individuals that earned only an Associate degree.
* Bachelor degree or higher: this includes all individuals that earned either a bachelor degree, masters or post-doctoral degree.

The chart below provides the number and percent of individuals that are no longer attending post-secondary by the their highest earned credential. At 5 years after graduation, the proportions are pretty evenly split with 25% earning each type of credential. By 10 years after graduation, the largest proportion of individuals have earned a Bachelor degree or higher.

<br>

```{r n credential earned}
data <- master %>%
  select(grad.year.5, grad.year.10, highest.cred.level) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  mutate(highest.cred.level = str_replace(highest.cred.level, "Bachelor degree", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Master degree or higher", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Associate degree", "Associate degree or less"),
         highest.cred.level = str_replace(highest.cred.level, "Less than Associate Degree", "Associate degree or less")) %>%
  group_by(grad.year, highest.cred.level) %>%
  summarize(n = n()) %>%
  ungroup()  %>%
  group_by(grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(highest.cred.level = fct_relevel(highest.cred.level, "No college", "Some college", "Associate degree or less", "Bachelor degree or higher"),
         data_id = seq(n()),
         grad.year = ifelse(grad.year == "grad.year.5", "5 years after hs grad", "10 years after hs grad"),
         grad.year = fct_relevel(grad.year,"5 years after hs grad", "10 years after hs grad"))

plot <- ggplot(data, aes(highest.cred.level, pct)) +
  facet_wrap(~grad.year) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste("Years after graduating high school: ", grad.year, "\nHighest credential earned: ", highest.cred.level, "\nNumber of individuals: ", comma(n), "\nPercent of individuals: ", percent(pct, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, size = 5) +
  geom_text(aes(y = pct / 2, label = paste("N = ", comma(n), sep = "")), show.legend = FALSE, color = "white") + 
  labs(x="", y = "", color="", title = "Percent of individuals no longer attending post-secondary by\nhighest credential earned")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar +
  theme(legend.position = "none",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      



```

<br>

The chart below shows the proportion of individuals that have meaningful employment in Southwest Minnesota by their highest credentials earned in post-secondary. It clearly shows that there is a significantly larger proportion of individuals that have either earned an associate degree or less. By five years after graduating high school, 39% of individuals with an associate degree or less had meaningful workforce participation in Southwest compared to only 22% for individuals with an Bachelor degree, 27% of individuals with no college, and 29% with some college but no credential. The percentages shrink ten years after graduating high school, but the proportions are still significantly higher for individuals that have an associate degree or less compared to individuals with a bachelor degree.

<br>

```{r highest credential earned and meaningful emp sw}

data <- master %>%
  select(grad.year.5, grad.year.10, highest.cred.level) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  mutate(highest.cred.level = str_replace(highest.cred.level, "Bachelor degree", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Master degree or higher", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Associate degree", "Associate degree or less"),
         highest.cred.level = str_replace(highest.cred.level, "Less than Associate Degree", "Associate degree or less")) %>%
  group_by(grad.year, highest.cred.level, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year, states) %>%
  group_by(grad.year, highest.cred.level) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = str_replace(grad.year, "grad.year.5", "5 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.10", "10 years after hs grad"),
         grad.year = fct_relevel(grad.year, "5 years after hs grad", "10 years after hs grad"),
         highest.cred.level = fct_relevel(highest.cred.level, "No college", "Some college", "Associate degree or less", "Bachelor degree or higher")) %>%
  filter(states == "Meaningful emp SW")
  
plot <- ggplot(data = data, aes(highest.cred.level, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(label = percent(prop, accuracy = .1)), show.legend = FALSE, color= "white", size = 5) +
  geom_label(aes(y = prop / 2, label = paste("N = ", comma(n), sep = "")), show.legend = FALSE) +
  geom_label(aes(x = 3.5, y = .5, label = "Significantly larger\nproportions"), fill = "white", size = 5) +
  geom_segment(data = filter(data, grad.year == "5 years after hs grad"), x = 3.5, xend = 3, y = .48, yend = .42, arrow = arrow(length = unit(.25, "cm"))) +
  geom_segment(data = filter(data, grad.year == "10 years after hs grad"), x = 3.5, xend = 3, y = .48, yend = .36, arrow = arrow(length = unit(.25, "cm"))) +
  labs(x="", y = "", title = "Proportion of individuals with meaningful workforce participation in\nSouthwest highest credential earned", subtitle = "A signifincantly larger proportion of individuals with an associate degree or less have\nmeaningful worforce participation in Southwest") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "none",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 15, hjust = 1))

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

Not only is this group have the highest proportion of individuals with meaningful workforce participation in Southwest, they are also the largest contributors. Individuals with an Associate degree or less made up 1,754 of the 5,356 individuals with meaningful workforce participation in Southwest - nearly 33%. The lowest was the group with a Bachelor degree or higher who made up 999 of the individuals with meaningful workforce participation in Southwest.

<br>

```{r highest cred earned flow}
flow.5 <- master %>%
  filter(grad.year.5 != "After 2019") %>%
  filter(grad.year.5 != "Attending ps") %>%
  mutate(highest.cred.level = str_replace(highest.cred.level, "Bachelor degree", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Master degree or higher", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Associate degree", "Associate degree or less"),
         highest.cred.level = str_replace(highest.cred.level, "Less than Associate Degree", "Associate degree or less")) %>%
    group_by(grad.year.5, highest.cred.level) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(grad.year.5 = str_replace(grad.year.5, "Meaningful emp SW", "Meaningful workforce SW"),
         grad.year.5 = str_replace(grad.year.5, "Meaningful emp MN", "Meaningful workforce MN"),
         grad.year.5 = str_replace(grad.year.5, "No MN emp record, not attending ps", "No MN emp record"),
         grad.year.5 = str_replace(grad.year.5, "Not meaningful, not attending ps", "Not meaningful workforce"),
         grad.year.5 = fct_relevel(grad.year.5, "Meaningful workforce SW", "Meaningful workforce MN", "Not meaningful workforce", "No MN emp record"),
         highest.cred.level = fct_relevel(highest.cred.level, "No college", "Some college", "Associate degree or less", "Bachelor degree or higher"))

plot <- ggplot(data = flow.5, aes(axis1 = highest.cred.level, axis2 = grad.year.5, y = n)) +
  geom_alluvium(aes(fill = grad.year.5)) +
  geom_stratum(aes(fill = grad.year.5)) +
  geom_text(stat = "stratum", 
            aes(label = paste(after_stat(stratum), "\nN = ", comma(after_stat(count)), sep = ""))) +
  geom_text(stat = "flow", aes(label = comma(n), color = grad.year.5), nudge_x = -.2) +
  labs(x="", y = "", color="", title = "Flow from highest credential earned to different states of employment", subtitle = "The largest contributor to meaningful workforce participation is from the Associate Degree\nor less group")+
  scale_y_continuous(labels=scales::comma)+
  theme_bar+
  theme_void() +
  scale_fill_manual(values = c("grey75", "#d73027", "grey75", "grey75", "grey75", "grey75")) +
  scale_color_manual(values = c("black", "grey75", "grey75", "grey75", "grey75", "grey75")) +
  theme(legend.position = "none",
        text = element_text(size = 18, family = "Calibri"),
        plot.title = element_text(face = "bold"))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))       

```

<br>

#### Type of post-secondary institution attended

Very similar to highest credentials earned, the type of institution that an individual graduated from is highly associated with whether someone is likely to have meaningful employment in Southwest Minnesota.

Individuals in the dataset were categorized by the following;

* No college: never attended a post-secondary institution.
* Some college: attended a post-secondary institution but never graduated.
* 2-year: Graduates from a public, private, or for-profit two-year post-secondary institution.
* 4-tear: Graduated from a public, private, or for-profit 4-year post-secondary institution.
* Multiple: Graduated from multiple types of post-secondary institutions.

The chart below provides the percentage of individuals in the dataset that are in each category. At 5 years after graduation, all the individuals that aren't attending post-secondary are pretty evenly split with roughly 25% in each category except 2-year colleges where only 19% graduated from. 

At 10 years after high school graduation, the proportion of individuals that are not attending post-secondary increases significantly to 33%.

<br>

```{r n grad institution sector}
data <- master %>%
  select(grad.year.5, grad.year.10, ps.grad.InstitutionSector) %>%
  mutate(ps.grad.InstitutionSector = as.factor(ps.grad.InstitutionSector),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("1", "2", "3"), "4-year", as.character(ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("4", "11"), "2-year", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector == "10", "Multiple", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("Never attended ps"), "No college", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = str_replace(new.ps.grad.InstitutionSector, "Did not grad", "Some college"),
         new.ps.grad.InstitutionSector = fct_relevel(new.ps.grad.InstitutionSector, "No college", "Some college", "2-year", "4-year", "Multiple")) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, new.ps.grad.InstitutionSector) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         grad.year = ifelse(grad.year == "grad.year.5", "5 years after hs grad", "10 years after hs grad"),
         grad.year = fct_relevel(grad.year, "5 years after hs grad", "10 years after hs grad")) 

plot <- ggplot(filter(data, new.ps.grad.InstitutionSector != "Multiple"), aes(new.ps.grad.InstitutionSector, pct)) +
  facet_wrap(~grad.year, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste("Year after graduating high school: ", grad.year, "\nGraduate of : ", new.ps.grad.InstitutionSector, "\nNumber of individuals: ", comma(n), "\nPercent of individuals: ", percent(pct, accuracy = .1), sep = ""))) +
    geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  geom_text(aes(y = pct / 2, label = paste("N = \n", comma(n))), show.legend = FALSE, color = "white") +
  labs(x="", y = "", color="", title = "Percent of individuals no longer attending post-secondary by\nthe type of institution from which they graduated", subtitle = "Attendance to 2-year colleges is significantly lower than other types\n")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

The chart below provides the proportion of individuals that graduated from each type of post-secondary institution and have meaningful employment in Southwest Minnesota. It shows that the proportion of individuals graduating from a 2-year college is significantly higher than other institution types. Nearly half of the individuals that graduate from a 2-year college have meaningful employment in Southwest Minnesota 5 years after graduating high school. This is significantly higher than the 21% of 4-year college graduates.

<br>

```{r post secondary institution type and meaningful emp sw}
meaningful.emp.sw.ps.recode <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, ps.grad.InstitutionSector) %>%
  mutate(ps.grad.InstitutionSector = as.factor(ps.grad.InstitutionSector),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("1", "2", "3"), "4-year", as.character(ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("4", "11"), "2-year", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector == "10", "Multiple", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("Never attended ps"), "No college", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = str_replace(new.ps.grad.InstitutionSector, "Did not grad", "Some college"),
         new.ps.grad.InstitutionSector = fct_relevel(new.ps.grad.InstitutionSector, "No college", "Some college", "2-year", "4-year", "Multiple"))


data <- meaningful.emp.sw.ps.recode %>%
  select(grad.year.5, grad.year.10, new.ps.grad.InstitutionSector) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, new.ps.grad.InstitutionSector, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year, new.ps.grad.InstitutionSector) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, new.ps.grad.InstitutionSector) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "Meaningful emp SW"])) / 2) + sum(prop[states != "Meaningful emp SW"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
  filter(states == "Meaningful emp SW") %>%
  mutate(grad.year = str_replace(grad.year, "grad.year.5", "5 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.10", "10 years after hs grad"),
         grad.year = fct_relevel(grad.year, "5 years after hs grad", "10 years after hs grad")) 

plot <- ggplot(data = data, aes(new.ps.grad.InstitutionSector, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(label = percent(prop, accuracy = .1)), show.legend = FALSE, size = 5, color = "white") +
  geom_label(aes(x = 3, y = .5, label = "Significantly larger\nproportion"), show.legend = FALSE, fill = "white", size = 5) +
  geom_segment(data = filter(data, grad.year == "5 years after hs grad"), x = 3, xend = 3, y = .48, yend = .43, arrow = arrow(length = unit(.25, "cm"))) +
   geom_segment(data = filter(data, grad.year == "10 years after hs grad"), x = 3, xend = 3, y = .48, yend = .39, arrow = arrow(length = unit(.25, "cm"))) +
  geom_text(aes(y = prop / 2, label = paste("N = ", comma(n), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", title = "Proportion of individuals with meaningful employment in Southwest\nby the institution sector from which they graduated", subtitle = "A significantly larger proportion of individuals graduating from a 2-year college have\nmeaningful workforce participation in Southwest\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 15, hjust = 1))

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      



```

<br>

However, although the proportion of individuals that attend a 2-year college is higher, there is the issue that overall far few individuals attend a 2-year college. Due to this, the actual number of individuals graduating from a 2-year college and having meaningful workforce participation in Southwest is close the same number of individuals from the other post-secondary graduate categories. 

The chart below shows the links between the type of institution sector from which individuals graduated and the type of "employment state" that had five years after graduating high school. Graduating from a 2-year college is the highest contributor to meaningful workforce participation in Southwest with 1,451 individuals, however it's followed closely by the categories "no college" with 1,295 and "some college" with 1,308. Graduating from a 4-year college had the lowest number of individuals with 1,062.

<br>

```{r meaningful workforce participation contribution by grad institution sector}
flow.5 <- meaningful.emp.sw.ps.recode %>%
  select(grad.year.5, new.ps.grad.InstitutionSector) %>%
  filter(grad.year.5 != "Attending ps") %>%
  filter(grad.year.5 != "After 2019") %>%
  filter(new.ps.grad.InstitutionSector != "Multiple") %>%
  group_by(grad.year.5, new.ps.grad.InstitutionSector) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(grad.year.5 = str_replace(grad.year.5, "Meaningful emp SW", "Meaningful workforce SW"),
         grad.year.5 = str_replace(grad.year.5, "Meaningful emp MN", "Meaningful workforce MN"),
         grad.year.5 = str_replace(grad.year.5, "No MN emp record, not attending ps", "No MN emp record"),
         grad.year.5 = str_replace(grad.year.5, "Not meaningful, not attending ps", "Not meaningful workforce"),
         grad.year.5 = fct_relevel(grad.year.5, "Meaningful workforce SW", "Meaningful workforce MN", "Not meaningful workforce", "No MN emp record"))

plot <- ggplot(data = flow.5, aes(axis1 = new.ps.grad.InstitutionSector, axis2 = grad.year.5, y = n)) +
  geom_alluvium(aes(fill = grad.year.5)) +
  geom_stratum(aes(fill = grad.year.5)) +
  geom_text(stat = "stratum", 
            aes(label = paste(after_stat(stratum), "\nN = ", comma(after_stat(count)), sep = ""))) +
  geom_text(stat = "flow", aes(label = comma(n), color = grad.year.5), nudge_x = -.2) +
  labs(x="", y = "", color="", title = "Flow from post-secondary institution type to different employment\nstates", subtitle = "Due to 2-year graduates being small, the contribution to meaningful workforce participation\nin Southwest isn't as large")+
  scale_y_continuous(labels=scales::comma)+
  theme_void() +
  scale_fill_manual(values = c("grey75", "#d73027", "grey75", "grey75")) +
  scale_color_manual(values = c("black", "grey75", "grey75", "grey75")) +
  theme(legend.position = "none",
        text = element_text(size = 18, family = "Calibri"),
        plot.title = element_text(face = "bold"))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  


```

<br>

#### Location of post-secondary

Not only does the type of post-secondary institution an individual graduates from have an impact on the Southwest laborforce, the location of this institution also matters. Individuals were broken into the following categories;

* Southwest MN: graduated from a post-secondary institution in Southwest Minnesota.
* MN - outside Southwest: graduated from a post-secondary institution located in Minnesota but outside of Southwest.
* Border state: graduated from a post-secondary institution located in South Dakota, North Dakota, or Iowa.
* Far, far away: graduate from a post-secondary institution located in another states besides the border states.
* Some college: attended college but did not graduate
* No college: did not attend college.

The chart below shows the distribution of Southwest graduates across these categories. A significantly lower percentage of individuals attend post-secondary within the Southwest region.

<br>

```{r n post-secondary grad location and meaningful workforce participation}
data <- master %>%
  select(grad.year.5, grad.year.10, ps.grad.InstitutionSector, ps.grad, ps.state, ps.pr) %>%
  mutate(ps.loc = ifelse(ps.pr == "Southwest", "Southwest MN", ps.pr),
         ps.loc = ifelse(!is.na(ps.pr) & ps.pr != "Southwest", "MN - outside Southwest", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Never attended ps", "No college", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Did not grad", "Some college", ps.loc),
         ps.loc = ifelse(ps.state %in% c("SD", "ND", "IA"), "Border State", ps.loc),
         ps.loc = ifelse(is.na(ps.loc), "Far far away", ps.loc)) %>%
  select(grad.year.5, grad.year.10, ps.loc) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, ps.loc) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         grad.year = ifelse(grad.year == "grad.year.5", "5 years after hs grad", "10 years after hs grad"),
         grad.year = fct_relevel(grad.year, "5 years after hs grad", "10 years after hs grad"),
         ps.loc = fct_relevel(ps.loc, "No college", "Some college", "Southwest MN", "MN - outside Southwest", "Border State", "Far far away"),
         data_id = seq(n())) 

plot <- ggplot(data, aes(ps.loc, pct)) +
  facet_wrap(~grad.year, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste("Year after graduating high school: ", grad.year, "\nGraduate of : ", ps.loc, "\nNumber of individuals: ", comma(n), "\nPercent of individuals: ", percent(pct, accuracy = .1), sep = ""))) +
    geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  geom_text(aes(y = pct / 2, label = paste("N = \n", comma(n))), show.legend = FALSE, color = "white") +
  labs(x="", y = "", color="", title = "Percent share of individuals with meaningful employment  all individuals by post-secondary institution from\nwhich they graduated", subtitle = "The largest share of college graduates comes from outside Southwest institutions\n")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  


```
<br>

The chart below provides the proportion of individuals in each type of post-secondary location category. It shows a significantly higher proportion of individuals who graduated from a post-secondary institution located within Southwest Minnesota have meaningful workforce participation in Southwest Minnesota - 43% at 5 years after graduation and 39% at 10 years after graduation.

<br>

```{r post secondary location and meaningful workforce participation}
data <- master %>%
  select(grad.year.5, grad.year.10, ps.grad.InstitutionSector, ps.grad, ps.state, ps.pr) %>%
  mutate(ps.loc = ifelse(ps.pr == "Southwest", "Southwest MN", ps.pr),
         ps.loc = ifelse(!is.na(ps.pr) & ps.pr != "Southwest", "MN - outside Southwest", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Never attended ps", "No college", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Did not grad", "Some college", ps.loc),
         ps.loc = ifelse(ps.state %in% c("SD", "ND", "IA"), "Border State", ps.loc),
         ps.loc = ifelse(is.na(ps.loc), "Far far away", ps.loc)) %>%
  select(grad.year.5, grad.year.10, ps.loc) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, ps.loc, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year, ps.loc) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, ps.loc) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "Meaningful emp SW"])) / 2) + sum(prop[states != "Meaningful emp SW"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
  filter(states == "Meaningful emp SW") %>%
  mutate(grad.year = str_replace(grad.year, "grad.year.5", "5 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.10", "10 years after hs grad"),
         grad.year = fct_relevel(grad.year, "5 years after hs grad", "10 years after hs grad"),
         ps.loc = fct_relevel(ps.loc, "No college", "Some college", "Southwest MN", "MN - outside Southwest", "Border State", "Far far away"),
         data_id = seq(n())) 

plot <- ggplot(data = data, aes(ps.loc, prop, fill = states)) +
  facet_wrap(~grad.year, scales = "free_y") +
  geom_bar_interactive(stat = "identity", aes(data_id = data_id, tooltip = paste("Years after graduating hs: ", grad.year, "\nType of college graduated from: ", ps.loc, "\nNumber of individuals: ", comma(n), "\nPercent of individuals: ", percent(prop, accuracy = .1), sep = ""))) +
    geom_label(aes(label = percent(prop, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  geom_label(aes(x = 5, y = .4, label = "Significantly\nlarger proportion"), fill = "white") +
  geom_segment(x = 5, xend = 3.6, y = .38, yend = .35, arrow = arrow(length = unit(.25, "cm"))) +
  geom_text(aes(y = prop / 2, label = paste("N =\n", comma(n), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", title = "Proportion of individuals with meaningful workforce participation in\nSouthwest by the institution sector from which they graduated", subtitle = "A significantly larger proportion of individuals graduating from a 2-year college have\nmeaningful workforce participation in Southwest\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

However, as we've seen, a majority of individuals that graduate from a Southwest MN high school do not graduate from a post-secondary institution in Southwest Minnesota. A majority either don't attend, never graduate, or go to an institution located outside of the Southwest region. Due to this disparity, the number of individuals with meaningful workforce participation in Southwest Minnesota is larger in those categories versus the institutions that are inside Southwest Minnesota.

<br>

```{r post secondary location contribution}
flow <- master %>%
  select(grad.year.5, grad.year.10, ps.grad.InstitutionSector, ps.grad, ps.state, ps.pr) %>%
  mutate(ps.loc = ifelse(ps.pr == "Southwest", "Southwest MN", ps.pr),
         ps.loc = ifelse(!is.na(ps.pr) & ps.pr != "Southwest", "MN - outside Southwest", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Never attended ps", "No college", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Did not grad", "Some college", ps.loc),
         ps.loc = ifelse(ps.state %in% c("SD", "ND", "IA"), "Border State", ps.loc),
         ps.loc = ifelse(is.na(ps.loc), "Far far away", ps.loc)) %>%
  select(grad.year.5, ps.loc) %>%
  filter(grad.year.5 != "Attending ps") %>%
  filter(grad.year.5 != "After 2019") %>%
  filter(ps.loc != "Multiple") %>%
  group_by(grad.year.5, ps.loc) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(grad.year.5 = str_replace(grad.year.5, "Meaningful emp SW", "Meaningful workforce SW"),
         grad.year.5 = str_replace(grad.year.5, "Meaningful emp MN", "Meaningful workforce MN"),
         grad.year.5 = str_replace(grad.year.5, "No MN emp record, not attending ps", "No MN emp record"),
         grad.year.5 = str_replace(grad.year.5, "Not meaningful, not attending ps", "Not meaningful workforce"),
         grad.year.5 = fct_relevel(grad.year.5, "Meaningful workforce SW", "Meaningful workforce MN", "Not meaningful workforce", "No MN emp record"),
         ps.loc = fct_relevel(ps.loc, "No college", "Some college", "Southwest MN", "MN - outside Southwest", "Border State", "Far far away"))

plot <- ggplot(data = flow, aes(axis1 = ps.loc, axis2 = grad.year.5, y = n)) +
  geom_alluvium(aes(fill = grad.year.5)) +
  geom_stratum(aes(fill = grad.year.5)) +
  geom_text(stat = "stratum", 
            aes(label = paste(after_stat(stratum), "\nN = ", comma(after_stat(count)), sep = ""))) +
  geom_text(stat = "flow", aes(label = comma(n), color = grad.year.5), nudge_x = -.2) +
  labs(x="", y = "", color="", title = "Flow of post secondary grad location by workforce participation", subtitle = "The largest contributor to meaningful workforce participation in Southwest never\ngraduated from college") +
  scale_y_continuous(labels=scales::comma)+
  theme_bar+
  theme_void() +
  scale_fill_manual(values = c("grey75", "#d73027", "grey75", "grey75")) +
  scale_color_manual(values = c("black", "grey75", "grey75", "grey75")) +
  theme(legend.position = "none",
        text = element_text(size = 18))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  


```

<br>

Previously we showed that there was significant difference between 2-year and 4-year grads and their proportion that had meaningful workforce participation in Southwest Minnesota. The chart below provides that breakdown with further refinement - differences in 2-year and 4-year in Southwest Minnesota. So the categories are;

* No college: individuals that did not attend a post-secondary institution
* Some college: individuals that attended but never graduated
* 2-yr, Southwest: individuals that graduated from a 2-year college in the southwest region.
* 4-yr, Southwest: individuals that graduated from a 4-year college in the southwest fegion.
* MN, outside Southwest: individuals that graduated from a college in Minnesota but outside of southwest.
* Outside MN: individuals that graduated from a college outside of Minnesota.

The chart below shows that a significantly higher proportion of individuals that graduated from a 2-year college in Southwest had meaningful workforce participation in the region. Nearly 50% of those individuals. The proportion of graduates from a 4-year college in Southwest was also significantly high, with a third or more having meaningful workforce participation in the region. 

<br>

```{r proportion post secondary location deeper and meaningful workforce participation}
data <- master %>%
  select(grad.year.5, grad.year.10, ps.grad.InstitutionSector, ps.grad, ps.state, ps.pr) %>%
  mutate(ps.loc = ifelse(ps.pr == "Southwest" & ps.grad.InstitutionSector %in% c("4", "11"), "2-yr, SW", ps.pr),
         ps.loc = ifelse(ps.pr == "Southwest" & ps.grad.InstitutionSector %in% c(1,2,3), "4-yr, SW", ps.loc),
         ps.loc = ifelse(ps.state != "MN", "Out of state", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Did not grad", "Some college", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Never attended ps", "No college", ps.loc),
         ps.loc = ifelse(ps.loc %in% c("Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southeast"), "MN, outside SW", ps.loc)) %>%
  filter(ps.grad.InstitutionSector != 10) %>%
  select(grad.year.5, grad.year.10, ps.loc) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, ps.loc, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year, ps.loc) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, ps.loc) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "Meaningful emp SW"])) / 2) + sum(prop[states != "Meaningful emp SW"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
  filter(states == "Meaningful emp SW") %>%
  mutate(grad.year = str_replace(grad.year, "grad.year.5", "5 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.10", "10 years after hs grad"),
         grad.year = fct_relevel(grad.year, "5 years after hs grad", "10 years after hs grad"),
         ps.loc = fct_relevel(ps.loc, "No college", "Some college", "2-yr, SW", "4-yr, SW", "MN, outside SW", "Out of state"),
         data_id = seq(n())) 

plot <- ggplot(data = data, aes(ps.loc, prop, fill = states)) +
  facet_wrap(~grad.year, scales = "free_y") +
  geom_bar_interactive(stat = "identity", aes(data_id = data_id, tooltip = paste("Years after graduating hs: ", grad.year, "\nType of college graduated from: ", ps.loc, "\nNumber of individuals: ", comma(n), "\nPercent of individuals: ", percent(prop, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(prop, accuracy = 1)), show.legend = FALSE, color = "white") +
  geom_label(aes(x = 5, y = .45, label = "Significantly higher\nproportion"), fill = "white") +
  geom_segment(x = 5, xend = 3.5, y = .43, yend = .41, arrow = arrow(length = unit(.25, "cm"))) +
  geom_segment(data = filter(data, grad.year == "5 years after hs grad"), x = 5, xend = 4, y = .43, yend = .38, arrow = arrow(length = unit(.25, "cm"))) +
  geom_segment(data = filter(data, grad.year == "10 years after hs grad"), x = 5, xend = 4, y = .43, yend = .34, arrow = arrow(length = unit(.25, "cm"))) +
  geom_text(aes(y = .1, label = ps.loc), angle = 90, color = "white", size = 5) +
  labs(x="", y = "", title = "Proportion of individuals with meaningful employment in Southwest\nby the institution sector from which they graduated", subtitle = "A significantly larger proportion of individuals graduating from a Southwest college have\nmeaningful workforce participation in Southwest\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "none",
        text = element_text(size = 18),
        axis.text.x = element_blank())

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>


### CTE Courses and Programming

It's no secret that career and technical education in high schools has received significantly more attention, and subsequently more investment and resources. It's always been believed that these investments lead to better outcomes in student retainment for rural regions. The analysis shows that this does seem to be true. Throughout the analysis, career and technical education courses and programming had one of the strongest relationships in whether an individual had meaningful employment somewhere in Southwest vs. other employment outcomes.

Below is the distribution of the number of CTE courses taken by individuals after removing a few outliers in the dataset. It shows that a largest majority of individuals have taken 5 CTE courses or less.

<br>

```{r cte courses taken distribution}
data <- master %>%
  select(PersonID, grad.year.1, total.cte.courses.taken) %>%
  filter(grad.year.1 != "After 2019") %>%
  drop_na() %>%
  mutate(q1 = quantile(total.cte.courses.taken, .25),
         q3 = quantile(total.cte.courses.taken, .75),
         iqr = IQR(total.cte.courses.taken),
         low.outlier = q1 - 1.5*iqr,
         high.outlier = q3 + 1.5*iqr) %>%
  filter(total.cte.courses.taken > low.outlier,
         total.cte.courses.taken < high.outlier) 

plot <- ggplot(data, aes(total.cte.courses.taken)) +
  geom_histogram(bins = 17) +
  labs(x="", y = "", color="", title = "Distribution of CTE courses taken by individuals")+
  scale_y_continuous(labels=scales::comma)+
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu")) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

The chart below compares the total number of courses taken with each state of employment for all individuals that graduated from a high school in Southwest. For those not familiar with boxplots, the bottom side of the box is the 25th percentile of CTE courses taken in that employment state, the middle line is the median and the top line is the 75th percentile. What this chart tells us is that the 25th, median, mean, and 75th percentile of the number of CTE courses taken by individuals who have meaningful employment in Southwest are significantly higher than the number taken by individuals in the other states of employment.

<br>

```{r cte and meaningful workforce participation in SW}
data <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, total.cte.courses.taken) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:3) %>%
  select(grad.year, states, total.cte.courses.taken) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  drop_na() %>%
  group_by(grad.year, states) %>%
  mutate(q1 = quantile(total.cte.courses.taken, .25),
         q3 = quantile(total.cte.courses.taken, .75),
         iqr = IQR(total.cte.courses.taken),
         low.outlier = q1 - 1.5*iqr,
         high.outlier = q3 + 1.5*iqr) %>%
  filter(total.cte.courses.taken > low.outlier,
         total.cte.courses.taken < high.outlier) %>%
  ungroup() %>%
  mutate(grad.year = str_replace(grad.year, "grad.year.5", "5 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.10", "10 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.1", "1 year after hs grad"),
         grad.year = fct_relevel(grad.year, "1 year after hs grad", "5 years after hs grad", "10 years after hs grad"),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps")) 

labels <- data %>%
  group_by(grad.year, states) %>%
  summarize(Min = quantile(total.cte.courses.taken, .0),
            Q1 = quantile(total.cte.courses.taken, .25),
            Median = median(total.cte.courses.taken),
            Q3 = quantile(total.cte.courses.taken, .75),
            Max = quantile(total.cte.courses.taken, 1),
            Mean = mean(total.cte.courses.taken)) %>%
  ungroup()

plot <- ggplot(data, aes(grad.year, total.cte.courses.taken, fill = states)) +
  geom_boxplot(position = position_dodge(width = .7)) +
  stat_summary(fun.y = "mean", geom = "point", color = "#1a9850", position = position_dodge(width = .7), size = 3, label = mean, show.legend = FALSE) +
  annotate(geom = "label",
           x = 2,
           y = 25, 
           label = "Higher 25th percentile\n75th percentile,\nmean and median",
           size = 5) +
 annotate(geom = "segment",
          x = 2, 
          xend = .8, 
          y = 23, 
          yend = 11, 
          arrow = arrow(length = unit(.25, "cm"))) +
  annotate(geom = "segment",
           x = 2, 
           xend = 1.7, 
           y = 23, 
           yend = 10, 
           arrow = arrow(length = unit(.25, "cm"))) +
    annotate(geom = "segment",
           x = 2, 
           xend = 2.7, 
           y = 23, 
           yend = 9, 
           arrow = arrow(length = unit(.25, "cm"))) +
  labs(x="", y = "", color="", title = "Boxplots of number of CTE courses taken by state", subtitle = "Meaningful employment in Southwest typically associated with higher number of CTE\ncourses taken")+
  scale_y_continuous(labels=scales::comma,
                     limits = c(0, 30))+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

Analysis also showed that the proportion of individuals who were CTE completors or concentrators had meaningful employment in Southwest.

Below is the chart showing the distribution by CTE achievement.

<br>

```{r cte achievement n}
data <- master %>%
  select(cte.achievement) %>%
  group_by(cte.achievement) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(pct = n / sum(n),
         data_id = seq(n()))

plot <- ggplot(data, aes(cte.achievement, pct)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("CTE Achievement: ", cte.achievement, "\nNumber of individuals: ", comma(n), "\nPercent of individuals: ", percent(pct, accuracy = 1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = 1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  geom_text(aes(y = pct / 2, label = paste("N = ", comma(n), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Percent of individuals by CTE achievement", subtitle = "Nearly 50% of the individuals were CTE completors or concentrators\n")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

The chart below provides the proportion of CTE completors/concentrators, CTE participants (but not completors or concentrators), and the group of individuals that did not take any CTE courses, that had meaningful employment in Southwest one year after graduation, five years after graduation, and ten years after graduation. It shows that the proportion of individuals who were completors or concentrators was significantly higher than the proportion of individuals who had taken no CTE courses. 

<br>

```{r cte achievement and meaningful workforce participation in SW}
data <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, cte.achievement) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:3) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, cte.achievement, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year, cte.achievement) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.1", "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, cte.achievement) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "Meaningful emp SW"])) / 2) + sum(prop[states != "Meaningful emp SW"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
    mutate(grad.year = str_replace(grad.year, "grad.year.10", "10 years after grad"),
           grad.year = str_replace(grad.year, "grad.year.5", "5 years after grad"),
         grad.year = str_replace(grad.year, "grad.year.1", "1 year after grad"),
         grad.year = fct_relevel(grad.year, "1 year after grad", "5 years after grad", "10 years after grad"),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps")) %>%
  filter(states == "Meaningful emp SW") %>%
  mutate(cte.achievement = fct_relevel(cte.achievement, "No CTE", "CTE Participant", "CTE Concentrator or Completor"))

plot <- ggplot(data = data, aes(cte.achievement, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(y = prop / 2, label = paste(percent(prop, accuracy = 1), "\nN = ", comma(n), sep = "")), show.legend = FALSE, color = "white") +
  geom_hline(yintercept = 0, color = "black") +
  geom_text(data = filter(data, cte.achievement == "CTE Concentrator or Completor"), aes(x = 2.75, y = .17, label = "Significantly higher\nproportion"), show.legend = FALSE) +
  labs(x="", y = "", title = "Proportion of CTE Achievement that have meaningful workforce\nparticipation in Southwest", subtitle = "CTE achievement is associated with higher levels of meaningful employment in\nSouthwest") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18)) +
  coord_flip()


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

Obviously, taking CTE courses may lead to different paths after high school that result in meaningful workforce participation in Southwest. In fact, analysis highlighted how CTE may impact an individual's path post-high school, which subsequently impacts whether they have meaningful workforce participation in Southwest. 

It was highlighted in the previous section that there was a larger proportion of individuals with meaningful workforce participation with the following post-secondary path;

* Had Associated degree or less
* Attended a 2-yr college, and 
* Attended college in Southwest.

And there was a higher proportion of individuals that were CTE concentrators or completors that followed these post-high school paths.

The chart below provides the proportion of individuals in each CTE achievement category that followed these three post-high school paths. It shows that nearly 30% of CTE concentrators or completors attained an associate degree or less compared to 21% of CTE participants and 15% of individuals with no CTE. 

24% of individuals that were CTE concentrators or completors graduated from a 2-year college while only 18% of CTE participants and 12% without any CTE experience. 

Finally, 12% of CTE concentrators, completors or participants graduated from a Southwest college compared to 10% of individuals with no CTE experience.

<br>

```{r cte achievement higher by ps path}
data <- master %>%
  filter(grad.year.5 != "Attending ps") %>%
  filter(grad.year.5 != "After 2019") %>%
  mutate(highest.cred.level = str_replace(highest.cred.level, "Bachelor degree", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Master degree or higher", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Associate degree", "Associate degree or less"),
         highest.cred.level = str_replace(highest.cred.level, "Less than Associate Degree", "Associate degree or less")) %>%
  mutate(ps.loc = ifelse(ps.pr == "Southwest", "Southwest", ps.pr),
         ps.loc = ifelse(ps.pr != "Southwest" & ps.state == "MN", "MN, outside SW", ps.loc),
         ps.loc = ifelse(ps.state %in% c("SD", "ND", "IA"), "Border state", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Never attended ps", "No college", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Did not grad", "Some college", ps.loc),
         ps.loc = ifelse(!ps.state %in% c("MN", "SD", "ND", "IA") & !is.na(ps.state), "Far far away", ps.loc)) %>%
  mutate(ps.grad.InstitutionSector = as.factor(ps.grad.InstitutionSector),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("1", "2", "3"), "4-year", as.character(ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("4", "11"), "2-year", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector == "10", "Multiple", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("Never attended ps"), "No college", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = str_replace(new.ps.grad.InstitutionSector, "Did not grad", "Some college")) %>%
  filter(new.ps.grad.InstitutionSector != "Multiple") %>%
  mutate(new.ps.grad.InstitutionSector = fct_relevel(new.ps.grad.InstitutionSector, "No college", "Some college", "2-year", "4-year", "Multiple")) %>%
  select(cte.achievement, highest.cred.level, new.ps.grad.InstitutionSector, ps.loc) %>%
  pivot_longer(names_to = "ps.path", values_to = "Category", 2:4) %>%
  group_by(cte.achievement, ps.path, Category) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(cte.achievement, ps.path) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  filter(Category %in% c("Associate degree or less", "2-year", "Southwest")) %>%
  mutate(Category = str_replace(Category, "2-year", "Grad from 2-year college"),
         Category = str_replace(Category, "Southwest", "Grad from SW college")) %>%
  mutate(data_id = seq(n()),
         Category = fct_relevel(Category, "Associate degree or less", "Grad from 2-year college", "Grad from SW college"))

plot <- ggplot(data = data, aes(Category, pct, fill = cte.achievement, group = cte.achievement)) +
  geom_col_interactive(position = "dodge") +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  geom_text(aes(y = pct / 2, label = paste("N = ", comma(n))), show.legend = FALSE, position = position_dodge(width = .9)) +
  geom_label(aes(x = 2, y = .3, label = "Significantly larger\nproportion"), show.legend = FALSE, fill = "white", size = 5) +
  geom_segment(x = 2, xend = .9, y = .285, yend = .24, arrow = arrow(length = unit(.25, "cm"))) +
   geom_segment(x = 2, xend = 1.8, y = .285, yend = .25, arrow = arrow(length = unit(.25, "cm"))) +
  geom_segment(x = 2, xend = 2.8, y = .285, yend = .13, arrow = arrow(length = unit(.25, "cm"))) +
  labs(x="", y = "", color="", title = "Percent share of CTE achievement by highest credential earned by\n5 years after graduating high school") +
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  
  

```

<br>

Just as important are the post high school paths that had significantly lower proportions of individuals with meanigful workforce participation in Southwest. These paths were;

* individuals that attained a bachelor degree or higher
* individuals that graduated from a 4-year college, and
* individuals that did not graduate from a college in SW.

And analysis shows that a significantly lower proportion of individuals that were CTE concentrators or completors nearly follows these patterns.

The chart below provides the proportion of individuals that graduated from different college types by their CTE achievement. It shows that a lower proportion of individuals with CTE experience attain a bachelor degree or higher, graduate from a 4-year college, graduate from a border state, or graduate from college that isn't in MN or a border state. However, there isn't much difference between CTE experience and whether they attend a college in Minnesota, but outside of Southwest.

<br>


```{r cte achievement lesser by ps path}
data <- master %>%
  filter(grad.year.5 != "Attending ps") %>%
  filter(grad.year.5 != "After 2019") %>%
  mutate(highest.cred.level = str_replace(highest.cred.level, "Bachelor degree", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Master degree or higher", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Associate degree", "Associate degree or less"),
         highest.cred.level = str_replace(highest.cred.level, "Less than Associate Degree", "Associate degree or less")) %>%
  mutate(ps.loc = ifelse(ps.pr == "Southwest", "Southwest", ps.pr),
         ps.loc = ifelse(ps.pr != "Southwest" & ps.state == "MN", "MN, outside SW", ps.loc),
         ps.loc = ifelse(ps.state %in% c("SD", "ND", "IA"), "Border state", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Never attended ps", "No college", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Did not grad", "Some college", ps.loc),
         ps.loc = ifelse(!ps.state %in% c("MN", "SD", "ND", "IA") & !is.na(ps.state), "Far far away", ps.loc)) %>%
  mutate(ps.grad.InstitutionSector = as.factor(ps.grad.InstitutionSector),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("1", "2", "3"), "4-year", as.character(ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("4", "11"), "2-year", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector == "10", "Multiple", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("Never attended ps"), "No college", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = str_replace(new.ps.grad.InstitutionSector, "Did not grad", "Some college")) %>%
  filter(new.ps.grad.InstitutionSector != "Multiple") %>%
  mutate(new.ps.grad.InstitutionSector = fct_relevel(new.ps.grad.InstitutionSector, "No college", "Some college", "2-year", "4-year", "Multiple")) %>%
  select(cte.achievement, highest.cred.level, new.ps.grad.InstitutionSector, ps.loc) %>%
  pivot_longer(names_to = "ps.path", values_to = "Category", 2:4) %>%
  group_by(cte.achievement, ps.path, Category) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(cte.achievement, ps.path) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  filter(Category %in% c("Bachelor degree or higher", "4-year", "MN, outside SW", "Border state", "Far far away")) %>%
  mutate(Category = str_replace(Category, "4-year", "Grad from 4-year college"),
         Category = str_replace(Category, "MN, outside SW", "Grad from MN but not SW college"),
         Category = str_replace(Category, "Border state", "Grad from SD, ND or IA"),
         Category = str_replace(Category, "Far far away", "Grad from another state and not border")) %>%
  mutate(data_id = seq(n()),
         Category = fct_relevel(Category, "Bachelor degree or higher", "Grad from 4-year college", "Grad from SD, ND or IA", "Grad from another state and not border", "Grad from MN but not SW college"))

plot <- ggplot(data = data, aes(Category, pct, fill = cte.achievement, group = cte.achievement)) +
  geom_col_interactive(position = "dodge") +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  geom_label(aes(x = .84, y = .15, label = "Significantly\nlower\nproportion"), show.legend = FALSE, fill = "transparent", color = "white") +
  geom_label(aes(x = 1.84, y = .15, label = "Significantly\nlower\nproportion"), show.legend = FALSE, fill = "transparent", color = "white") +
  geom_label(aes(x = 2.84, y = .05, label = "Somewhat\nlower\nproportion"), show.legend = FALSE, fill = "transparent", color = "white") +
  geom_label(aes(x = 4, y = .15, label = "Significantly lower\nproportion"), show.legend = FALSE, fill = "white") +
  geom_segment(x = 4, xend = 3.85, y = .14, yend = .035, arrow = arrow(length = unit(.25, "cm"))) +
  geom_label(aes(x = 4.84, y = .1, label = "Not much\ndifference"), show.legend = FALSE, fill = "transparent", color = "white") +
  labs(x="", y = "", color="", title = "Percent share of CTE achievement by highest credential earned by\n5 years after graduating high school") +
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  
  

```
<br>

### Taking the ACT

Since the post-secondary pathway has an influence on whether an individual has meaningful workforce participation in Southwest, it's not surprising that whether an individual is preparing to go to college in high school also plays a role.

First, let's look at how many students take the ACT. Two-thirds of the individuals took the ACT in high school.

<br>

```{r act n}
data <- master %>%
  select(took.ACT) %>%
  group_by(took.ACT) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(pct = n / sum(n),
         data_id = seq(n()))

plot <- ggplot(data, aes(took.ACT, pct)) +
  geom_col_interactive(aes(data_id = data_id, tooltip = paste("Took ACT?: ", took.ACT, "\nNumber of individuals: ", comma(n), "\nPercent of individuals: ", percent(pct, accuracy = 1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = 1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  geom_text(aes(y = pct / 2, label = paste("N = ", comma(n), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Percent of individuals by whether they took the ACT", subtitle = "Two-thirds of the individuals took the ACT\n")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  

```

<br>

The chart below shows that nearly a third of individuals who did not take the ACT had meaningful workforce participation in southwest at five and ten years after graduating high school.

<br>

```{r took act and meaningful workforce participation in SW}
data <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, took.ACT) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:3) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, took.ACT, states) %>%
  summarize(n = n()) %>%
  ungroup()  %>%
  group_by(grad.year, took.ACT) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.1", "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, took.ACT) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "Meaningful emp SW"])) / 2) + sum(prop[states != "Meaningful emp SW"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
    mutate(grad.year = str_replace(grad.year, "grad.year.10", "10 years after grad"),
           grad.year = str_replace(grad.year, "grad.year.5", "5 years after grad"),
         grad.year = str_replace(grad.year, "grad.year.1", "1 year after grad"),
         grad.year = fct_relevel(grad.year, "1 year after grad", "5 years after grad", "10 years after grad"),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps")) %>%
  filter(states == "Meaningful emp SW") %>%
    filter(grad.year != "1 year after grad") %>%
  mutate(took.ACT = ifelse(took.ACT == "No", "Did not\ntake ACT", "Took ACT"))
  
plot <- ggplot(data = data, aes(took.ACT, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(y = prop / 2, label = paste(percent(prop, accuracy = 1), "\nN = ", comma(n), sep = "")), show.legend = FALSE, color = "white") +
  geom_label(aes(x = 1, y = .1, label = "Significantly\nhigher\nproportion"), show.legend = FALSE, color = "white") +
  geom_hline(yintercept = 0, color = "black") +
  labs(x="", y = "", title = "Proportion of individuals who did and did not take ACT that have\nmeaningful workforce participation in Southwest", subtitle = "Not taking the ACT was associated with higher proportions of individuals having\nmeaningful workforce participation in Southwest\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18)) 

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

this result isn't surprising given that taking the ACT is a signal that the individual is exploring the possibility of attending college. in particular, taking the ACT is associated with higher proportion of individuals following post-high school paths with signifiacntly lower levels of meaningful workforce participation in Southwest.

The chart below shows that there were significantly high proportion of individuals who;

* attained a bachelor degree or higher,
* graduated from a 4-year college,
* graduated from a border state,
* graduated from a college outside of Minnesota and border states, and,
* graduated from a college in MN, but not Southwest.

Each of these pathways lead to lower percentages of individuals having meaningful workforce participation in Southwest.

<br>

```{r took ACT lesser by ps path}
data <- master %>%
  filter(grad.year.5 != "Attending ps") %>%
  filter(grad.year.5 != "After 2019") %>%
  mutate(highest.cred.level = str_replace(highest.cred.level, "Bachelor degree", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Master degree or higher", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Associate degree", "Associate degree or less"),
         highest.cred.level = str_replace(highest.cred.level, "Less than Associate Degree", "Associate degree or less")) %>%
  mutate(ps.loc = ifelse(ps.pr == "Southwest", "Southwest", ps.pr),
         ps.loc = ifelse(ps.pr != "Southwest" & ps.state == "MN", "MN, outside SW", ps.loc),
         ps.loc = ifelse(ps.state %in% c("SD", "ND", "IA"), "Border state", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Never attended ps", "No college", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Did not grad", "Some college", ps.loc),
         ps.loc = ifelse(!ps.state %in% c("MN", "SD", "ND", "IA") & !is.na(ps.state), "Far far away", ps.loc)) %>%
  mutate(ps.grad.InstitutionSector = as.factor(ps.grad.InstitutionSector),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("1", "2", "3"), "4-year", as.character(ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("4", "11"), "2-year", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector == "10", "Multiple", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("Never attended ps"), "No college", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = str_replace(new.ps.grad.InstitutionSector, "Did not grad", "Some college")) %>%
  filter(new.ps.grad.InstitutionSector != "Multiple") %>%
  mutate(new.ps.grad.InstitutionSector = fct_relevel(new.ps.grad.InstitutionSector, "No college", "Some college", "2-year", "4-year", "Multiple")) %>%
  select(took.ACT, highest.cred.level, new.ps.grad.InstitutionSector, ps.loc) %>%
  pivot_longer(names_to = "ps.path", values_to = "Category", 2:4) %>%
  group_by(took.ACT, ps.path, Category) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(took.ACT, ps.path) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  filter(Category %in% c("Bachelor degree or higher", "4-year", "MN, outside SW", "Border state", "Far far away")) %>%
  mutate(Category = str_replace(Category, "4-year", "Grad from 4-year college"),
         Category = str_replace(Category, "MN, outside SW", "Grad from MN but not SW college"),
         Category = str_replace(Category, "Border state", "Grad from SD, ND or IA"),
         Category = str_replace(Category, "Far far away", "Grad from another state and not border")) %>%
  mutate(data_id = seq(n()),
         Category = fct_relevel(Category, "Bachelor degree or higher", "Grad from 4-year college", "Grad from SD, ND or IA", "Grad from another state and not border", "Grad from MN but not SW college"))

plot <- ggplot(data = data, aes(Category, pct, fill = took.ACT, group = took.ACT)) +
  geom_col_interactive(position = "dodge") +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Percent share of CTE achievement by highest credential earned by\n5 years after graduating high school") +
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  
  

```

<br>

### MCA scores

Another factor that came up consistently in relation to whether an individual had meaningful workforce participation was MCA scores. Analysis showed that the higher the scores, the more likely they didn't have meaningful workforce participation in Southwest.

First, let's take a look at the distribution of scores for each test. The MCA Math test has the most even distribution with about a quarter of the students in receiving each score. The highest percentage of 4 scores are in MCA reading, while the lowest percentage is in science.

<br>

```{r mca score distribution}
data <- master %>%
  select(PersonID, grad.year.1, MCA.R, MCA.M, MCA.S) %>%
  filter(grad.year.1 != "After 2019") %>%
  drop_na() %>%
  pivot_longer(names_to = "MCA.test", values_to = "MCA.score", 3:5) %>%
  group_by(MCA.test, MCA.score) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(MCA.test) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup()

plot <- ggplot(data, aes(x = MCA.test, y = pct, fill = as.factor(MCA.score), group = MCA.score)) +
    geom_col(position = "dodge") +
    geom_label(aes(label = percent(pct, accuracy = 1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  labs(x="\nMCA Test Score", y = "", color="", title = "Test scores for MCA tests") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = brewer.pal(n = 5, "PuBu")) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      



```

<br>

#### {.unnumbered .unlisted .toc-ignore .tabset}

Analysis shows that the proportion of individuals within each test score varied significantly in whether they had meaningful workforce participation in Southwest.

For all subjects, there is consistently a higher proportion of individuals with meaningful workforce participation that also had lower test scores (typically a score of 1 or 2). Across all the grad years, typically a third or more of individuals that had a test score of 1 or 2 had meaningful workforce participation in Southwest one, five, and ten years after high school.

<br>

##### MCA - Reading

```{r mca  reading scores and meaningful workforce participatin in SW}
data <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, MCA.R) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:3) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, MCA.R, states) %>%
  summarize(n = n()) %>%
  ungroup()  %>%
  group_by(grad.year, MCA.R) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.1", "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, MCA.R) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "Meaningful emp SW"])) / 2) + sum(prop[states != "Meaningful emp SW"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
    mutate(grad.year = str_replace(grad.year, "grad.year.10", "10 years after grad"),
           grad.year = str_replace(grad.year, "grad.year.5", "5 years after grad"),
         grad.year = str_replace(grad.year, "grad.year.1", "1 year after grad"),
         grad.year = fct_relevel(grad.year, "1 year after grad", "5 years after grad", "10 years after grad"),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps")) %>%
  filter(states == "Meaningful emp SW") 
  
plot <- ggplot(data = data, aes(MCA.R, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(label = percent(prop, accuracy = 1)), show.legend = FALSE, color = "white") +
  geom_hline(yintercept = 0, color = "black") +
  labs(x="", y = "", title = "Proportion of individuals within each MCA - reading test score that\nhave meaningful workforce participation in Southwest", subtitle = "A higher proportion of individuals with lower test scores have meaningful workforce\nparticipation in Southwest\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18)) 

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  
```

<br>

##### MCA - Match

```{r mca math scores and meaningful workforce participatin in SW}
data <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, MCA.M) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:3) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, MCA.M, states) %>%
  summarize(n = n()) %>%
  ungroup()  %>%
  group_by(grad.year, MCA.M) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.1", "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, MCA.M) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "Meaningful emp SW"])) / 2) + sum(prop[states != "Meaningful emp SW"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
    mutate(grad.year = str_replace(grad.year, "grad.year.10", "10 years after grad"),
           grad.year = str_replace(grad.year, "grad.year.5", "5 years after grad"),
         grad.year = str_replace(grad.year, "grad.year.1", "1 year after grad"),
         grad.year = fct_relevel(grad.year, "1 year after grad", "5 years after grad", "10 years after grad"),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps")) %>%
  filter(states == "Meaningful emp SW") 
  
plot <- ggplot(data = data, aes(MCA.M, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(label = percent(prop, accuracy = 1)), show.legend = FALSE, color = "white") +
  geom_hline(yintercept = 0, color = "black") +
  labs(x="", y = "", title = "Proportion of individuals within each MCA - math test score that\nhave meaningful workforce participation in Southwest", subtitle = "A higher proportion of individuals with lower test scores have meaningful workforce\nparticipation in Southwest\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18)) 

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  
```

<br>

##### MCA - Science

```{r mca  science scores and meaningful workforce participatin in SW}
data <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, MCA.S) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:3) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, MCA.S, states) %>%
  summarize(n = n()) %>%
  ungroup()  %>%
  group_by(grad.year, MCA.S) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.1", "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, MCA.S) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "Meaningful emp SW"])) / 2) + sum(prop[states != "Meaningful emp SW"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
    mutate(grad.year = str_replace(grad.year, "grad.year.10", "10 years after grad"),
           grad.year = str_replace(grad.year, "grad.year.5", "5 years after grad"),
         grad.year = str_replace(grad.year, "grad.year.1", "1 year after grad"),
         grad.year = fct_relevel(grad.year, "1 year after grad", "5 years after grad", "10 years after grad"),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps")) %>%
  filter(states == "Meaningful emp SW") 
  
plot <- ggplot(data = data, aes(MCA.S, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(label = percent(prop, accuracy = 1)), show.legend = FALSE, color = "white") +
  geom_hline(yintercept = 0, color = "black") +
  labs(x="", y = "", title = "Proportion of individuals within each MCA - science test score that\nhave meaningful workforce participation in Southwest", subtitle = "A higher proportion of individuals with lower test scores have meaningful workforce\nparticipation in Southwest\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18)) 

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  
```

<br>

### {.unnumbered .unlisted .toc-ignore .tabset}


And again, this is also related to their post-high school paths. Like CTE engagement and taking the ACT, MCA scores are associated with the type of college they graduate from and degree they attain. However, unlike those, MCA scores are also related to whether someone attends college at all. In particular, lower MCA scores typically had higher proportions of individuals that;

* attained an Associate degree or less, and/or
* graduated from a 2-year college.

The chart below provides the proportion of individuals within each MCA reading score and their post-high school pathway. It shows that a significantly higher proportion of individuals that received a 1, 2, or 3 score on their reading attained an associate degree or less, and/or graduated from a 2-year college. Both of these pathways are associated with higher proportions of individuals that have menaingful workforce participation in Southwest Minnesota.

Although the chart is only using MCA reading scores, this pattern emerges for all three MCA tests (reading, match and science).

<br>

```{r mca scores and post high school path higher}
data <- master %>%
  filter(grad.year.5 != "Attending ps") %>%
  filter(grad.year.5 != "After 2019") %>%
  mutate(highest.cred.level = str_replace(highest.cred.level, "Bachelor degree", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Master degree or higher", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Associate degree", "Associate degree or less"),
         highest.cred.level = str_replace(highest.cred.level, "Less than Associate Degree", "Associate degree or less")) %>%
  mutate(ps.loc = ifelse(ps.pr == "Southwest", "Southwest", ps.pr),
         ps.loc = ifelse(ps.pr != "Southwest" & ps.state == "MN", "MN, outside SW", ps.loc),
         ps.loc = ifelse(ps.state %in% c("SD", "ND", "IA"), "Border state", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Never attended ps", "No college", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Did not grad", "Some college", ps.loc),
         ps.loc = ifelse(!ps.state %in% c("MN", "SD", "ND", "IA") & !is.na(ps.state), "Far far away", ps.loc)) %>%
  mutate(ps.grad.InstitutionSector = as.factor(ps.grad.InstitutionSector),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("1", "2", "3"), "4-year", as.character(ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("4", "11"), "2-year", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector == "10", "Multiple", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("Never attended ps"), "No college", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = str_replace(new.ps.grad.InstitutionSector, "Did not grad", "Some college")) %>%
  filter(new.ps.grad.InstitutionSector != "Multiple") %>%
  mutate(new.ps.grad.InstitutionSector = fct_relevel(new.ps.grad.InstitutionSector, "No college", "Some college", "2-year", "4-year", "Multiple")) %>%
  select(MCA.R, highest.cred.level, new.ps.grad.InstitutionSector, ps.loc) %>%
  drop_na(MCA.R) %>%
  pivot_longer(names_to = "ps.path", values_to = "Category", 2:4) %>%
  group_by(MCA.R, ps.path, Category) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(MCA.R, ps.path) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(Category = str_replace(Category, "2-year", "Grad from 2-year college"),
         Category = str_replace(Category, "Southwest", "Grad from SW college")) %>%
  filter(Category %in% c("Associate degree or less", "Grad from 2-year college")) %>%
  mutate(data_id = seq(n()),
         Category = fct_relevel(Category, "Associate degree or less", "Grad from 2-year college", "Grad from SW college"))

plot <- ggplot(data = data, aes(Category, pct, fill = as.factor(MCA.R), group = as.factor(MCA.R))) +
  geom_col_interactive(position = "dodge") +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  geom_label(aes(x = .95, y = .15, label = "Significantly higher\nproportion"), show.legend = FALSE , fill = "transparent", color = "white") +
  geom_label(aes(x = 1.95, y = .15, label = "Significantly higher\nproportion"), show.legend = FALSE , fill = "transparent", color = "white") +
  labs(x="", y = "", color="", title = "Proportion of MCA - Reading test scores by different post-high\nschool paths 5 years after graduating high school", subtitle = "Higher proportions of individuals with lower MCA scores have an associate degree or\ngraduate from a 2-year college\n") +
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  
  

```

<br>

There's also the ways in which lower MCA scores are related to post-high school paths that can lead to higher proportions of individuals without meaningful workforce participation in Southwest. Lower MCA test scores mean that there were lower proportions of individuals that;

* graduate with a bachelor degree or higher,
* graduate from a 4-year college,
* graduate from a college located in SD, ND, or IA, and
* graduate from a college in MN, but not located in SW.

All of these paths had significantly lower proportions of individuals with meaningful workforce participation in Southwest.

<br>

```{r MCA scores lesser by ps path}
data <- master %>%
  filter(grad.year.5 != "Attending ps") %>%
  filter(grad.year.5 != "After 2019") %>%
  mutate(highest.cred.level = str_replace(highest.cred.level, "Bachelor degree", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Master degree or higher", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Associate degree", "Associate degree or less"),
         highest.cred.level = str_replace(highest.cred.level, "Less than Associate Degree", "Associate degree or less")) %>%
  mutate(ps.loc = ifelse(ps.pr == "Southwest", "Southwest", ps.pr),
         ps.loc = ifelse(ps.pr != "Southwest" & ps.state == "MN", "MN, outside SW", ps.loc),
         ps.loc = ifelse(ps.state %in% c("SD", "ND", "IA"), "Border state", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Never attended ps", "No college", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Did not grad", "Some college", ps.loc),
         ps.loc = ifelse(!ps.state %in% c("MN", "SD", "ND", "IA") & !is.na(ps.state), "Far far away", ps.loc)) %>%
  mutate(ps.grad.InstitutionSector = as.factor(ps.grad.InstitutionSector),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("1", "2", "3"), "4-year", as.character(ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("4", "11"), "2-year", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector == "10", "Multiple", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("Never attended ps"), "No college", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = str_replace(new.ps.grad.InstitutionSector, "Did not grad", "Some college")) %>%
  filter(new.ps.grad.InstitutionSector != "Multiple") %>%
  mutate(new.ps.grad.InstitutionSector = fct_relevel(new.ps.grad.InstitutionSector, "No college", "Some college", "2-year", "4-year", "Multiple")) %>%
  select(MCA.R, highest.cred.level, new.ps.grad.InstitutionSector, ps.loc) %>%
  drop_na(MCA.R) %>%
  pivot_longer(names_to = "ps.path", values_to = "Category", 2:4) %>%
  group_by(MCA.R, ps.path, Category) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(MCA.R, ps.path) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(Category = str_replace(Category, "4-year", "Grad from 4-year college"),
         Category = str_replace(Category, "MN, outside SW", "Grad from MN but not SW college"),
         Category = str_replace(Category, "Border state", "Grad from SD, ND or IA"),
         Category = str_replace(Category, "Far far away", "Grad from another state and not border")) %>%
  filter(Category %in% c("Bachelor degree or higher", "Grad from 4-year college", "Grad from SD, ND or IA", "Grad from MN but not SW college")) %>%
  mutate(data_id = seq(n()),
         Category = fct_relevel(Category, "Bachelor degree or higher", "Grad from 4-year college", "Grad from SD, ND or IA", "Grad from another state and not border", "Grad from MN but not SW college"))

plot <- ggplot(data = data, aes(Category, pct, fill = as.factor(MCA.R), group = as.factor(MCA.R))) +
  geom_col_interactive(position = "dodge") +
  geom_label(position = position_dodge(width = .9), aes(label = percent(pct, accuracy = 1)), show.legend = FALSE) +
  geom_label(aes(x = 1.25, y = .2, label = "Significantly\nlarger\nproportion"), show.legend = FALSE, fill = "transparent") +
  geom_label(aes(x = 2.25, y = .2, label = "Significantly\nlarger\nproportion"), show.legend = FALSE, fill = "transparent") +
  geom_label(aes(x = 3.25, y = .07, label = "Significantly\nlarger\nproportion"), show.legend = FALSE, fill = "transparent") +
  geom_label(aes(x = 4.25, y = .07, label = "Significantly\nlarger\nproportion"), show.legend = FALSE, fill = "transparent") +
  labs(x="", y = "", color="", title = "Proportion of MCA - Reading test scores by post-high school path 5\nyears after graduating high school", subtitle = "Higher MCA scores lead to post-high school paths that lead to lower proportion of\nindividuals with meaningful workforce participation in Southwest\n") +
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  
  

```

<br>

### Fringe variables

There are other variables that analysis confirmed a relationship to having meaningful workforce participation in Southwest, but only for a brief time. For example, a significantly larger proportion of males had meaningful workforce participation in Southwest vs. females, but only for a few years after graduating high school. By five years after graduating high school it was even and there was little difference.

<br>

# Having meaningful workforce participation in Minnesota, but not Southwest

The chart below shows the proportion of individuals for each grad year +X that had meaningful workforce participation in Minnesota,  but not Southwest. The proportion of individuals for each year after graduating high school grows significantly at four years after graduating high school and continues to grow until about seven years after graduating high school.

<br>

```{r prop meaningful workforce participation in MN but not SW}
meaningful.emp.mn.not.sw.prop <- prop.states %>%
  filter(five.states == "Meaningful workforce MN")

plot <- ggplot(meaningful.emp.mn.not.sw.prop, aes(x = as.numeric(grad.year) - 1, pct)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste("Grad year +X: ", grad.year, "\nEmployment state: ", five.states, "\nNumber in this employment state: ", comma(n), "\nProportion of individuals in this employment state: ", percent(pct, accuracy = .1), sep = "")), fill = "#d73027") +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9), fill = "#d73027") +
  geom_text(aes(y = pct / 2, label = paste("N = \n", comma(n), sep = "")), show.legend = FALSE) +
  labs(x="\nYears after graduating high school", y = "", color="", title = "Percent share of individuals in each year after graduating high\nschool with meaningful workforce participation in Minnesota, not\nSouthwest", subtitle = "The proportion grows significantly four years after graduating high school\n")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

## Factors

The primary factors are variables/characteristics of the individual that may lead them to more likely have meaningful employment for an employer located in Southwest Minnesota. This isn't necessarily where they live.

Analysis shows that these individuals are more likely to;

* have attained a 4-year degree or less;
* have taken less CTE courses and involvement in CTE programming; and
* have taken college prep classes and tests in high school such as the ACT.

Let's look at each of these themes in order of significance.

<br>

### Post-secondary attendance and location

Whether an individual attended a post-secondary institution, the types of institution attended, the location of the post-secondary institution, and the highest credential earned are all strongly related to whether an individual has meaningful employment in Minnesota but not Southwest throughout their years after graduating high school.

<br>

#### Highest credential earned

When looking at the highest credential earned, there is a significantly larger proportion of individuals with an associate degree or less of a credential with meaningful workforce participation in Southwest Minnesota. 

The highest credential earned is categorized by the following;

* No college: never attended a post-secondary institution.
* Some college: attended college but never graduated with a credential
* Less than Associate Degree: individuals that received a certificate or other credential but isn't an Associate degree or higher.
* Associate Degree: this category includes all individuals that earned only an Associate degree.
* Bachelor degree or higher: this includes all individuals that earned either a bachelor degree, masters or post-doctoral degree.

<br>

The chart below shows the proportion of individuals that have meaningful employment in  Minnesota but not Southwest by their highest credentials earned in post-secondary. It clearly shows that there is a significantly larger proportion of individuals that have earned a bachelor degree or higher. By five years after graduating high school, 34% of individuals with had meaningful workforce participation in Minnesota but not Southwest compared to only 22% for individuals with an Associate degree, 13% of individuals with no college, and 20% with some college but no credential. The percentages stay relatively the same 10 years after graduating high school.

<br>

```{r highest credential earned and meaningful emp mn not sw}
data <- master %>%
  select(grad.year.5, grad.year.10, highest.cred.level) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  mutate(highest.cred.level = str_replace(highest.cred.level, "Bachelor degree", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Master degree or higher", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Associate degree", "Associate degree or less"),
         highest.cred.level = str_replace(highest.cred.level, "Less than Associate Degree", "Associate degree or less")) %>%
  group_by(grad.year, highest.cred.level, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year, states) %>%
  group_by(grad.year, highest.cred.level) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = str_replace(grad.year, "grad.year.5", "5 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.10", "10 years after hs grad"),
         grad.year = fct_relevel(grad.year, "5 years after hs grad", "10 years after hs grad"),
         highest.cred.level = fct_relevel(highest.cred.level, "No college", "Some college", "Associate degree or less", "Bachelor degree or higher")) %>%
  filter(states == "Meaningful emp MN")
  
plot <- ggplot(data = data, aes(highest.cred.level, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(label = percent(prop, accuracy = .1)), show.legend = FALSE, color= "white", size = 5) +
  geom_label(aes(y = prop / 2, label = paste("N = ", comma(n))), show.legend = FALSE) +
  geom_label(aes(x = 2.5, y = .3, label = "Significantly larger\nproportion"), show.legend = FALSE, fill = "white") +
  geom_segment(x = 3.1, xend = 4, y = .3, yend = .3, arrow = arrow(length = unit(.25, "cm"))) +
  labs(x="", y = "", title = "Proportion of individuals with meaningful workforce participation in\nMinnesota but not Southwest by highest credential earned", subtitle = "A significantly larger proportion of individuals with bachelor degree or higher have\nmeaningful worforce participation in Southwest\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "none",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 15, hjust = 1))

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

Not only is this group have the highest proportion of individuals with meaningful workforce participation in Minnesota but not Southwest, they are also the largest contributors. Individuals with an Bachelor degree or higher made up 1,557 of the 4,156 individuals with meaningful workforce participation in Southwest - nearly 38%. The lowest was the group with no college who made up 634 of the individuals with meaningful workforce participation in Minnesota but not Southwest.

<br>

```{r highest cred earned meaningful emp mn not sw flow}
flow.5 <- master %>%
  filter(grad.year.5 != "After 2019") %>%
  filter(grad.year.5 != "Attending ps") %>%
  mutate(highest.cred.level = str_replace(highest.cred.level, "Bachelor degree", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Master degree or higher", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Associate degree", "Associate degree or less"),
         highest.cred.level = str_replace(highest.cred.level, "Less than Associate Degree", "Associate degree or less")) %>%
    group_by(grad.year.5, highest.cred.level) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(grad.year.5 = str_replace(grad.year.5, "Meaningful emp SW", "Meaningful workforce SW"),
         grad.year.5 = str_replace(grad.year.5, "Meaningful emp MN", "Meaningful workforce MN"),
         grad.year.5 = str_replace(grad.year.5, "No MN emp record, not attending ps", "No MN emp record"),
         grad.year.5 = str_replace(grad.year.5, "Not meaningful, not attending ps", "Not meaningful workforce"),
         grad.year.5 = fct_relevel(grad.year.5, "Meaningful workforce SW", "Meaningful workforce MN", "Not meaningful workforce", "No MN emp record"),
         highest.cred.level = fct_relevel(highest.cred.level, "No college", "Some college", "Associate degree or less", "Bachelor degree or higher"))

plot <- ggplot(data = flow.5, aes(axis1 = highest.cred.level, axis2 = grad.year.5, y = n)) +
  geom_alluvium(aes(fill = grad.year.5)) +
  geom_stratum(aes(fill = grad.year.5)) +
  geom_text(stat = "stratum", 
            aes(label = paste(after_stat(stratum), "\nN = ", comma(after_stat(count)), sep = ""))) +
  geom_text(stat = "flow", aes(label = comma(n), color = grad.year.5), nudge_x = -.2) +
  labs(x="", y = "", color="", title = "Flow from highest credential earned to different states of employment", subtitle = "The largest contributor to meaningful workforce participation is from the Associate Degree\nor less group")+
  scale_y_continuous(labels=scales::comma)+
  theme_bar+
  theme_void() +
  scale_fill_manual(values = c("#d73027", "grey75", "grey75", "grey75", "grey75", "grey75")) +
  scale_color_manual(values = c("black", "grey75", "grey75", "grey75", "grey75", "grey75")) +
  theme(legend.position = "none",
        text = element_text(size = 18, family = "Calibri"),
        plot.title = element_text(face = "bold"))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))       

```

<br>

#### Type of post-secondary institution attended

Very similar to highest credentials earned, the type of institution that an individual graduated from is highly associated with whether someone is likely to have meaningful employment in Southwest Minnesota.

Individuals in the dataset were categorized by the following;

* No college: never attended a post-secondary institution.
* Some college: attended a post-secondary institution but never graduated.
* 2-year: Graduates from a public, private, or for-profit two-year post-secondary institution.
* 4-tear: Graduated from a public, private, or for-profit 4-year post-secondary institution.
* Multiple: Graduated from multiple types of post-secondary institutions.

The chart below provides the proportion of individuals that graduated from each type of post-secondary institution and have meaningful workforce participation in Minnesota but not Southwest. It shows that the proportion of individuals graduating from a 4-year college is significantly higher than other institution types. A third of the individuals that graduate from a 4-year college have meaningful workforce participation in Southwest but not Southwest  5 years after graduating high school. 

<br>

```{r post secondary institution type and meaningful emp mn but not sw}
meaningful.emp.sw.ps.recode <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, ps.grad.InstitutionSector) %>%
  mutate(ps.grad.InstitutionSector = as.factor(ps.grad.InstitutionSector),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("1", "2", "3"), "4-year", as.character(ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("4", "11"), "2-year", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector == "10", "Multiple", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("Never attended ps"), "No college", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = str_replace(new.ps.grad.InstitutionSector, "Did not grad", "Some college"),
         new.ps.grad.InstitutionSector = fct_relevel(new.ps.grad.InstitutionSector, "No college", "Some college", "2-year", "4-year", "Multiple"))


data <- meaningful.emp.sw.ps.recode %>%
  select(grad.year.5, grad.year.10, new.ps.grad.InstitutionSector) %>%
  filter(new.ps.grad.InstitutionSector != "Multiple") %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, new.ps.grad.InstitutionSector, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year, new.ps.grad.InstitutionSector) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, new.ps.grad.InstitutionSector) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "Meaningful emp SW"])) / 2) + sum(prop[states != "Meaningful emp SW"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
  filter(states == "Meaningful emp MN") %>%
  mutate(grad.year = str_replace(grad.year, "grad.year.5", "5 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.10", "10 years after hs grad"),
         grad.year = fct_relevel(grad.year, "5 years after hs grad", "10 years after hs grad")) 

plot <- ggplot(data = data, aes(new.ps.grad.InstitutionSector, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(label = percent(prop, accuracy = .1)), show.legend = FALSE, size = 5, color = "white") +
  geom_text(aes(y = prop / 2, label = paste("N = ", comma(n), sep = "")), show.legend = FALSE) +
  geom_label(aes(x = 4, y = .3, label = "Significantly\nlarger\nproportion"), show.legend = FALSE, fill = "transparent") +
  labs(x="", y = "", title = "Proportion of individuals with meaningful employment in Minnesota\n but not Southwest by the institution sector from which they graduated", subtitle = "A significantly larger proportion of individuals graduating from a 4-year college have\nmeaningful workforce participation in Minnesota but not Southwest\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 15, hjust = 1))

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      



```

<br>


The chart below shows the links between the type of institution sector from which individuals graduated and the type of "employment state" they had five years after graduating high school. Graduating from a 4-year college is by far the highest contributor to meaningful workforce participation in Minnesota but not Southwest with 1,683 individuals. This is nearly half of all the individuals that have meaningful workforce participation in Minnesota but not Southwest.

<br>

```{r ps grad sector by meaningful workforce participation mn not Sw flow}
flow.5 <- meaningful.emp.sw.ps.recode %>%
  select(grad.year.5, new.ps.grad.InstitutionSector) %>%
  filter(grad.year.5 != "Attending ps") %>%
  filter(grad.year.5 != "After 2019") %>%
  filter(new.ps.grad.InstitutionSector != "Multiple") %>%
  group_by(grad.year.5, new.ps.grad.InstitutionSector) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(grad.year.5 = str_replace(grad.year.5, "Meaningful emp SW", "Meaningful workforce SW"),
         grad.year.5 = str_replace(grad.year.5, "Meaningful emp MN", "Meaningful workforce MN"),
         grad.year.5 = str_replace(grad.year.5, "No MN emp record, not attending ps", "No MN emp record"),
         grad.year.5 = str_replace(grad.year.5, "Not meaningful, not attending ps", "Not meaningful workforce"),
         grad.year.5 = fct_relevel(grad.year.5, "Meaningful workforce SW", "Meaningful workforce MN", "Not meaningful workforce", "No MN emp record"))

plot <- ggplot(data = flow.5, aes(axis1 = new.ps.grad.InstitutionSector, axis2 = grad.year.5, y = n)) +
  geom_alluvium(aes(fill = grad.year.5)) +
  geom_stratum(aes(fill = grad.year.5)) +
  geom_text(stat = "stratum", 
            aes(label = paste(after_stat(stratum), "\nN = ", comma(after_stat(count)), sep = ""))) +
  geom_text(stat = "flow", aes(label = comma(n), color = grad.year.5), nudge_x = -.2) +
  labs(x="", y = "", color="", title = "Flow from post-secondary institution type to different employment\nstates", subtitle = "Due to 2-year graduates being small, the contribution to meaningful workforce participation\nin Southwest isn't as large")+
  scale_y_continuous(labels=scales::comma)+
  theme_void() +
  scale_fill_manual(values = c("#d73027", "grey75", "grey75", "grey75")) +
  scale_color_manual(values = c("black", "grey75", "grey75", "grey75")) +
  theme(legend.position = "none",
        text = element_text(size = 18, family = "Calibri"),
        plot.title = element_text(face = "bold"))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  


```

<br>

#### Location of post-secondary

Not only does the type of post-secondary institution an individual graduates from have an impact on the Southwest laborforce, the location of this institution also matters. Individuals were broken into the following categories;

* Southwest MN: graduated from a post-secondary institution in Southwest Minnesota.
* MN - outside Southwest: graduated from a post-secondary institution located in Minnesota but outside of Southwest.
* Border state: graduated from a post-secondary institution located in South Dakota, North Dakota, or Iowa.
* Far, far away: graduate from a post-secondary institution located in another states besides the border states.
* Some college: attended college but did not graduate
* No college: did not attend college.

The chart below provides the proportion of individuals in each type of post-secondary location category. It shows a significantly higher proportion of individuals who graduated from a post-secondary institution located within Minnesota but outside Southwest have meaningful workforce participation in Minnesota but not Southwest - 40% at 5 years after graduation and 39% at 10 years after graduation.

<br>

```{r post secondary location and meaningful workforce participation mn not sw}
data <- master %>%
  select(grad.year.5, grad.year.10, ps.grad.InstitutionSector, ps.grad, ps.state, ps.pr) %>%
  mutate(ps.loc = ifelse(ps.pr == "Southwest", "Southwest MN", ps.pr),
         ps.loc = ifelse(!is.na(ps.pr) & ps.pr != "Southwest", "MN - outside Southwest", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Never attended ps", "No college", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Did not grad", "Some college", ps.loc),
         ps.loc = ifelse(ps.state %in% c("SD", "ND", "IA"), "Border State", ps.loc),
         ps.loc = ifelse(is.na(ps.loc), "Far far away", ps.loc)) %>%
  select(grad.year.5, grad.year.10, ps.loc) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, ps.loc, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year, ps.loc) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, ps.loc) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "Meaningful emp MN"])) / 2) + sum(prop[states != "Meaningful emp MN"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
  filter(states == "Meaningful emp MN") %>%
  mutate(grad.year = str_replace(grad.year, "grad.year.5", "5 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.10", "10 years after hs grad"),
         grad.year = fct_relevel(grad.year, "5 years after hs grad", "10 years after hs grad"),
         ps.loc = fct_relevel(ps.loc, "No college", "Some college", "Southwest MN", "MN - outside Southwest", "Border State", "Far far away"),
         data_id = seq(n())) 

plot <- ggplot(data = data, aes(ps.loc, prop, fill = states)) +
  facet_wrap(~grad.year, scales = "free_y") +
  geom_bar_interactive(stat = "identity", aes(data_id = data_id, tooltip = paste("Years after graduating hs: ", grad.year, "\nType of college graduated from: ", ps.loc, "\nNumber of individuals: ", comma(n), "\nPercent of individuals: ", percent(prop, accuracy = .1), sep = ""))) +
    geom_label(aes(label = percent(prop, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  geom_label(aes(x = 4, y = .35, label = "Larger\nproportion"), fill = "transparent") +
  geom_text(aes(y = prop / 2, label = paste("N =\n", comma(n), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", title = "Proportion of individuals with meaningful workforce participation in\nMinnesota but not Southwest by the institution sector from which\nthey graduated", subtitle = "A significantly larger proportion of individuals graduating from a  college outside\nSouthwest have meaningful workforce participation in Minnesota but not Southwest\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

The chart below shows that colleges located in Minnesota but outside SW are, by far, the largest contributor to individuals having meaningful workforce participation in Minnesota but not Southwest.

<br>

```{r post secondary location by meaningful workforce participation mn not sw flow}
flow <- master %>%
  select(grad.year.5, grad.year.10, ps.grad.InstitutionSector, ps.grad, ps.state, ps.pr) %>%
  mutate(ps.loc = ifelse(ps.pr == "Southwest", "Southwest MN", ps.pr),
         ps.loc = ifelse(!is.na(ps.pr) & ps.pr != "Southwest", "MN - outside Southwest", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Never attended ps", "No college", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Did not grad", "Some college", ps.loc),
         ps.loc = ifelse(ps.state %in% c("SD", "ND", "IA"), "Border State", ps.loc),
         ps.loc = ifelse(is.na(ps.loc), "Far far away", ps.loc)) %>%
  select(grad.year.5, ps.loc) %>%
  filter(grad.year.5 != "Attending ps") %>%
  filter(grad.year.5 != "After 2019") %>%
  filter(ps.loc != "Multiple") %>%
  group_by(grad.year.5, ps.loc) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  mutate(grad.year.5 = str_replace(grad.year.5, "Meaningful emp SW", "Meaningful workforce SW"),
         grad.year.5 = str_replace(grad.year.5, "Meaningful emp MN", "Meaningful workforce MN"),
         grad.year.5 = str_replace(grad.year.5, "No MN emp record, not attending ps", "No MN emp record"),
         grad.year.5 = str_replace(grad.year.5, "Not meaningful, not attending ps", "Not meaningful workforce"),
         grad.year.5 = fct_relevel(grad.year.5, "Meaningful workforce SW", "Meaningful workforce MN", "Not meaningful workforce", "No MN emp record"),
         ps.loc = fct_relevel(ps.loc, "No college", "Some college", "Southwest MN", "MN - outside Southwest", "Border State", "Far far away"))

plot <- ggplot(data = flow, aes(axis1 = ps.loc, axis2 = grad.year.5, y = n)) +
  geom_alluvium(aes(fill = grad.year.5)) +
  geom_stratum(aes(fill = grad.year.5)) +
  geom_text(stat = "stratum", 
            aes(label = paste(after_stat(stratum), "\nN = ", comma(after_stat(count)), sep = ""))) +
  geom_text(stat = "flow", aes(label = comma(n), color = grad.year.5), nudge_x = -.2) +
  labs(x="", y = "", color="", title = "Flow of post secondary grad location by workforce participation", subtitle = "The largest contributor to meaningful workforce participation in Southwest never\ngraduated from college") +
  scale_y_continuous(labels=scales::comma)+
  theme_bar+
  theme_void() +
  scale_fill_manual(values = c("#d73027", "grey75", "grey75", "grey75")) +
  scale_color_manual(values = c("grey75", "black", "grey75", "grey75")) +
  theme(legend.position = "none",
        text = element_text(size = 18))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  


```

<br>

Previously we showed that there was significant difference between 2-year and 4-year grads and their proportion that had meaningful workforce participation in Southwest Minnesota. The chart below provides that breakdown with further refinement - differences in 2-year and 4-year in Southwest Minnesota. So the categories are;

* No college: individuals that did not attend a post-secondary institution
* Some college: individuals that attended but never graduated
* 2-yr, Southwest: individuals that graduated from a 2-year college in the southwest region.
* 4-yr, Southwest: individuals that graduated from a 4-year college in the southwest fegion.
* MN, outside Southwest: individuals that graduated from a college in Minnesota but outside of southwest.
* Outside MN: individuals that graduated from a college outside of Minnesota.

The chart below shows that a significantly higher proportion of individuals that graduated from a 4-year college in Southwest and in Minnesota had meaningful workforce participation in Minnesota but not Southwest. The proportion of graduates from a 4-year college in Southwest had 32% of their individuals with meaningful employment in Minnesota but not Southwest five years after graduation. It was 34% by ten years after graduating high school.

<br>

```{r proportion post secondary location deeper and meaningful workforce participation mn not sw}
data <- master %>%
  select(grad.year.5, grad.year.10, ps.grad.InstitutionSector, ps.grad, ps.state, ps.pr) %>%
  mutate(ps.loc = ifelse(ps.pr == "Southwest" & ps.grad.InstitutionSector %in% c("4", "11"), "2-yr, SW", ps.pr),
         ps.loc = ifelse(ps.pr == "Southwest" & ps.grad.InstitutionSector %in% c(1,2,3), "4-yr, SW", ps.loc),
         ps.loc = ifelse(ps.state != "MN", "Out of state", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Did not grad", "Some college", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Never attended ps", "No college", ps.loc),
         ps.loc = ifelse(ps.loc %in% c("Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southeast"), "MN, outside SW", ps.loc)) %>%
  filter(ps.grad.InstitutionSector != 10) %>%
  select(grad.year.5, grad.year.10, ps.loc) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, ps.loc, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year, ps.loc) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, ps.loc) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "Meaningful emp SW"])) / 2) + sum(prop[states != "Meaningful emp SW"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
  filter(states == "Meaningful emp MN") %>%
  mutate(grad.year = str_replace(grad.year, "grad.year.5", "5 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.10", "10 years after hs grad"),
         grad.year = fct_relevel(grad.year, "5 years after hs grad", "10 years after hs grad"),
         ps.loc = fct_relevel(ps.loc, "No college", "Some college", "2-yr, SW", "4-yr, SW", "MN, outside SW", "Out of state"),
         data_id = seq(n())) 

plot <- ggplot(data = data, aes(ps.loc, prop, fill = states)) +
  facet_wrap(~grad.year, scales = "free_y") +
  geom_bar_interactive(stat = "identity", aes(data_id = data_id, tooltip = paste("Years after graduating hs: ", grad.year, "\nType of college graduated from: ", ps.loc, "\nNumber of individuals: ", comma(n), "\nPercent of individuals: ", percent(prop, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(prop, accuracy = 1)), show.legend = FALSE, color = "white") +
  geom_text(aes(y = .1, label = ps.loc), angle = 90, color = "white", size = 5) +
  geom_label(aes(x = 4.5, y = .3, label = "Significantly larger\nproportion"), show.legend = FALSE, fill = "transparent") +
  labs(x="", y = "", title = "Proportion of individuals with meaningful employment in Minnesota\nnot Southwestby the institution sector from which they graduated", subtitle = "A significantly larger proportion of individuals graduating from a Southwest college have\nmeaningful workforce participation in Southwest\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "none",
        text = element_text(size = 18),
        axis.text.x = element_blank())

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

### CTE Courses and Programming

It's no secret that career and technical education in high schools has received significantly more attention, and subsequently more investment and resources. It's always been believed that these investments lead to better outcomes in student retainment for rural regions. The analysis shows that this does seem to be true. Throughout the analysis, career and technical education courses and programming had one of the strongest relationships in whether an individual had meaningful employment somewhere in Southwest vs. other employment outcomes.

The chart below compares the total number of courses taken with each state of employment for all individuals that graduated from a high school in Southwest. For those not familiar with boxplots, the bottom side of the box is the 25th percentile of CTE courses taken in that employment state, the middle line is the median and the top line is the 75th percentile. What this chart tells us is that the 25th, median, mean, and 75th percentile of the number of CTE courses taken by individuals who have meaningful employment in Minnesota but not Southwest are significantly lower than the number taken by individuals with meaningful workforce participation in Southwest.

<br>

```{r cte and meaningful workforce participation in mn not sw}
data <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, total.cte.courses.taken) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:3) %>%
  select(grad.year, states, total.cte.courses.taken) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  drop_na() %>%
  group_by(grad.year, states) %>%
  mutate(q1 = quantile(total.cte.courses.taken, .25),
         q3 = quantile(total.cte.courses.taken, .75),
         iqr = IQR(total.cte.courses.taken),
         low.outlier = q1 - 1.5*iqr,
         high.outlier = q3 + 1.5*iqr) %>%
  filter(total.cte.courses.taken > low.outlier,
         total.cte.courses.taken < high.outlier) %>%
  ungroup() %>%
  mutate(grad.year = str_replace(grad.year, "grad.year.5", "5 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.10", "10 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.1", "1 year after hs grad"),
         grad.year = fct_relevel(grad.year, "1 year after hs grad", "5 years after hs grad", "10 years after hs grad"),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps")) 

labels <- data %>%
  group_by(grad.year, states) %>%
  summarize(Min = quantile(total.cte.courses.taken, .0),
            Q1 = quantile(total.cte.courses.taken, .25),
            Median = median(total.cte.courses.taken),
            Q3 = quantile(total.cte.courses.taken, .75),
            Max = quantile(total.cte.courses.taken, 1),
            Mean = mean(total.cte.courses.taken)) %>%
  ungroup()

plot <- ggplot(data, aes(grad.year, total.cte.courses.taken, fill = states)) +
  geom_boxplot(position = position_dodge(width = .7)) +
  stat_summary(fun.y = "mean", geom = "point", color = "#1a9850", position = position_dodge(width = .7), size = 3, label = mean, show.legend = FALSE) +
  annotate(geom = "label",
           x = 2,
           y = 25, 
           label = "Lower 25th percentile\n75th percentile,\nmean and median",
           size = 5) +
 annotate(geom = "segment",
          x = 2, 
          xend = 1.1, 
          y = 23, 
          yend = 9, 
          arrow = arrow(length = unit(.25, "cm"))) +
  annotate(geom = "segment",
           x = 2, 
           xend = 2.1, 
           y = 23, 
           yend = 9, 
           arrow = arrow(length = unit(.25, "cm"))) +
    annotate(geom = "segment",
           x = 2, 
           xend = 3.1, 
           y = 23, 
           yend = 7, 
           arrow = arrow(length = unit(.25, "cm"))) +
  labs(x="", y = "", color="", title = "Boxplots of number of CTE courses taken by state", subtitle = "Meaningful employment in Minnesota but not Southwest typically associated with lower\nnumber of CTE courses taken")+
  scale_y_continuous(labels=scales::comma,
                     limits = c(0, 30))+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

### Taking the ACT

Since the post-secondary pathway has an influence on whether an individual has meaningful workforce participation in Southwest, it's not surprising that whether an individual is preparing to go to college in high school also plays a role.

The chart below shows that nearly a third of individuals who did not take the ACT had meaningful workforce participation in southwest at five and ten years after graduating high school.

<br>

```{r took act and meaningful workforce participation in mn not sw}
data <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, took.ACT) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:3) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, took.ACT, states) %>%
  summarize(n = n()) %>%
  ungroup()  %>%
  group_by(grad.year, took.ACT) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.1", "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, took.ACT) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "Meaningful emp MN"])) / 2) + sum(prop[states != "Meaningful emp MN"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
    mutate(grad.year = str_replace(grad.year, "grad.year.10", "10 years after grad"),
           grad.year = str_replace(grad.year, "grad.year.5", "5 years after grad"),
         grad.year = str_replace(grad.year, "grad.year.1", "1 year after grad"),
         grad.year = fct_relevel(grad.year, "1 year after grad", "5 years after grad", "10 years after grad"),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps")) %>%
  filter(states == "Meaningful emp MN") %>%
    filter(grad.year != "1 year after grad") %>%
  mutate(took.ACT = ifelse(took.ACT == "No", "Did not\ntake ACT", "Took ACT"))
  
plot <- ggplot(data = data, aes(took.ACT, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(label = percent(prop, accuracy = 1)), show.legend = FALSE) +
  geom_label(aes(y = prop / 2, label = paste("N = ", comma(n), sep = "")), show.legend = FALSE, color = "white") +
  geom_label(aes(x = 2, y = .2, label = "Significantly\nhigher\nproportion"), show.legend = FALSE, color = "white") +
  geom_hline(yintercept = 0, color = "black") +
  labs(x="", y = "", title = "Proportion of individuals who did and did not take ACT that have\nmeaningful workforce participation in Minnesota but not Southwest", subtitle = "Taking the ACT was associated with higher proportions of individuals having\nmeaningful workforce participation in Southwest\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18)) 

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```



<br>

# No MN employment record, not attending post-secondary

This is a rather large group in the dataset and there are multiple post-high school paths that these folks could be one but we can't track;

1. Not participating in the labor force, living anywhere.
2. Working in a federal position
3. In the military
4. Working in another state.

Let's first take a look to see how many and the percentage of people that are in this category for each grad year.

The chart below provides the percentage of individuals for each year after graduating high school that have no Minnesota employment record. There is significant growth in the percentage at 5 years after graduating high school where it jumps from being in mid-teens to nearly 30% of the dataset. 

<br>

```{r no mn emp record n}

no.mn.emp.record.prop <- prop.states %>%
  filter(five.states == "No MN emp record")

plot <- ggplot(no.mn.emp.record.prop, aes(x = as.numeric(grad.year) - 1, pct)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste("Grad year +X: ", grad.year, "\nEmployment state: ", five.states, "\nNumber in this employment state: ", comma(n), "\nProportion of individuals in this employment state: ", percent(pct, accuracy = .1), sep = ""), fill = five.states)) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  geom_text(aes(y = pct / 2, label = paste("N = \n", comma(n), sep = "")), show.legend = FALSE) +
  labs(x="\nYears after graduating high school", y = "", color="", title = "Percent share of individuals in each year after graduating high\nschool with no MN employment record", subtitle = "The proportion grows quickly but stalls 4 years after graduation")+
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = updated.states.color) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

## Factors

Analysis showed that there were a number of factors highlighting significant differences. The most important factors were;

* Post-high school path - in particular, this group was significantly more likely to never attend college.
* CTE Course - this group was significantly less likely to have CTE experience
* Post-high school planning - significantly less likely to take the ACT
* Fringe - significantly more likely to have limited english proficiency, be hispanic or asian, and graduate from a high school in EDR 8.

<br>

### Post-secondary attedance and location

Whether an individual attended a post-secondary institution, the types of institution attended, the location of the post-secondary institution, and the highest credential earned are all strongly related to whether an individual has no mn employment record.

<br>

#### Highest credential earned

When looking at the highest credential earned, there is a significantly larger proportion of individuals with an associate degree or less of a credential with meaningful workforce participation in Southwest Minnesota. 

The highest credential earned is categorized by the following;

* No college: never attended a post-secondary institution.
* Some college: attended college but never graduated with a credential
* Less than Associate Degree: individuals that received a certificate or other credential but isn't an Associate degree or higher.
* Associate Degree: this category includes all individuals that earned only an Associate degree.
* Bachelor degree or higher: this includes all individuals that earned either a bachelor degree, masters or post-doctoral degree.

<br>

The chart below shows the proportion of individuals that do not have a MN employment record five and ten years after graduating high school by their highest credentials earned in post-secondary. It clearly shows that there is a significantly larger proportion of individuals that never attended college. At ten years after graduating high school, the percentages of individuals having some college or a bachelor's degree or higher do rise quite a bit.

<br>

```{r highest credential earned and no mn emp record}
data <- master %>%
  select(grad.year.5, grad.year.10, highest.cred.level) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  mutate(highest.cred.level = str_replace(highest.cred.level, "Bachelor degree", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Master degree or higher", "Bachelor degree or higher"),
         highest.cred.level = str_replace(highest.cred.level, "Associate degree", "Associate degree or less"),
         highest.cred.level = str_replace(highest.cred.level, "Less than Associate Degree", "Associate degree or less")) %>%
  group_by(grad.year, highest.cred.level, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year, states) %>%
  group_by(grad.year, highest.cred.level) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = str_replace(grad.year, "grad.year.5", "5 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.10", "10 years after hs grad"),
         grad.year = fct_relevel(grad.year, "5 years after hs grad", "10 years after hs grad"),
         highest.cred.level = fct_relevel(highest.cred.level, "No college", "Some college", "Associate degree or less", "Bachelor degree or higher")) %>%
  filter(states == "No MN emp record, not attending ps")
  
plot <- ggplot(data = data, aes(highest.cred.level, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(label = percent(prop, accuracy = .1)), show.legend = FALSE, color= "white", size = 5) +
  geom_text(aes(x = 1, y = .3, label = "Signifiantly\nlarger\nproportion"), show.legend = FALSE, color = "black") +
  labs(x="", y = "", title = "Proportion of individuals with no MN employment record in\nMinnesota by highest credential earned", subtitle = "A significantly larger proportion of individuals that never attended college\ndo not have a MN employment record\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "none",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 15, hjust = 1))

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```


<br>

#### Type of post-secondary institution attended

Very similar to highest credentials earned, the type of institution that an individual graduated from is highly associated with whether someone is likely to have meaningful employment in Southwest Minnesota.

Individuals in the dataset were categorized by the following;

* No college: never attended a post-secondary institution.
* Some college: attended a post-secondary institution but never graduated.
* 2-year: Graduates from a public, private, or for-profit two-year post-secondary institution.
* 4-tear: Graduated from a public, private, or for-profit 4-year post-secondary institution.
* Multiple: Graduated from multiple types of post-secondary institutions.

The chart below provides the proportion of individuals that graduated from each type of post-secondary institution and do not have a MN employment record in Minnesota. It shows that the proportion of individuals  that never attended college is significantly higher than other institution types. But again, by ten years after graduating high school the percentage of individuals having some college or graduated from a 4-year college increases quite a bit.

<br>

```{r post secondary institution type and no MN emp record}
meaningful.emp.sw.ps.recode <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, ps.grad.InstitutionSector) %>%
  mutate(ps.grad.InstitutionSector = as.factor(ps.grad.InstitutionSector),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("1", "2", "3"), "4-year", as.character(ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("4", "11"), "2-year", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector == "10", "Multiple", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = ifelse(ps.grad.InstitutionSector %in% c("Never attended ps"), "No college", as.character(new.ps.grad.InstitutionSector)),
         new.ps.grad.InstitutionSector = str_replace(new.ps.grad.InstitutionSector, "Did not grad", "Some college"),
         new.ps.grad.InstitutionSector = fct_relevel(new.ps.grad.InstitutionSector, "No college", "Some college", "2-year", "4-year", "Multiple"))


data <- meaningful.emp.sw.ps.recode %>%
  select(grad.year.5, grad.year.10, new.ps.grad.InstitutionSector) %>%
  filter(new.ps.grad.InstitutionSector != "Multiple") %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, new.ps.grad.InstitutionSector, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year, new.ps.grad.InstitutionSector) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, new.ps.grad.InstitutionSector) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "No MN emp record, not attending ps"])) / 2) + sum(prop[states != "No MN emp record, not attending ps"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
  filter(states == "No MN emp record, not attending ps") %>%
  mutate(grad.year = str_replace(grad.year, "grad.year.5", "5 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.10", "10 years after hs grad"),
         grad.year = fct_relevel(grad.year, "5 years after hs grad", "10 years after hs grad")) 

plot <- ggplot(data = data, aes(new.ps.grad.InstitutionSector, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(label = percent(prop, accuracy = .1)), show.legend = FALSE, size = 5, color = "white") +
  labs(x="", y = "", title = "Proportion of individuals with no MN employment recordm in Minnesota\n by the institution sector from which they graduated", subtitle = "A significantly larger proportion of individuals graduating from a 4-year college have\nmeaningful workforce participation in Minnesota but not Southwest\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 15, hjust = 1))

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      



```

<br>

#### Location of post-secondary

Not only does the type of post-secondary institution an individual graduates from have an impact on the Southwest laborforce, the location of this institution also matters. Individuals were broken into the following categories;

* Southwest MN: graduated from a post-secondary institution in Southwest Minnesota.
* MN - outside Southwest: graduated from a post-secondary institution located in Minnesota but outside of Southwest.
* Border state: graduated from a post-secondary institution located in South Dakota, North Dakota, or Iowa.
* Far, far away: graduate from a post-secondary institution located in another states besides the border states.
* Some college: attended college but did not graduate
* No college: did not attend college.

The chart below provides the proportion of individuals in each type of post-secondary location category. It shows a significantly higher proportion of individuals who graduated from a post-secondary institution located in a border state or further away have no Minnesota employment record at five and ten years after graduating high school.

<br>

```{r post secondary location and no mn employment record}
data <- master %>%
  select(grad.year.5, grad.year.10, ps.grad.InstitutionSector, ps.grad, ps.state, ps.pr) %>%
  mutate(ps.loc = ifelse(ps.pr == "Southwest", "Southwest MN", ps.pr),
         ps.loc = ifelse(!is.na(ps.pr) & ps.pr != "Southwest", "MN - outside Southwest", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Never attended ps", "No college", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Did not grad", "Some college", ps.loc),
         ps.loc = ifelse(ps.state %in% c("SD", "ND", "IA"), "Border State", ps.loc),
         ps.loc = ifelse(is.na(ps.loc), "Far far away", ps.loc)) %>%
  select(grad.year.5, grad.year.10, ps.loc) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, ps.loc, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year, ps.loc) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, ps.loc) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "No MN emp record, not attending ps"])) / 2) + sum(prop[states != "No MN emp record, not attending ps"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
  filter(states == "No MN emp record, not attending ps") %>%
  mutate(grad.year = str_replace(grad.year, "grad.year.5", "5 years after hs grad"),
         grad.year = str_replace(grad.year, "grad.year.10", "10 years after hs grad"),
         grad.year = fct_relevel(grad.year, "5 years after hs grad", "10 years after hs grad"),
         ps.loc = fct_relevel(ps.loc, "No college", "Some college", "Southwest MN", "MN - outside Southwest", "Border State", "Far far away"),
         data_id = seq(n())) 

plot <- ggplot(data = data, aes(ps.loc, prop, fill = states)) +
  facet_wrap(~grad.year, scales = "free_y") +
  geom_bar_interactive(stat = "identity", aes(data_id = data_id, tooltip = paste("Years after graduating hs: ", grad.year, "\nType of college graduated from: ", ps.loc, "\nNumber of individuals: ", comma(n), "\nPercent of individuals: ", percent(prop, accuracy = .1), sep = ""))) +
    geom_label(aes(label = percent(prop, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  geom_text(aes(y = prop / 2, label = paste("N =\n", comma(n), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", title = "Proportion of individuals with no MN employment record in\nMinnesota by the institution sector from which\nthey graduated", subtitle = "A significantly larger proportion of individuals graduating from a  college located\nin a border state or further away have no Minnesota employment record\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

### CTE Courses and Programming

It's no secret that career and technical education in high schools has received significantly more attention, and subsequently more investment and resources. It's always been believed that these investments lead to better outcomes in student retainment for rural regions. The analysis shows that this does seem to be true. Throughout the analysis, career and technical education courses and programming had one of the strongest relationships in whether an individual had meaningful employment somewhere in Southwest vs. other employment outcomes.

The chart below compares the total number of courses taken with each state of employment for all individuals that graduated from a high school in Southwest. For those not familiar with boxplots, the bottom side of the box is the 25th percentile of CTE courses taken in that employment state, the middle line is the median and the top line is the 75th percentile. What this chart tells us is that the 25th, median, mean, and 75th percentile of the number of CTE courses taken by individuals who have meaningful employment in Minnesota but not Southwest are significantly lower than the number taken by individuals with meaningful workforce participation in Southwest.

<br>

```{r cte achievement and no MN employment record}
data <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, cte.achievement) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:3) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, cte.achievement, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year, cte.achievement) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.1", "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, cte.achievement) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "No MN emp record, not attending ps"])) / 2) + sum(prop[states != "No MN emp record, not attending ps"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
    mutate(grad.year = str_replace(grad.year, "grad.year.10", "10 years after grad"),
           grad.year = str_replace(grad.year, "grad.year.5", "5 years after grad"),
         grad.year = str_replace(grad.year, "grad.year.1", "1 year after grad"),
         grad.year = fct_relevel(grad.year, "1 year after grad", "5 years after grad", "10 years after grad"),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps")) %>%
  filter(states == "No MN emp record, not attending ps") %>%
  mutate(cte.achievement = fct_relevel(cte.achievement, "No CTE", "CTE Participant", "CTE Concentrator or Completor"))

plot <- ggplot(data = data, aes(cte.achievement, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(y = prop / 2, label = paste(percent(prop, accuracy = 1), "\nN = ", comma(n), sep = "")), show.legend = FALSE, color = "white") +
  geom_hline(yintercept = 0, color = "black") +
  labs(x="", y = "", title = "Proportion of CTE Achievement that do not have a MN employment record\nparticipation in Southwest", subtitle = "A higher proportion of individuals with no CTE experience do not have a MN employment\nrecord") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18)) +
  coord_flip()


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

### Taking the ACT

Since the post-secondary pathway has an influence on whether an individual has meaningful workforce participation in Southwest, it's not surprising that whether an individual is preparing to go to college in high school also plays a role.

The chart below shows that nearly a third of individuals who did not take the ACT had meaningful workforce participation in southwest at five and ten years after graduating high school.

<br>

```{r took act and no MN employment record}
data <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, took.ACT) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:3) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, took.ACT, states) %>%
  summarize(n = n()) %>%
  ungroup()  %>%
  group_by(grad.year, took.ACT) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.1", "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, took.ACT) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "No MN emp record, not attending ps"])) / 2) + sum(prop[states != "No MN emp record, not attending ps"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
    mutate(grad.year = str_replace(grad.year, "grad.year.10", "10 years after grad"),
           grad.year = str_replace(grad.year, "grad.year.5", "5 years after grad"),
         grad.year = str_replace(grad.year, "grad.year.1", "1 year after grad"),
         grad.year = fct_relevel(grad.year, "1 year after grad", "5 years after grad", "10 years after grad"),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps")) %>%
  filter(states == "No MN emp record, not attending ps") %>%
    filter(grad.year != "1 year after grad") %>%
  mutate(took.ACT = ifelse(took.ACT == "No", "Did not\ntake ACT", "Took ACT"))
  
plot <- ggplot(data = data, aes(took.ACT, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(label = percent(prop, accuracy = 1)), show.legend = FALSE) +
  geom_label(aes(y = prop / 2, label = paste("N = ", comma(n), sep = "")), show.legend = FALSE, color = "white") +
  geom_label(aes(x = 2, y = .2, label = "Significantly\nhigher\nproportion"), show.legend = FALSE, color = "white") +
  geom_hline(yintercept = 0, color = "black") +
  labs(x="", y = "", title = "Proportion of individuals who did and did not take ACT that have\nmeaningful workforce participation in Minnesota but not Southwest", subtitle = "Taking the ACT was associated with higher proportions of individuals having\nmeaningful workforce participation in Southwest\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18)) 

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

### Fringe variables

This is where there are some interesting results. There were a number of variables that were associated with not having a MN employment record. 

<br>

#### Limited English Proficiency

A significantly higher proportion of individuals categorized as having limited english proficiency did not have a MN employment record, however these are not very large totals.

<br>

```{r limited english and no mn employment record}
data <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, LimitedEnglishProficiencyIndicator) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:3) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, LimitedEnglishProficiencyIndicator, states) %>%
  summarize(n = n()) %>%
  ungroup()  %>%
  group_by(grad.year, LimitedEnglishProficiencyIndicator) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.1", "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, LimitedEnglishProficiencyIndicator) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "No MN emp record, not attending ps"])) / 2) + sum(prop[states != "No MN emp record, not attending ps"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
    mutate(grad.year = str_replace(grad.year, "grad.year.10", "10 years after grad"),
           grad.year = str_replace(grad.year, "grad.year.5", "5 years after grad"),
         grad.year = str_replace(grad.year, "grad.year.1", "1 year after grad"),
         grad.year = fct_relevel(grad.year, "1 year after grad", "5 years after grad", "10 years after grad"),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps")) %>%
  filter(states == "No MN emp record, not attending ps") %>%
  mutate(LimitedEnglishProficiencyIndicator = ifelse(LimitedEnglishProficiencyIndicator == "Y", "Limited English", "English"))
  
plot <- ggplot(data = data, aes(LimitedEnglishProficiencyIndicator, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(label = percent(prop, accuracy = 1)), show.legend = FALSE) +
  geom_label(aes(y = prop / 2, label = paste("N = ", comma(n), sep = "")), show.legend = FALSE, color = "white") +
  geom_label(aes(x = 2, y = .1, label = "Significantly\nhigher\nproportion"), show.legend = FALSE, color = "white") +
  geom_hline(yintercept = 0, color = "black") +
  labs(x="", y = "", title = "Proportion of individuals who were categorized as having limited english\nproficiency and did not have MN employment record", subtitle = "A higher proportion of individuals having limited english proficiency did not have a MN\nemployment record\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18)) 

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  

```

<br>

#### Race and ethnicity

The chart below shows that BIPOC populations typically have higher proportions of individuals with no MN employment record up until 5 years after graduating high school. By ten years after high school, a higher proportion of hispanic and Asian/Pacific Islanders have no MN employment record.

<br>

```{r race and no mn employment record}
data <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, RaceEthnicity) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:3) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, RaceEthnicity, states) %>%
  summarize(n = n()) %>%
  ungroup()  %>%
  group_by(grad.year, RaceEthnicity) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.1", "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, RaceEthnicity) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "No MN emp record, not attending ps"])) / 2) + sum(prop[states != "No MN emp record, not attending ps"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
    mutate(grad.year = str_replace(grad.year, "grad.year.10", "10 years after grad"),
           grad.year = str_replace(grad.year, "grad.year.5", "5 years after grad"),
         grad.year = str_replace(grad.year, "grad.year.1", "1 year after grad"),
         grad.year = fct_relevel(grad.year, "1 year after grad", "5 years after grad", "10 years after grad"),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps")) %>%
  filter(states == "No MN emp record, not attending ps") 

plot <- ggplot(data = data, aes(RaceEthnicity, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(label = percent(prop, accuracy = 1)), show.legend = FALSE) +
  geom_label(aes(y = prop / 2, label = paste("N = ", comma(n), sep = "")), show.legend = FALSE, color = "white") +
  geom_hline(yintercept = 0, color = "black") +
  labs(x="", y = "", title = "Proportion of individuals within each Race or Ethnicity and did not\nhave MN employment record", subtitle = "A higher proportion of Asian/PI and Hispanic individuals did not have a MN\nemployment record\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1)) 

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  

```

<br>

#### EDR

The chart below shows that BIPOC populations typically have higher proportions of individuals with no MN employment record up until 5 years after graduating high school. By ten years after high school, a higher proportion of hispanic and Asian/Pacific Islanders have no MN employment record.

<br>

```{r edr and no mn employment record}
data <- master %>%
  select(grad.year.1, grad.year.5, grad.year.10, edr) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:3) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, edr, states) %>%
  summarize(n = n()) %>%
  ungroup()  %>%
  group_by(grad.year, edr) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup() %>%
  mutate(grad.year = fct_relevel(grad.year, "grad.year.1", "grad.year.5", "grad.year.10")) %>%
  group_by(grad.year, edr) %>%
  arrange(desc(states)) %>%
  mutate(yloc = ((1 - sum(prop[states != "No MN emp record, not attending ps"])) / 2) + sum(prop[states != "No MN emp record, not attending ps"]),
         cumsum = cumsum(prop),
         yloc.2 = ((cumsum - lag(cumsum)) / 2) + lag(cumsum)) %>%
  ungroup() %>%
    mutate(grad.year = str_replace(grad.year, "grad.year.10", "10 years after grad"),
           grad.year = str_replace(grad.year, "grad.year.5", "5 years after grad"),
         grad.year = str_replace(grad.year, "grad.year.1", "1 year after grad"),
         grad.year = fct_relevel(grad.year, "1 year after grad", "5 years after grad", "10 years after grad"),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps")) %>%
  filter(states == "No MN emp record, not attending ps") 

plot <- ggplot(data = data, aes(edr, prop, fill = states)) +
  facet_wrap(~grad.year) +
  geom_bar(stat = "identity", position = position_stack()) +
  geom_label(aes(label = percent(prop, accuracy = 1)), show.legend = FALSE) +
  geom_label(aes(y = prop / 2, label = paste("N = ", comma(n), sep = "")), show.legend = FALSE, color = "white") +
  geom_hline(yintercept = 0, color = "black") +
  labs(x="", y = "", title = "Proportion of individuals within each EDR and did not\nhave MN employment record", subtitle = "A higher proportion of individuals from regions on the border do not have a Minnesota\nemployment record\n") +
  scale_y_continuous(labels=scales::percent) +
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 2)) +
  theme_bar+
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1)) 

girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  

```

<br>

So what does this all translate into? It seems there are a couple of key pieces;

1. Individuals attending post-secondary out of state most likely find employment in that state after graduating.
2. BIPOC populations, in particular Hispanic, tend to not have MN employment records. This may be due to culture and their tendency to have a stay-at-home parent in the family. 
3. Individuals from the border EDRs likely feel the pull to attend college and find work across the border.

So, let's see what this looks like. We will start with the individuals that attend post-secondary out of state. We can what percentage of folks that attend post-secondary out-of-state on the percentage that do not have a MN employment record.

The chart below shows that a significantly higher proportion of individuals that graduate from a post-secondary institution located outside of Minnesota do not have a MN employment record at grad year 5 or 10. In fact, in grad year 5, over 1,000 people did not have a MN employment record, yet they graduated from a Southwest high school.

<br>

```{r ps location and do not have mn employment record}
data <- master %>%
  select(grad.year.5, grad.year.10, cte.achievement, ps.grad.InstitutionSector, ps.state, ps.pr) %>%
  mutate(ps.loc = ifelse(ps.pr == "Southwest", "Southwest", ps.pr),
         ps.loc = ifelse(ps.pr != "Southwest" & ps.state == "MN", "MN, outside SW", ps.loc),
         ps.loc = ifelse(ps.state %in% c("SD", "ND", "IA"), "Border state", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Never attended ps", "No college", ps.loc),
         ps.loc = ifelse(ps.grad.InstitutionSector == "Did not grad", "Some college", ps.loc),
         ps.loc = ifelse(!ps.state %in% c("MN", "SD", "ND", "IA") & !is.na(ps.state), "Far far away", ps.loc)) %>%
  filter(ps.loc %in% c("Border state", "Far far away")) %>%
  mutate(ps.loc == "PS out-of-state") %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps"),
         grad.year = fct_relevel(grad.year, "grad.year.5", "grad.year.10"))

plot <- ggplot(data, aes(states, pct, fill = states)) +
  facet_wrap(~grad.year) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(grad.year, "\nEmployment state: ", states, "\nNumber of individuals: ", comma(n), "\nPercent of individuals: ", percent(pct, accuracy = 1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  geom_text(aes(x = 4, y = .4, label = "Significantly\nhigher\nproportion"), show.legend = FALSE) +
  geom_text(aes(y = pct / 2, label = paste("N =\n", comma(n), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Percent share of individuals graduating from post-secondary\nout-of-state by employment state", subtitle = "A higher proportion of individuals that graduate from a post-secondary institution outside\nMinnesota do not have a MN employment record\n")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

The chart below shows the proportion of hispanic individuals by their employment state by 5 adn 10 years after graduating high school. It clearly shows that a higher proportion of hispanic individuals do not have a MN employment record.

<br>

```{r hispanic and states}
data <- master %>%
  select(grad.year.5, grad.year.10, RaceEthnicity) %>%
  filter(RaceEthnicity == "Hispanic") %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps"),
         grad.year = fct_relevel(grad.year, "grad.year.5", "grad.year.10"))

plot <- ggplot(data, aes(states, pct, fill = states)) +
  facet_wrap(~grad.year) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(grad.year, "\nEmployment state: ", states, "\nNumber of individuals: ", comma(n), "\nPercent of individuals: ", percent(pct, accuracy = 1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  geom_text(aes(x = 4, y = .25, label = "Significantly\nhigher\nproportion"), show.legend = FALSE) +
  geom_text(aes(y = pct / 2, label = paste("N =\n", comma(n), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Percent share of hispanic individuals by employment state", subtitle = "A higher proportion of hispanic individuals do not have a MN employment record\n")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = states.color,
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

Lastly, let's look at the proportion of individuals by EDR.

<br>

```{r edr and states}
data <- master %>%
  select(grad.year.5, grad.year.10, edr) %>%
  filter(edr %in% c("EDR 6W- Upper Minnesota Valley", "EDR 8 - Southwest")) %>%
  pivot_longer(names_to = "grad.year", values_to = "states", 1:2) %>%
  filter(states != "After 2019") %>%
  filter(states != "Attending ps") %>%
  group_by(grad.year, edr, states) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year, edr) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         states = fct_relevel(states, "Meaningful emp SW", "Meaningful emp MN", "Not meaningful, not attending ps", "No MN emp record, not attending ps"),
         grad.year = fct_relevel(grad.year, "grad.year.5", "grad.year.10"))

plot <- ggplot(data, aes(states, pct, fill = edr, group = edr)) +
  facet_wrap(~grad.year) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(grad.year, "\nEmployment state: ", states, "\nNumber of individuals: ", comma(n), "\nPercent of individuals: ", percent(pct, accuracy = 1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  geom_text(aes(x = 4, y = .25, label = "Significantly\nhigher\nproportion"), show.legend = FALSE) +
  geom_text(aes(y = pct / 2, label = paste("N =\n", comma(n), sep = "")), show.legend = FALSE) +
  labs(x="", y = "", color="", title = "Percent share of hispanic individuals by employment state", subtitle = "A higher proportion of hispanic individuals do not have a MN employment record\n")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "PuBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = 1))


girafe(ggobj = plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```




We are going to have to make some estimates here using multiple data sources. 

1. Use labor force percentages from DEED in the three EDRs.
2. Use percentage of federal government jobs using DEED data from the three EDRs.
3. Percentage use in ACS?
4. Post-secondary census data that Meredith gave me.

## Labor force participation

To estimate the labor force participation of this group I used the average labor force participation rate for;

1. each county in the three research EDRs from 2006 to 2019;
2. for each age cohort from 20 to 64 years old;
3. weighted by how the percentage of the population each age cohort was.

The average participation rate is 83%. Therefore, let's take 100% minus 83% and multiply that to the number of people that are in this category for each grad year. The table below provides the number of individuals estimated to be not participatin in the labor force for each grad year.

<br>

```{r no mn emp record not in lf}
lf.rate <- read_csv("Data/Labor force/Master-lf.csv") %>%
  group_by(age) %>%
  summarize(mean.lf.rate = mean(lf.rate)) %>%
  ungroup()

no.mn.emp.not.lf <- five.states %>%
  filter(five.states == "No MN emp record") %>%
  mutate(age = ifelse(grad.year %in% c("grad.year.0", "grad.year.1", "grad.year.2", "grad.year.3", "grad.year.4", "grad.year.5", "grad.year.6"), "20 to 24", "25 to 34")) %>%
  group_by(grad.year, age) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  left_join(lf.rate, by = c("age")) %>%
  mutate(not.lf = (1 - mean.lf.rate) * n,
         not.lf = round(not.lf)) %>%
  select(grad.year, age, n, mean.lf.rate, not.lf)

no.mn.emp.not.lf

```

<br>

## Estimates of individuals in military

Next, we will attempt to figure out how many of these people are likely in the military. To do this we will take the average percentage of each counties population in EDR 6E, 6W and 8 that were members of the armed forces and multiply that percentage by the remaining number of individuals in the "no MN employment record" category.

The table below provides the number of individuals estimated to be in the armed forces. It ranges from 1 to 4 people.

<br>

```{r n in military}
military <- read_csv("Data/Military/Master-military.csv") %>%
  group_by(countyfp) %>%
  summarize(mean.military.rate = mean(military.pct)) %>%
  ungroup() %>%
  left_join(counties.regions, by = "countyfp") %>%
  filter(edr %in% c("EDR 6W- Upper Minnesota Valley", "EDR 6E- Southwest Central", "EDR 8 - Southwest")) %>%
  summarize(military.pct = mean(mean.military.rate))

no.mn.emp.not.lf.military <- no.mn.emp.not.lf %>%
  mutate(military.pct = military$military.pct) %>%
  mutate(remaining = n - not.lf,
         n.military = remaining * military.pct,
         n.military = round(n.military)) 
  
no.mn.emp.not.lf.military
```

<br>

## Federal employment

Next, let's estimate how many individuals in this group may have federal employment and therefore, are not showing up as having an employment record or attending post-secondary. The table below provides the number of individuals estimated to be employed by the federal government, which ranges from 20 to 31 people each grad year.

<br>

```{r n federal workers}
fed <- read_csv("Data/Government/Master-fed-emp.csv") %>%
  group_by(countyfp) %>%
  summarize(mean.federal.rate = mean(fed.pct)) %>%
  ungroup() %>%
  left_join(counties.regions, by = "countyfp") %>%
  filter(edr %in% c("EDR 6W- Upper Minnesota Valley", "EDR 6E- Southwest Central", "EDR 8 - Southwest")) %>%
  summarize(fed.pct = mean(mean.federal.rate))

no.mn.emp.not.lf.military.fed <- no.mn.emp.not.lf.military %>%
  mutate(fed.pct = fed$fed.pct) %>%
  mutate(remaining = n - not.lf - n.military,
         n.fed = remaining * fed.pct,
         n.fed = round(n.fed)) 
  
no.mn.emp.not.lf.military.fed
```

<br>

## Working in another state

After subtracting the estimated number of individuals in this dataset that are serving in the armed forces, not participating in the labor force, or have federal positions, we are left with the following number of individuals for each grad year.

The bar chart below shows that a very large majority if individuals without a MN employment record or a post-secondary record are estimated to be working in another state.

<br>

```{r no mn emp record remaining}
data <- no.mn.emp.not.lf.military.fed %>%
  mutate(working.other.state = n - not.lf - n.military - n.fed,
         military.fed.notlf = n - working.other.state) %>%
  select(grad.year, n, working.other.state, military.fed.notlf) %>%
  pivot_longer(names_to = "no.mn.emp.record.category", values_to = "people", 3:4) %>%
  mutate(pct = people / n,
         data_id = seq(n()))

data.plot <- ggplot(data, aes(grad.year, pct, fill = no.mn.emp.record.category, group = no.mn.emp.record.category)) +
  geom_col_interactive(position = "stack", aes(data_id = data_id, tooltip = paste(no.mn.emp.record.category, "\nNumber of individuals: ", comma(people), "\nShare of individuals for this grad year: ", percent(pct, accuracy = 1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_stack()) +
  labs(x="", y = "", color="", title = "Percent share of individuals with no MN employment record")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18),
        axis.text.x = element_text(angle = 25, hjust = .9))


girafe(ggobj = data.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

In order to examine this group, let's figure out the percentage of individuals that fall into each of the employment states before having no employment record 5 years after graduating high school.

<br>

