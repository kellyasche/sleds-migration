---
title: "Employment"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
library(gmodels)
```

```{r themes and join docs, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))

regions = counties.regions %>%
  select(edr, planning.region) %>%
  distinct(edr, .keep_all = TRUE)

```

<br>

# Data prep

Now I'm going to prep the employment data in order to join with the master dataset. So, let's import the original data.

The dataset was exported as two separate spreadsheets due to the size. So I will import both and rbind them together.

<br>

```{r employment original}
employment.original.1 <- read_csv("Data/SLEDS/Employment/Employment.csv") %>%
  mutate(PersonID = as.integer(PersonID)) %>%
  select(1:23)

employment.original.2 <- read_csv("Data/SLEDS/Employment/Employment2a.csv") %>%
  mutate(PersonID = as.integer(PersonID)) 

employment.original <- employment.original.1 %>%
  rbind(employment.original.2) %>%
  drop_na(PersonID) %>%
  select(1:23)

head(employment.original)

names(employment.original)
```

<br>

In the original dataset we have `r employment.original %>% nrow()` rows and `r employment.original %>% ncol()` columns. Below is a description of each variable.

* Empl_TimeID: Last day of fiscal quarter
* CalendarYear: Year
* CalendarQuarter: Quarter within the year in which the data applies. Quarters are;
  + 1 = Jan - Mar
  + 2 = Apr - Jun
  + 3 = Jul - Sep
  + 4 = Oct - Dec
* EmploymentOrganizationID: An internal identification for each employer.
* EmployeeQuarterlyHoursWorked: The total number of hours worked by an employee at an employer's location during a specific calendar quarter
* EmployeeQuarterlyWages: The total wages earned by an employee at an employer's location during a specific calendar quarter
* EmployeeTenure: The total number of quarters a worker has been employeed by an organization at a specific location, up to an including the current calendar quarter
* IndustryID: Auto generated ID code for a record in the Industry dimension.
* USIndustryCode: Six-digit North American Industrial Classification System (NAICS) code
* GroupCode: Four-digit North American Industrial Classification System (NAICS) code
* IndustryGroup: Definition of GroupCode variable, the 4-digit NAICS code
* OwnershipCode: A classification system based upon the controlling interest of the establishment primarily designed to distinguish between governmental and non-governmental establishments
  + 10 = Federal government
  + 20 = State government
  + 30 = Local government
  + 50 = Private
* EmployerLocationTotalWagesPaid: The total wages paid to all workers employeed by an organization at a specific location during a specific calendar quarter
* QuarterlyAverageEmployment: The average number of workers employeed by an organization at a specific location during a specific calendar quarter
* LocationID: ???
* EconomicDevelopmentRegion: The 13 economic development regions within the state of Minnesota as defined by the Department of Employment and Economic Development (DEED).
  + R01000	EDR 1 - Northwest		
  + R02000	EDR 2 - Headwaters		
  + R03000	EDR 3 - Arrowhead		
  + R04000	EDR 4 - West Central		
  + R05000	EDR 5 - North Central		
  + R06E00	EDR 6E - Southwest Central		
  + R06W00	EDR 6W - Upper Minnesota Valley		
  + R07E00	EDR 7E - East Central		
  + R07W00	EDR 7W - Central		
  + R08000	EDR 8 - Southwest		
  + R09000	EDR 9 - South Central		
  + R10000	EDR 10 - Southeast
  + R11000	EDR 11 - 7 County Twin Cities
* EconomicDevelopmentRegionName: Name of EDR
* County: Minnesota county code to which this institution belongs. This can be used as a foreign key into the Geography dimension on MNCounty.
  + [Link to codes](https://sleds.mn.gov/dataDictionary/658)
* CountyName: The name of the county corresponding to the County and MNCounty Codes for this Location.
* MNCounty: County Code for this location as assigned by the state of Minnesota.
  + [Link to codes](https://sleds.mn.gov/dataDictionary/663)
City: All of the city data is NA

<br>

So all the previous datasets we structured and filtered so that each observation in the master dataset was an individual. We will want to continue to do the same. So we need to create an employment dataset with the following columns;

1. PersonID
2. Confirmation on whether PersonID in the master dataset has a MN employment record at graduation year, and grad year +2, +7, and +12
3. Confirmation on whether they were working at an employer with which they had "meaningful employment" at graduation year, and grad year +2, +7, and +12. 
4. Whether they had meaningful employment with an employer located in their high school county, edr, one of the research EDRs and in Minnesota at graduation year, and grad year +2, +7, and +12 years.
5. Whether they had meaningful employment with an employer in an industry that matches a CTE careercluster at grad year, grad year +2, +7, and +12. 

## Who has an employment record?

First, we want to figure out who from our master dataset has a MN employment record at each of the time instances being measured - graduation year, and graduation year +2, graduation year +7. Here are the columns I want when finished;

* PersonID has no MN employment record (Grad year, grad year +2, grad year +7)
    + No MN emp record - Has never worked in Minnesota
    + After 2019 - the grad year +X is after 2019.

<br>

```{r mn employment record}

grad.years <- read_csv("Data/SLEDS/Masters/Master-10.csv") %>%
  select(PersonID, hs.grad.year) %>%
  mutate(hs.grad.year.2 = hs.grad.year + 2,
         hs.grad.year.7 = hs.grad.year + 7) %>%
  gather(key = "hs.grad.year", value = "year", 2:4)

mn.emp.record.year <- employment.original %>%
  select(PersonID, CalendarYear) %>%
  distinct(PersonID, CalendarYear) %>%
  mutate(mn.emp.record = "MN emp record")

mn.emp.record <- grad.years %>%
  left_join(mn.emp.record.year, by = c("PersonID", "year" = "CalendarYear")) %>%
  mutate(mn.emp.record = ifelse(year > 2019, "After 2019", mn.emp.record),
         mn.emp.record = ifelse(is.na(mn.emp.record), "No MN emp record", mn.emp.record),
         label = paste("mn.emp.record.", hs.grad.year, sep = "")) %>%
  select(PersonID, label, mn.emp.record) %>%
  pivot_wider(names_from = label, values_from = mn.emp.record)

names(mn.emp.record)

head(mn.emp.record)
```

<br>

The dataset above provides each unique PersonID from our master list along with a confirmation column on whether they had a Minnesota employment record on graduation year, and graduation year +2 and +7. As expected, there are `r comma(nrow(mn.emp.record))` individuals that had an MN employment record in our master list.

<br>

## Filter for "meaningful" employment

The biggest issue is how do we get a meaningful indicator on whether they were employed in the region and whether they are employed in an industry that matches their CTE experience that wasn't just a "summer job". We need to filter out summer jobs between college years, as well as adapt to different paths that students take. 

We will define "meaningful employment" as an employment experience in which an individual works for one particular employer for 1,000 hours worked in any given year.

However, this isn't going to just be checking to see if an individual has worked at an employer for 1,000 hours at graduation year, grad year +2, grad year +7 and grad year +12. Rather, it's going to be checking on whether they are working at an employer at grad year, grad year +2, grad year +7 and grad year +12 for which they worked 1,000 hours for an given year.

For example, a person may be employed with an employer for a few years working full-time, but part-way through grad year +7, they decide to move on. I want to make sure we capture that that individual was employed in meaningful employment even though it wasn't full-time that particular year. 

The same can go the other way. Perhaps an individual just starts employment at grad year +7 but does work full-time with that particular employer form multiple years. We will want to count that as well.

In addition, I want to capture if someone is working at an employer but isn't quite "meaningful" but turns into meaningful later on. We will count that as well.

This will be a couple step process. 

1. First, we will filter out the employment.original data so that only meaningful employment for each PersonID is included along with the years worked at EmploymentOrganizationID.
2. Collect EmploymentOrganizationID for all the years that each PersonID worked meaningful employment.
3. Create a new datalist of each PersonID in the master datalist with grad year, grad year +2, and +7. 
4. Then, we will cross reference the grad year list with employment year to see if meaningful employment matches. 

We will end with the following columns and labels;

* PersonID has had meaningful employment since graduating high school (Grad year, grad year +2, grad year +7)
    + No MN emp record - Has no MN emp record
    + No meaningful emp - Has MN emp record but never
    + Meaningful emp - Has MN emp record and is meaningful
    + After 2019 - the grad year +X is after 2019.

<br>

```{r prep filter meaningful employment step 1}
meaningful.employer <- employment.original %>%
  group_by(PersonID, EmploymentOrganizationID, CalendarYear) %>%
  summarize(EmployeeQuarterlyHoursWorked = sum(EmployeeQuarterlyHoursWorked)) %>%
  ungroup() %>%
  group_by(PersonID) %>%
  filter(EmployeeQuarterlyHoursWorked > 999) %>%
  ungroup() %>%
  distinct(PersonID, EmploymentOrganizationID) %>%
  right_join(mn.emp.record[,c(1)], by = "PersonID")

head(meaningful.employer)

names(meaningful.employer)
```

<br>

This dataset has `r comma(nrow(meaningful.employer))` rows which represents an PersonID and  EmploymentOrganizationID with which they worked 1,000 or more hours had been worked in any given year of employment with that organization. Each PersonID is also in our master datalist.

Next, we need to make sure we are not missing any years in which a PersonID had meaningful employment with an OrganizationID but for other years they may not have been "meaningful".

<br>

```{r meaningful emp step 2}
meaningful.emp <- employment.original %>%
  select(PersonID, CalendarYear, EmploymentOrganizationID) %>%
  right_join(meaningful.employer, by = c("PersonID", "EmploymentOrganizationID")) %>%
  distinct(PersonID, EmploymentOrganizationID, CalendarYear)

names(meaningful.emp)

head(meaningful.emp)
```

<br>

After filling in any missing years where an PersonID may have had non-meaningful employment with an employer that they one time had/will have meaningful employment the data set grew to `r comma(nrow(meaningful.emp))` rows and `r comma(ncol(meaningful.emp))` columns.

Next, we want to collect the PersonID from the master datalist along with the graduation year, grad year +2,  and grad year +7. 

<br>

```{r grad years}
grad.years <- read_csv("Data/SLEDS/Masters/Master-10.csv") %>%
  select(PersonID, hs.grad.year) %>%
  mutate(hs.grad.year.2 = hs.grad.year + 2,
         hs.grad.year.7 = hs.grad.year + 7)

head(grad.years)
names(grad.years)

```

<br>

As expected, the dataset has `r comma(nrow(grad.years))` rows and `r comma(ncol(grad.years))` columns. 

Now, we will cross-reference these lists to confirm whether the PersonID from the grad.years datalist were working "meaningful employment" (as defined in above section) in each of grad year times.

<br>


```{r meaningful emp step 3}
meaningful.emp.grad.years <- grad.years %>%
  gather(key = "grad.years", value= "year", 2:4) %>%
  left_join(meaningful.emp, by = c("PersonID", "year" = "CalendarYear")) %>%
  mutate(EmploymentOrganizationID = ifelse(year > 2019, "After 2019", EmploymentOrganizationID)) %>%
  filter(!is.na(EmploymentOrganizationID)) %>%
  filter(EmploymentOrganizationID != "After 2019") %>%
  mutate(EmploymentOrganizationID = as.integer(EmploymentOrganizationID),
         meaningful.emp = "Yes")

names(meaningful.emp.grad.years)

head(meaningful.emp.grad.years)
```

<br>

The dataset above provides only PersonIDs that had meaningful employment for at least one hs.grad.year along with the EmploymentOrganizationID for which meaningful employment was gained. This leaves us with `r comma(nrow(meaningful.emp.grad.years))` rows. 

Now we want to merge this with all the PersonID from the master dataset so we end up with a list that has each PersonID, a column that represents grad year, and grad year +2 and +7, and confirmation on whether they had meaninful employment during those years.

```{r meainingful employment merge with master personid}
master.personid.meaningful.emp <- meaningful.emp.grad.years %>%
  select(PersonID, grad.years, meaningful.emp) %>%
  distinct(PersonID, grad.years) %>%
  mutate(meaningful.emp = "Meaningful emp") %>%
  right_join(grad.years[,c(1)], by = "PersonID") %>%
  complete(PersonID, grad.years, fill = list(meaningful.emp = "No meaningful emp")) %>%
  filter(!is.na(grad.years)) %>%
  mutate(label = paste("meaningful.emp.", grad.years, sep = "")) %>%
  select(PersonID, label, meaningful.emp) %>%
  pivot_wider(names_from = label, values_from = meaningful.emp) %>%
  left_join(mn.emp.record, by = "PersonID") %>%
  select(PersonID, 5,6,7,2,3,4) %>%
  mutate(meaningful.emp.hs.grad.year = ifelse(mn.emp.record.hs.grad.year == "No MN emp record", "No MN emp record", meaningful.emp.hs.grad.year),
         meaningful.emp.hs.grad.year = ifelse(mn.emp.record.hs.grad.year == "After 2019", "After 2019", meaningful.emp.hs.grad.year),
         meaningful.emp.hs.grad.year.2 = ifelse(mn.emp.record.hs.grad.year.2 == "No MN emp record", "No MN emp record", meaningful.emp.hs.grad.year.2),
         meaningful.emp.hs.grad.year.2 = ifelse(mn.emp.record.hs.grad.year.2 == "After 2019", "After 2019", meaningful.emp.hs.grad.year.2),
          meaningful.emp.hs.grad.year.7 = ifelse(mn.emp.record.hs.grad.year.7 == "No MN emp record", "No MN emp record", meaningful.emp.hs.grad.year.7),
         meaningful.emp.hs.grad.year.7 = ifelse(mn.emp.record.hs.grad.year.7 == "After 2019", "After 2019", meaningful.emp.hs.grad.year.7))

names(master.personid.meaningful.emp)

head(master.personid.meaningful.emp)
```


<br>

The dataset above provides each PersonID in our Master datalist along with a confirmation on whether they had meaningful employment on their graduation year, and grad year +2 and +7. As expected, there are `r comma(nrow(master.personid.meaningful.emp))` rows.

<br>


## Match meaningful employment and high school locations/regions.

Now, we want to determine if the locations of meaningful employment match the counties and regions from which they graduated high school. To do this, we will import the latest master dataset so we can compare their high school locations with meaningful employment locations.

Here are the columns and labels that I need;


* PersonID has had meaningful employment within the county/region (Grad year, grad year +2, grad year +7)
    + No MN emp record - has no MN employment record
    + No meaningful emp - Has MN emp record but not meaningful
    + No location match - Has MN emp record, had meaningful employment, but no match with region
    + Location match - Has MN emp record, had meaningful employment, and had meaningful employment in county/region
    + After 2019 - the grad year +X is after 2019

<br>

```{r match employment with hs regions}
emp.original.locations <- employment.original %>%
  select(PersonID, CalendarYear, EmploymentOrganizationID, EconomicDevelopmentRegionName, CountyName) %>%
  distinct(PersonID, CalendarYear, EmploymentOrganizationID, EconomicDevelopmentRegionName, CountyName) %>%
  rename(employment.county = CountyName,
         emp.edr = EconomicDevelopmentRegionName) %>%
  mutate(emp.edr = str_replace(emp.edr, "  ", " "),
         emp.edr = as.factor(emp.edr),
         employment.county = str_replace(employment.county, " County", ""),
         employment.county = str_replace(employment.county, "City of Duluth", "St. Louis"),
         employment.county = str_replace(employment.county, "Saint Louis", "St. Louis"),
         employment.county = str_replace(employment.county, "City of Minneapolis", "Hennepin"),
         employment.county = str_replace(employment.county, "City of St. Paul", "Ramsey"),
         employment.county = str_replace(employment.county, "White Earth Tribal Counci", "Mahnomen"),
         employment.county = as.factor(employment.county)) %>%
  left_join(counties.regions[,c(2,4)], by = c("employment.county" = "Name")) %>%
  rename(emp.Dem_Desc = Dem_Desc) 

meaningful.emp.locations <- meaningful.emp.grad.years %>%
  left_join(emp.original.locations, by = c("PersonID", "year" = "CalendarYear", "EmploymentOrganizationID")) %>%
  mutate(emp.edr = ifelse(employment.county == "Statewide (i.e. no fixed location)", "Unknown", as.character(emp.edr)),
         emp.Dem_Desc = ifelse(employment.county == "Statewide (i.e. no fixed location)", "Unknown", emp.Dem_Desc),
         emp.edr = ifelse(employment.county == "Hennepin", "EDR 11 - 7 County Twin Cities", emp.edr),
         emp.edr = ifelse(employment.county == "Ramsey", "EDR 11 - 7 County Twin Cities", emp.edr),
         emp.edr = ifelse(employment.county == "St. Louis", "EDR 3 - Arrowhead", emp.edr),
         emp.edr = ifelse(employment.county == "Unknown", "Unknown", emp.edr),
         emp.Dem_Desc = ifelse(employment.county == "Unknown", "Unknown", emp.Dem_Desc),
         emp.Dem_Desc = ifelse(employment.county == "NULL", "NULL", emp.Dem_Desc),
         emp.edr = ifelse(employment.county == "Mahnomen", "EDR 2 - Headwaters", emp.edr))

grad.locations <- read_csv("Data/SLEDS/Masters/Master-10.csv") %>%
  select(PersonID, county.name, Dem_Desc, edr) %>%
  rename(hs.county.name = county.name,
         hs.Dem_Desc = Dem_Desc,
         hs.edr = edr)

grad.emp.location.match <- grad.locations %>%
  right_join(meaningful.emp.locations, by = "PersonID") %>%
  mutate(county.match = ifelse(employment.county == hs.county.name, 1,
                               ifelse(employment.county %in%  c("Unknown", "Statewide (i.e. no fixed location)"), 0, -1)),
         edr.match = ifelse(emp.edr == hs.edr, 1,
                            ifelse(emp.edr == "Unknown", 0, -1)),
         region.match = ifelse(emp.edr %in% c("EDR 6W- Upper Minnesota Valley", "EDR 6E- Southwest Central", "EDR 8 - Southwest"), 1,
                               ifelse(emp.edr == "Unknown", 0, -1)),
         state.match = 1) %>%
  group_by() %>%
  group_by(PersonID, grad.years) %>%
  summarize(county.match = max(county.match),
         edr.match = max(edr.match),
         region.match = max(region.match),
         state.match = max(state.match)) %>%
  ungroup() %>%
  gather(key = "region.match", value = "confirm", 3:6) %>%
  mutate(confirm = ifelse(confirm == -1, "No location match",
                          ifelse(confirm == 0, "Unknown", "Location match")),
         grad.years.region.emp.match = paste(grad.years, ".", region.match, sep = "")) %>%
  select(PersonID, grad.years.region.emp.match, confirm) %>%
  pivot_wider(names_from = grad.years.region.emp.match, values_from = confirm, values_fill = "No meaningful employment") %>%
  select(PersonID, hs.grad.year.county.match, hs.grad.year.2.county.match, hs.grad.year.7.county.match, hs.grad.year.edr.match, hs.grad.year.2.edr.match, hs.grad.year.7.edr.match, hs.grad.year.region.match, hs.grad.year.2.region.match, hs.grad.year.7.region.match, hs.grad.year.state.match, hs.grad.year.2.state.match, hs.grad.year.7.state.match)

master.personid.grad.emp.location.match <- master.personid.meaningful.emp %>%
  left_join(grad.emp.location.match, by = "PersonID") %>%
  mutate(hs.grad.year.county.match = ifelse(mn.emp.record.hs.grad.year == "No MN emp record", "No MN emp record", hs.grad.year.county.match),
         hs.grad.year.county.match = ifelse(meaningful.emp.hs.grad.year == "No meaningful emp", "No meaningful emp", hs.grad.year.county.match),
         hs.grad.year.2.county.match = ifelse(mn.emp.record.hs.grad.year.2 == "No MN emp record", "No MN emp record", hs.grad.year.2.county.match),
         hs.grad.year.2.county.match = ifelse(meaningful.emp.hs.grad.year.2 == "No meaningful emp", "No meaningful emp", hs.grad.year.2.county.match),
         hs.grad.year.2.county.match = ifelse(mn.emp.record.hs.grad.year.2 == "After 2019", "After 2019", hs.grad.year.2.county.match),
         hs.grad.year.7.county.match = ifelse(mn.emp.record.hs.grad.year.7 == "No MN emp record", "No MN emp record", hs.grad.year.7.county.match),
         hs.grad.year.7.county.match = ifelse(meaningful.emp.hs.grad.year.7 == "No meaningful emp", "No meaningful emp", hs.grad.year.7.county.match),
         hs.grad.year.7.county.match = ifelse(mn.emp.record.hs.grad.year.7 == "After 2019", "After 2019", hs.grad.year.7.county.match),
         hs.grad.year.edr.match = ifelse(mn.emp.record.hs.grad.year == "No MN emp record", "No MN emp record", hs.grad.year.edr.match),
         hs.grad.year.edr.match = ifelse(meaningful.emp.hs.grad.year == "No meaningful emp", "No meaningful emp", hs.grad.year.edr.match),
         hs.grad.year.2.edr.match = ifelse(mn.emp.record.hs.grad.year.2 == "No MN emp record", "No MN emp record", hs.grad.year.2.edr.match),
         hs.grad.year.2.edr.match = ifelse(meaningful.emp.hs.grad.year.2 == "No meaningful emp", "No meaningful emp", hs.grad.year.2.edr.match),
         hs.grad.year.2.edr.match = ifelse(mn.emp.record.hs.grad.year.2 == "After 2019", "After 2019", hs.grad.year.2.edr.match),
         hs.grad.year.7.edr.match = ifelse(mn.emp.record.hs.grad.year.7 == "No MN emp record", "No MN emp record", hs.grad.year.7.edr.match),
         hs.grad.year.7.edr.match = ifelse(meaningful.emp.hs.grad.year.7 == "No meaningful emp", "No meaningful emp", hs.grad.year.7.edr.match),
         hs.grad.year.7.edr.match = ifelse(mn.emp.record.hs.grad.year.7 == "After 2019", "After 2019", hs.grad.year.7.edr.match),
         hs.grad.year.state.match = ifelse(mn.emp.record.hs.grad.year == "No MN emp record", "No MN emp record", hs.grad.year.state.match),
         hs.grad.year.state.match = ifelse(meaningful.emp.hs.grad.year == "No meaningful emp", "No meaningful emp", hs.grad.year.state.match),
         hs.grad.year.2.state.match = ifelse(mn.emp.record.hs.grad.year.2 == "No MN emp record", "No MN emp record", hs.grad.year.2.state.match),
         hs.grad.year.2.state.match = ifelse(meaningful.emp.hs.grad.year.2 == "No meaningful emp", "No meaningful emp", hs.grad.year.2.state.match),
         hs.grad.year.2.state.match = ifelse(mn.emp.record.hs.grad.year.2 == "After 2019", "After 2019", hs.grad.year.2.state.match),
         hs.grad.year.7.state.match = ifelse(mn.emp.record.hs.grad.year.7 == "No MN emp record", "No MN emp record", hs.grad.year.7.state.match),
         hs.grad.year.7.state.match = ifelse(meaningful.emp.hs.grad.year.7 == "No meaningful emp", "No meaningful emp", hs.grad.year.7.state.match),
         hs.grad.year.7.state.match = ifelse(mn.emp.record.hs.grad.year.7 == "After 2019", "After 2019", hs.grad.year.7.state.match),
         hs.grad.year.region.match = ifelse(mn.emp.record.hs.grad.year == "No MN emp record", "No MN emp record", hs.grad.year.region.match),
         hs.grad.year.region.match = ifelse(meaningful.emp.hs.grad.year == "No meaningful emp", "No meaningful emp", hs.grad.year.region.match),
         hs.grad.year.2.region.match = ifelse(mn.emp.record.hs.grad.year.2 == "No MN emp record", "No MN emp record", hs.grad.year.2.region.match),
         hs.grad.year.2.region.match = ifelse(meaningful.emp.hs.grad.year.2 == "No meaningful emp", "No meaningful emp", hs.grad.year.2.region.match),
         hs.grad.year.2.region.match = ifelse(mn.emp.record.hs.grad.year.2 == "After 2019", "After 2019", hs.grad.year.2.region.match),
         hs.grad.year.7.region.match = ifelse(mn.emp.record.hs.grad.year.7 == "No MN emp record", "No MN emp record", hs.grad.year.7.region.match),
         hs.grad.year.7.region.match = ifelse(meaningful.emp.hs.grad.year.7 == "No meaningful emp", "No meaningful emp", hs.grad.year.7.region.match),
         hs.grad.year.7.region.match = ifelse(mn.emp.record.hs.grad.year.7 == "After 2019", "After 2019", hs.grad.year.7.region.match))

names(master.personid.grad.emp.location.match)

head(master.personid.grad.emp.location.match)
```

<br>

After significant road blocks, we finally have a dataset that provides each PersonID in the master list that had meaningful employment and confirmations on whether the employer location matches the high school county, EDR, research region, or is in Minnesota. This confirmation is for each x-time of graduation year - graduation year, two years after graduation, and 7 years after graduation.

The final dataset gives us `r comma(nrow(grad.emp.location.match))` rows and `r comma(ncol(grad.emp.location.match))` columns.


## Match employment industry with career cluster

Next we need to find a way to compare the CTE careerclusters with the actual industry from which they work. We are not able to compare majors which is a bummer. But, the careerclusters from CTE coursework does align somewhat with NAICS codes. Here's what it looks like;

```{r career cluster and naics crosswalk table}
careercluster.naics.cw <- read_xlsx("Data/SLEDS/Employment/career-cluster-naics.xlsx") %>%
  rename(cw.CareerCluster = `Career cluster code`,
         cw.CareerClusterName = `Career Cluster`,
         cw.emp.ind.code = 3,
         cw.emp.ind.name = 4)


datatable(careercluster.naics.cw, class = "cell-border stripe", filter = "top", rownames = FALSE,
          options = list(columnDefs = list(list(className = "dt-center", targets = 1:3)))) 

```

There is one industry in which two career clusters will have to be marged - Human Services and Health Science & Health Occupations. Due to this, we will create a new column with an "updated" careercluster code that includes the merged cluster.

Here are the columns and labels that I will use;

* PersonID has had meaningful employment in industry from a CTE course taken (Grad year, grad year +2, grad year +7)
    + No MN emp record - has no MN employment record
    + No meaningful emp - Has MN emp record nut not meaningful
    + No ind match - Has MN emp record, was meaningful, but industry does not match CTE course taken
    + Ind match - Has MN emp record, was meaningful, and industry and cTE course match.
    + After 2019 - the grad year +X is after 2019

Step 1 is to determine the industry codes for each PersonID that experienced meaningful employment for each of their "grad years".

<br>

```{r emp ind match step 1}
emp.original.for.cw <- employment.original %>%
  select(PersonID, CalendarYear, EmploymentOrganizationID, GroupCode) %>%
  distinct(PersonID, CalendarYear, EmploymentOrganizationID, GroupCode) 

cc.cw.meaningful.emp <- meaningful.emp.grad.years %>%
  left_join(emp.original.for.cw, by = c("PersonID", "EmploymentOrganizationID", "year" = "CalendarYear")) %>%
  mutate(ind.code = ifelse(GroupCode == "6215", "6215", str_sub(GroupCode, 1, 2)),
         ind.code = as.integer(ind.code)) %>%
  left_join(careercluster.naics.cw, by = c("ind.code" = "cw.emp.ind.code"))


head(cc.cw.meaningful.emp)

names(cc.cw.meaningful.emp)
```

<br>

The dataset above provides each of the meaningful employment instances during the grad years for each PersonID in the master dataset along with the GroupCode and matching CTE careercluster crosswalk for each of those employment instances. There are `r comma(nrow(cc.cw.meaningful.emp))` rows/instances with `r comma(ncol(cc.cw.meaningful.emp))` columns.

Step 2 is to  merge each PersonID's cte courses taken. with the meaningful employment dataset so we can compare if the CTE courses match the industries.


<br>

```{r emp ind match step 2}
grad.cc <- read_csv("Data/SLEDS/Masters/Master-10.csv") %>%
  select(PersonID, 20:39) %>%
  gather(key = "cte", value = "n.courses", 2:21) %>%
  mutate(cte = str_sub(cte, 5, 6),
         cte = as.integer(cte),
         cte.cw = ifelse(cte %in% c(10, 11), "10 & 11", cte)) %>%
  filter(n.courses > 0) %>%
  select(PersonID, cte.cw, n.courses)

grad.cc.cw.naics <- cc.cw.meaningful.emp %>%
  left_join(grad.cc, by = "PersonID") %>%
  mutate(cc.ind.match = ifelse(is.na(n.courses), -1,
                               ifelse(cw.CareerCluster == cte.cw, 1, 0)),
         cc.ind.match = ifelse(ind.code == 54, 1, cc.ind.match)) %>%
  group_by(PersonID, grad.years) %>%
  summarize(max.match = max(cc.ind.match)) %>%
  ungroup() %>%
  mutate(cc.ind.match = ifelse(max.match == -1, "No CTE",
                               ifelse(max.match == 0, "No ind match", "Ind match")),
         cc.ind.match = ifelse(is.na(cc.ind.match), "No crosswalk", cc.ind.match)) %>%
  select(PersonID, grad.years, cc.ind.match) %>%
  complete(PersonID, grad.years) %>%
  mutate(label = paste("ind.match.", grad.years, sep = "")) %>%
  select(PersonID, label, cc.ind.match) %>%
  pivot_wider(names_from = label, values_from = cc.ind.match)

master.personid.grad.cc.cw.naics <- master.personid.grad.emp.location.match %>%
  left_join(grad.cc.cw.naics, by = "PersonID") %>%
  mutate(ind.match.hs.grad.year = ifelse(mn.emp.record.hs.grad.year == "No MN emp record", "No MN emp record", ind.match.hs.grad.year),
         ind.match.hs.grad.year = ifelse(mn.emp.record.hs.grad.year == "After 2019", "After 2019", ind.match.hs.grad.year),
         ind.match.hs.grad.year = ifelse(meaningful.emp.hs.grad.year == "No meaningful emp", "No meaningful emp", ind.match.hs.grad.year),
         ind.match.hs.grad.year.2 = ifelse(mn.emp.record.hs.grad.year.2 == "No MN emp record", "No MN emp record", ind.match.hs.grad.year.2),
         ind.match.hs.grad.year.2 = ifelse(mn.emp.record.hs.grad.year.2 == "After 2019", "After 2019", ind.match.hs.grad.year.2),
         ind.match.hs.grad.year.2 = ifelse(meaningful.emp.hs.grad.year.2 == "No meaningful emp", "No meaningful emp", ind.match.hs.grad.year.2),
         ind.match.hs.grad.year.7 = ifelse(mn.emp.record.hs.grad.year.7 == "No MN emp record", "No MN emp record", ind.match.hs.grad.year.7),
         ind.match.hs.grad.year.7 = ifelse(mn.emp.record.hs.grad.year.7 == "After 2019", "After 2019", ind.match.hs.grad.year.7),
         ind.match.hs.grad.year.7 = ifelse(meaningful.emp.hs.grad.year.7 == "No meaningful emp", "No meaningful emp", ind.match.hs.grad.year.7))


names(master.personid.grad.cc.cw.naics)

head(master.personid.grad.cc.cw.naics)
```

<br>

The dataset above provides each PersonID with meaningful employment in the master dataset and whether they took a CTE course that matches the industry in which they worked at any of the grad years. There are `r comma(nrow(grad.cc.cw.naics))` rows and `r comma(ncol(grad.cc.cw.naics))` columns.

```{r merge with master}
master.10 <- read_csv("Data/SLEDS/Masters/Master-10.csv")

master.11 <- master.10 %>%
  left_join(master.personid.grad.cc.cw.naics, by = "PersonID")

```


<br>

# Summary - MN employment record{.tabset}

We will first summarize the number of individuals that had MN employment records.

The chart below provides the percentage of individuals in the master dataset that had a MN employment record during their graduation year, grad year plus two years, and grad year plus seven years.

It shows that over 75% of the individuals had a MN employment record at their graduation year. That percentage drops to 63% two years after graduation and only 30% had a MN employment record 7 years after graduation. This small percentage is due to over half of the individuals would be after 2019 (last year of data available) at 7 years after graduation. The individuals with no MN employment record either means they are not working that year or are in another state.

<br>

```{r mn employment record total}
summary.mn.emp.record.total <- master.11 %>%
  select(PersonID, mn.emp.record.hs.grad.year, mn.emp.record.hs.grad.year.2, mn.emp.record.hs.grad.year.7) %>%
  gather(key = "grad.year", value = "mn.emp.record", 2:4) %>%
  group_by(grad.year, mn.emp.record) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  complete(grad.year, mn.emp.record, fill = list(n = 0, pct = 0)) %>%
  mutate(data_id = as.character(seq(n())),
         grad.year = ifelse(grad.year == "mn.emp.record.hs.grad.year", "Grad year",
                            ifelse(grad.year == "mn.emp.record.hs.grad.year.2", "Grad year + 2", "Grad year +7")))

summary.mn.emp.record.total.plot <- ggplot(summary.mn.emp.record.total, aes(grad.year, pct, fill = mn.emp.record, group = mn.emp.record)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(grad.year, "\n", mn.emp.record, "\nPercent: ", percent(pct, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Percent with MN employment record by year after graduation")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))


girafe(ggobj = summary.mn.emp.record.total.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

Let's see if percentages change much across EDRs.

The crosstabs indicated a strong relationship between EDRs and the percentage of individuals that have a MN employment record. 

Here are the highlights in differences;

* grad.year: EDR 6E has a significantly higher number of individuals with a MN employment record at the year of graduation than expected: 11,323 vs. 10,914 expected.
* grad.year.2: EDR 6E has a significantly higher percentage of individuals with a MN employment record at year of graduation plus two years: 68% vs. 62% and 60%. 
* grad.year.7: EDR 6E has a significantly lower percentage of individuals with no MN employent record: 12% vs. 15% and 17% for the other EDRs. EDR 8 has a significantly lower percentage of individuals with a MN employment record: 26% vs. 30% and 33% for the other EDRs.

<br>

## EDR chart

```{r mn employment record edr}
summary.mn.emp.record.edr <- master.11 %>%
  select(PersonID, edr, mn.emp.record.hs.grad.year, mn.emp.record.hs.grad.year.2, mn.emp.record.hs.grad.year.7) %>%
  gather(key = "grad.year", value = "mn.emp.record", 3:5) %>%
  group_by(grad.year, edr, mn.emp.record) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(edr, grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  complete(edr, grad.year, mn.emp.record, fill = list(n = 0, pct = 0)) %>%
  mutate(data_id = as.character(seq(n())),
         grad.year = ifelse(grad.year == "mn.emp.record.hs.grad.year", "Grad year",
                            ifelse(grad.year == "mn.emp.record.hs.grad.year.2", "Grad year + 2", "Grad year +7")))

summary.mn.emp.record.edr.plot <- ggplot(summary.mn.emp.record.edr, aes(grad.year, pct, fill = mn.emp.record, group = mn.emp.record)) +
  facet_wrap(~edr, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(grad.year, "\n", mn.emp.record, "\nPercent: ", percent(pct, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Percent with MN employment record by year after graduation")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))


girafe(ggobj = summary.mn.emp.record.edr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```


<br>

## EDR cross-tabs

<br>

```{r mn emp record summary edr crosstabs}
summary.mn.emp.record.ct.edr <- master.11 %>%
  select(edr, mn.emp.record.hs.grad.year, mn.emp.record.hs.grad.year.2, mn.emp.record.hs.grad.year.7) %>%
  gather(key = "grad.year", value = "mn.emp.record", 2:4) %>%
  mutate(edr = str_sub(edr, 1, 6)) %>%
  mutate(grad.year = as.factor(grad.year),
         edr = as.factor(edr),
         mn.emp.record = as.factor(mn.emp.record))

summary.mn.emp.record.grad.year.ct.edr <- summary.mn.emp.record.ct.edr %>%
  filter(grad.year == "mn.emp.record.hs.grad.year")

CrossTable(summary.mn.emp.record.grad.year.ct.edr$edr, summary.mn.emp.record.grad.year.ct.edr$mn.emp.record, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

summary.mn.emp.record.grad.year.2.ct.edr <- summary.mn.emp.record.ct.edr %>%
  filter(grad.year == "mn.emp.record.hs.grad.year.2")

CrossTable(summary.mn.emp.record.grad.year.2.ct.edr$edr, summary.mn.emp.record.grad.year.2.ct.edr$mn.emp.record, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

summary.mn.emp.record.grad.year.7.ct.edr <- summary.mn.emp.record.ct.edr %>%
  filter(grad.year == "mn.emp.record.hs.grad.year.7")

CrossTable(summary.mn.emp.record.grad.year.7.ct.edr$edr, summary.mn.emp.record.grad.year.7.ct.edr$mn.emp.record, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

```

<br>

# {.unnumbered .unlisted .toc-ignore .tabset}

Next let's break it down by RUCA category.

The cross tabs indicate a relationship between RUCA category and percentage of individuals that have a MN employment record for each graduation year timeframe. 

* Grad year: Entirely rural counties have a significantly lower percentage of individuals with a MN employment record at the time of graduation: 73% vs. 79% and 78% for the other EDRs.
* Grad year plus two: entirely rural have a significantly lower percentabe of individuals with a MN employment record two years after graduation: 60% vs. 64% and 63% for other EDRs. In addition, entirely rural have a significantly higher percentage of individuals with no MN employment record two years after graduation: 26% vs. 20% and 21%.
* Grad year plus 7: Entirely rural counties have a significantly higher percentage of individuals with no MN employment record seven years after graduation: 17% vs. 14% for other RUCA categories.



<br>

## RUCA chart

<br>

```{r mn employment record ruca}
summary.mn.emp.record.ruca <- master.11 %>%
  select(PersonID, Dem_Desc, mn.emp.record.hs.grad.year, mn.emp.record.hs.grad.year.2, mn.emp.record.hs.grad.year.7) %>%
  gather(key = "grad.year", value = "mn.emp.record", 3:5) %>%
  group_by(grad.year, Dem_Desc, mn.emp.record) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(Dem_Desc, grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  complete(Dem_Desc, grad.year, mn.emp.record, fill = list(n = 0, pct = 0)) %>%
  mutate(data_id = as.character(seq(n())),
         grad.year = ifelse(grad.year == "mn.emp.record.hs.grad.year", "Grad year",
                            ifelse(grad.year == "mn.emp.record.hs.grad.year.2", "Grad year + 2", "Grad year +7")))

summary.mn.emp.record.ruca.plot <- ggplot(summary.mn.emp.record.ruca, aes(grad.year, pct, fill = mn.emp.record, group = mn.emp.record)) +
  facet_wrap(~Dem_Desc, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(grad.year, "\n", mn.emp.record, "\nPercent: ", percent(pct, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Percent with MN employment record by year after graduation")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))


girafe(ggobj = summary.mn.emp.record.ruca.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

## RUCA cross-tabs

<br>

```{r mn emp record summary ruca crosstabs}
summary.mn.emp.record.ct.ruca <- master.11 %>%
  select(Dem_Desc, mn.emp.record.hs.grad.year, mn.emp.record.hs.grad.year.2, mn.emp.record.hs.grad.year.7) %>%
  gather(key = "grad.year", value = "mn.emp.record", 2:4) %>%
  mutate(Dem_Desc = str_sub(Dem_Desc, 1, 6)) %>%
  mutate(grad.year = as.factor(grad.year),
         Dem_Desc = as.factor(Dem_Desc),
         mn.emp.record = as.factor(mn.emp.record))

summary.mn.emp.record.grad.year.ct.ruca <- summary.mn.emp.record.ct.ruca %>%
  filter(grad.year == "mn.emp.record.hs.grad.year")

CrossTable(summary.mn.emp.record.grad.year.ct.ruca$Dem_Desc, summary.mn.emp.record.grad.year.ct.ruca$mn.emp.record, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

summary.mn.emp.record.grad.year.2.ct.ruca <- summary.mn.emp.record.ct.ruca %>%
  filter(grad.year == "mn.emp.record.hs.grad.year.2")

CrossTable(summary.mn.emp.record.grad.year.2.ct.ruca$Dem_Desc, summary.mn.emp.record.grad.year.2.ct.ruca$mn.emp.record, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

summary.mn.emp.record.grad.year.7.ct.ruca <- summary.mn.emp.record.ct.ruca%>%
  filter(grad.year == "mn.emp.record.hs.grad.year.7")

CrossTable(summary.mn.emp.record.grad.year.7.ct.ruca$Dem_Desc, summary.mn.emp.record.grad.year.7.ct.ruca$mn.emp.record, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

```

<br>


# Summary - meaningful employment

First, let's check to see what percentage of individuals in the dataset had "meaningful" employment. This is defined as and individual having worked for an employer for 1,000 or more hours in any given year with that employer.

The table below shows that the percentage of individuals working meaningful employment peaked two years after graduation with 30%. A third of individuals didn't have meaninful employment two years after graduation. 

<br>

```{r summary meaningful emp total}
summary.meaningful.emp.total <- master.11 %>%
  select(PersonID, meaningful.emp.hs.grad.year, meaningful.emp.hs.grad.year.2, meaningful.emp.hs.grad.year.7) %>%
  gather(key = "grad.year", value = "meaningful.emp", 2:4) %>%
  group_by(grad.year, meaningful.emp) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  complete(grad.year, meaningful.emp, fill = list(n = 0, pct = 0)) %>%
  mutate(data_id = as.character(seq(n())),
         grad.year = ifelse(grad.year == "meaningful.emp.hs.grad.year", "Grad year",
                            ifelse(grad.year == "meaningful.emp.hs.grad.year.2", "Grad year + 2", "Grad year +7")))

summary.meaningful.emp.total.plot <- ggplot(summary.meaningful.emp.total, aes(grad.year, pct, fill = meaningful.emp, group = meaningful.emp)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(grad.year, "\n", meaningful.emp, "\nPercent: ", percent(pct, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Percent with meaningful employment by year after graduation")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))


girafe(ggobj = summary.meaningful.emp.total.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  



```

<br>

# {.unnumbered .unlisted .toc-ignore .tabset}

Next, let's check to see if there are any differences in the percentages by the EDR of their high school.

The crosstabs indicate a relationship between EDR and the percentage of individuals with meaningful employment at each time frame.

* Grad year: EDR 6E has a significantly higher percentage of individuals with meaningful employment the year of their graduation: 22% vs. 19% and 18%.
* Grad year plus two: EDR 6E has a significantly higher percentage of individuals with meaningful employment two years after graduation: 33% vs. 29% and 27% for the other EDRs. EDR 6E also has a significantly lower percentage of indi viduals with no employment record: 17% vs. 22% and 24% for the other EDRs.
* Grad year plus seven: EDR 6E has a significantly higher percentage of individuals with meaningful employment seven years after graduation: 28% vs. 25% and 22% for the other EDRs. It also has a significantly lower percentage of individuals with no MN employment record: 12% vs. 15% and 17% for the other EDRs. 

<br>

## Table - PCT

```{r summary meaningful emp EDR}
summary.meaningful.emp.edr <- master.11 %>%
  select(edr, meaningful.emp.hs.grad.year, meaningful.emp.hs.grad.year.2, meaningful.emp.hs.grad.year.7) %>%
  gather(key = "grad.year", value = "meaningful.emp", 2:4) %>%
  group_by(edr, grad.year, meaningful.emp) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(edr, grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  complete(grad.year, meaningful.emp, fill = list(n = 0, pct = 0)) %>%
  mutate(data_id = as.character(seq(n())),
         grad.year = ifelse(grad.year == "meaningful.emp.hs.grad.year", "Grad year",
                            ifelse(grad.year == "meaningful.emp.hs.grad.year.2", "Grad year + 2", "Grad year +7")))

summary.meaningful.emp.edr.plot <- ggplot(summary.meaningful.emp.edr, aes(grad.year, pct, fill = meaningful.emp, group = meaningful.emp)) +
  facet_wrap(~edr, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(grad.year, "\n", meaningful.emp, "\nPercent: ", percent(pct, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Percent with meaningful employment by year after graduation")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))


girafe(ggobj = summary.meaningful.emp.edr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  

```


<br>

## Crosstabs

<br>

```{r summary meaningful emp crosstabs edr}
CrossTable(master.11$edr, master.11$meaningful.emp.hs.grad.year, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(master.11$edr, master.11$meaningful.emp.hs.grad.year.2, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(master.11$edr, master.11$meaningful.emp.hs.grad.year.7, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>

# {.unnumbered .unlisted .toc-ignore .tabset}

Next lets check to see what this looks like by RUCA category.

The cross tabs indicate a relationship between the RUCA category and percentage of individuals that have menaingful employment at each time frame.

* Grad year: town/rural mix have a significantly higher percentage of individuals with meaningful employment at the time of graduation: 21% vs. 16% and 18% for the other categories. Entirely rural also has a significantly higher percentage of individuals with no MN employent record compared to the other RUCA categories: 26% vs. 21% and 22% for other RUCA categories.
* Grad year plus two: Entirely rural has a significantly lower percentage of individuals with meaningful employment two years after graduation: 26% vs. 30% and 29% for the other RUCA categories. Entirely rural also has a significantly higher percentage of individuals with no MN employment record: 26% vs. 20% and 21% for other categories.
* Grad year plus seven: Entirely rural counties have a significantly lower percentage of individuals where meaningful employment would be measured after 2019: 52% vs. 57% and 56% for other RUCA categoies. In addition, entirely rural has a higher percentage of individuals with no MN employment record seven years after graduation: 17% vs. 14% for other RUCA categories.

<br>

## RUCA - chart

<br>

```{r summary meaningful emp ruca}
summary.meaningful.emp.ruca <- master.11 %>%
  select(Dem_Desc, meaningful.emp.hs.grad.year, meaningful.emp.hs.grad.year.2, meaningful.emp.hs.grad.year.7) %>%
  gather(key = "grad.year", value = "meaningful.emp", 2:4) %>%
  group_by(Dem_Desc, grad.year, meaningful.emp) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(Dem_Desc, grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  complete(grad.year, meaningful.emp, fill = list(n = 0, pct = 0)) %>%
  mutate(data_id = as.character(seq(n())),
         grad.year = ifelse(grad.year == "meaningful.emp.hs.grad.year", "Grad year",
                            ifelse(grad.year == "meaningful.emp.hs.grad.year.2", "Grad year + 2", "Grad year +7")))

summary.meaningful.emp.ruca.plot <- ggplot(summary.meaningful.emp.ruca, aes(grad.year, pct, fill = meaningful.emp, group = meaningful.emp)) +
  facet_wrap(~Dem_Desc, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(grad.year, "\n", meaningful.emp, "\nPercent: ", percent(pct, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "black", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Percent with meaningful employment by year after graduation")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 5, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 16),
        axis.text.x = element_text(angle = 25, hjust = .9))


girafe(ggobj = summary.meaningful.emp.ruca.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))  

```

<br>

## RUCA - Cross tabs

<br>

```{r summary meaningful emp crosstabs ruca}

CrossTable(master.11$Dem_Desc, master.11$meaningful.emp.hs.grad.year, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(master.11$Dem_Desc, master.11$meaningful.emp.hs.grad.year.2, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(master.11$Dem_Desc, master.11$meaningful.emp.hs.grad.year.7, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```


<br>

# Summary - matching employment locations and high school locations

First we will summarize the percentage of students that had an employment instance in a location that matches their high school graduation. We will only use PersonID that had meaningful employment for the following summaries.

We will begin with counties, then look at EDR, planning region, employed within Minnesota, and then by RUCA categories.

<br>

## High school grad and employment instance match{.tabset}

First, let's look what percentage of individuals had an employment instance where the employer was located in the same county as their high school.

The table below shows that 12.4% of the individuals in the master dataset had meaningful employment in the same county as their high school the year they graduated. It increased to 17.3% two years after graduation but then 19.7% seven years after graduation. These percentages are after filtering out all of the "After 2019" category.


<br>

```{r pct employed in county}
match.region.summary.total.county <- master.11 %>%
  select(PersonID, hs.grad.year.county.match, hs.grad.year.2.county.match, hs.grad.year.7.county.match) %>%
  gather(key = "hs.grad.year", value = "county.match", 2:4) %>%
  filter(county.match != "After 2019") %>%
  group_by(hs.grad.year, county.match) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(hs.grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         hs.grad.year = str_sub(hs.grad.year, 1, 14),
         hs.grad.year = str_replace(hs.grad.year, "hs.grad.year.c", "hs.grad.year"))

match.region.summary.total.county.plot <- ggplot(match.region.summary.total.county, aes(hs.grad.year, pct, fill = county.match, group = county.match)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(hs.grad.year, "\nEmployment match high school county? - ", county.match, sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  coord_flip() +
  labs(x="", y = "", color="", title = "Percent of individuals with meaningful employment in high school county")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = match.region.summary.total.county.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

  

```

<br>

Let's see if there are any differences in these percentages by EDR.

The crosstabs below indicate a relationship between EDR and the percentabe of individuals with meaningful employment in their high school county.

* hs.grad.year: EDR 6E has a significantly higher number of individuals with employment in their high school county than expected - 1,985 vs. 1,724 expected. EDR 6W had significantly less - 714 vs. 911 expected.
* hs.grad.year.2: EDR 6E has significantly higher number with employment in their high school than expected - 2,368 vs. 2,035 expected. EDR 6W significantly less.
* grad.year.7: EDR 6W has significantly less than expected.

<br>

### EDR - Chart pct

<br>

```{r summary chart employed in county by edr}

match.region.summary.total.county.edr <- master.11 %>%
  select(edr, hs.grad.year.county.match, hs.grad.year.2.county.match, hs.grad.year.7.county.match) %>%
  gather(key = "hs.grad.year", value = "county.match", 2:4) %>%
  filter(county.match != "After 2019") %>%
  group_by(edr, hs.grad.year, county.match) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(edr, hs.grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         hs.grad.year = str_sub(hs.grad.year, 1, 14),
         hs.grad.year = str_replace(hs.grad.year, "hs.grad.year.c", "hs.grad.year"))

match.region.summary.total.county.edr.plot <- ggplot(match.region.summary.total.county.edr, aes(hs.grad.year, pct, fill = county.match, group = county.match)) +
  facet_wrap(~edr, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(edr, "\n", hs.grad.year, "\nEmployment match high school county? - ", county.match, sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  coord_flip() +
  labs(x="", y = "", color="", title = "Percent of individuals with meaningful employment in high school county")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = match.region.summary.total.county.edr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE)) 


```

<br>

### EDR - Crosstabs

<br>

```{r summary cross tabs employed in county by edr}
summary <- master.11 %>%
  mutate(edr = str_sub(edr, 1,6))

summary.2 <- master.11 %>%
  mutate(edr = str_sub(edr, 1, 6)) %>%
  filter(hs.grad.year.2.county.match != "After 2019")

summary.7 <- master.11 %>%
  mutate(edr = str_sub(edr, 1, 6)) %>%
  filter(hs.grad.year.7.county.match != "After 2019")

CrossTable(summary$edr, summary$hs.grad.year.county.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(summary.2$edr, summary.2$hs.grad.year.2.county.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(summary.7$edr, summary.7$hs.grad.year.7.county.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>

## {.unnumbered .unlisted .toc-ignore .tabset}

Next, let's check the differences by RUCA category.

Crosstabs indicate a relationship.

* hs.grad.year: Entirely rural has a significantly lower number of individuals employed in their high school county than expected - 476 vs. 684 expected. Town/rural mix has significantly higher.
* hs.grad.year.2: entirely rural lower and town/rural mix higher.
* hs.grad.year.7: not as big of a difference.

<br>

### RUCA - Chart pct

<br>

```{r summary chart employed in county by ruca}

match.region.summary.total.county.ruca <- master.11 %>%
  select(Dem_Desc, hs.grad.year.county.match, hs.grad.year.2.county.match, hs.grad.year.7.county.match) %>%
  gather(key = "hs.grad.year", value = "county.match", 2:4) %>%
  filter(county.match != "After 2019") %>%
  group_by(Dem_Desc, hs.grad.year, county.match) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(Dem_Desc, hs.grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         hs.grad.year = str_sub(hs.grad.year, 1, 14),
         hs.grad.year = str_replace(hs.grad.year, "hs.grad.year.c", "hs.grad.year"))

match.region.summary.total.county.ruca.plot <- ggplot(match.region.summary.total.county.ruca, aes(hs.grad.year, pct, fill = county.match, group = county.match)) +
  facet_wrap(~Dem_Desc, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(Dem_Desc, "\n", hs.grad.year, "\nEmployment match high school county? - ", county.match, sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  coord_flip() +
  labs(x="", y = "", color="", title = "Percent of individuals with meaningful employment in high school county")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = match.region.summary.total.county.ruca.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE)) 


```

<br>

### EDR - Crosstabs

<br>

```{r summary cross tabs employed in county by ruca}


CrossTable(summary$Dem_Desc, summary$hs.grad.year.county.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(summary.2$Dem_Desc, summary.2$hs.grad.year.2.county.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(summary.7$Dem_Desc, summary.7$hs.grad.year.7.county.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)
```

<br>


## EDR grad location and employment match{.tabset}

Now we will summarize the number of individuals had meaningful employment in the same EDR as their high school the year of graduation, two years after graduating, and seven years after graduating.

The chart below shows that 14.8% of individuals in the dataset had meaningful employment in the same EDR as their high school the year of graduating. It increased to 22.4% of individuals two years after graduating and 27.4% of individuals seven years after graduating.

<br>

```{r edr employment match total}
match.region.summary.total.edr <- master.11 %>%
  select(PersonID, hs.grad.year.edr.match, hs.grad.year.2.edr.match, hs.grad.year.7.edr.match) %>%
  gather(key = "hs.grad.year", value = "edr.match", 2:4) %>%
  filter(edr.match != "After 2019") %>%
  group_by(hs.grad.year, edr.match) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(hs.grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         hs.grad.year = str_sub(hs.grad.year, 1, 14),
         hs.grad.year = str_replace(hs.grad.year, "hs.grad.year.e", "hs.grad.year"))

match.region.summary.total.edr.plot <- ggplot(match.region.summary.total.edr, aes(hs.grad.year, pct, fill = edr.match, group = edr.match)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(hs.grad.year, "\nEmployment match high school edr? - ", edr.match, sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  coord_flip() +
  labs(x="", y = "", color="", title = "Percent of individuals with meaningful employment in high school edr")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = match.region.summary.total.edr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

Next we will analyze differences in these percentages if broken down by EDR.

The crosstabs indicate a significant difference.

* hs.grad.year: EDR 6E has significantly higher number of indivuduals, 6W lower.
* hs.grad.year.2: EDR 6E and 8 have higher, 6W lower.
* hs.grad.year.7: EDR 6E lower (interesting). 

<br>

### EDR - chart pct

<br>

```{r edr employment match edr}
match.region.summary.total.edr <- master.11 %>%
  select(edr, hs.grad.year.edr.match, hs.grad.year.2.edr.match, hs.grad.year.7.edr.match) %>%
  gather(key = "hs.grad.year", value = "edr.match", 2:4) %>%
  filter(edr.match != "After 2019") %>%
  group_by(edr,hs.grad.year, edr.match) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(edr,hs.grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         hs.grad.year = str_sub(hs.grad.year, 1, 14),
         hs.grad.year = str_replace(hs.grad.year, "hs.grad.year.e", "hs.grad.year"))

match.region.summary.total.edr.plot <- ggplot(match.region.summary.total.edr, aes(hs.grad.year, pct, fill = edr.match, group = edr.match)) +
  facet_wrap(~edr, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(hs.grad.year, "\nEmployment match high school edr? - ", edr.match, sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  coord_flip() +
  labs(x="", y = "", color="", title = "Percent of individuals with meaningful employment in high school edr")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = match.region.summary.total.edr.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

### EDR - crosstabs

<br>

```{r crosstabs edr employment location match by edr}
summary <- master.11 %>%
  mutate(edr = str_sub(edr, 1, 6)) 

summary.2 <- master.11 %>%
  mutate(edr = str_sub(edr, 1, 6)) %>%
  filter(hs.grad.year.2.edr.match != "After 2019")

summary.7 <- master.11 %>%
  mutate(edr = str_sub(edr, 1, 6)) %>%
  filter(hs.grad.year.7.edr.match != "After 2019")

CrossTable(summary$edr, summary$hs.grad.year.edr.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(summary.2$edr, summary.2$hs.grad.year.2.edr.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(summary.7$edr, summary.7$hs.grad.year.7.edr.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)


```

<br>

## {.unnumbered .unlisted .toc-ignore .tabset}

Okay, now by RUCA category.

Cross tabs indicate relationship. But not huge differences.

<br>


### RUCA - chart pct

<br>

```{r edr employment match ruca}
match.region.summary.total.ruca <- master.11 %>%
  select(Dem_Desc, hs.grad.year.edr.match, hs.grad.year.2.edr.match, hs.grad.year.7.edr.match) %>%
  gather(key = "hs.grad.year", value = "edr.match", 2:4) %>%
  filter(edr.match != "After 2019") %>%
  group_by(Dem_Desc, hs.grad.year, edr.match) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(Dem_Desc, hs.grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         hs.grad.year = str_sub(hs.grad.year, 1, 14),
         hs.grad.year = str_replace(hs.grad.year, "hs.grad.year.e", "hs.grad.year"))

match.region.summary.total.ruca.plot <- ggplot(match.region.summary.total.ruca, aes(hs.grad.year, pct, fill = edr.match, group = edr.match)) +
  facet_wrap(~Dem_Desc, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(hs.grad.year, "\nEmployment match high school edr? - ", edr.match, sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  coord_flip() +
  labs(x="", y = "", color="", title = "Percent of individuals with meaningful employment in high school edr")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = match.region.summary.total.ruca.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

<br>

### EDR - crosstabs

<br>

```{r crosstabs edr employment location match by ruca}

CrossTable(summary$Dem_Desc, summary$hs.grad.year.edr.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(summary.2$Dem_Desc, summary.2$hs.grad.year.2.edr.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(summary.7$Dem_Desc, summary.7$hs.grad.year.7.edr.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)


```

<br>

## Region grad location and employment match{.tabset}

Next we will look at the percentage of individuals that have meaningful employment in the research region the year they graduate, two years after graduating, and seven years after graduating.

The chart below shows that 16.2% of individuals in the main dataset had meaningful employment in one of the three EDRs. The percent increases to 25.3% of individuals two years after graduating and 31.8% seven years after graduation. All "After 2019" individuals were taken out.

<br>

```{r summary employment in region match total}
match.region.summary.total.region <- master.11 %>%
  select(PersonID, hs.grad.year.region.match, hs.grad.year.2.region.match, hs.grad.year.7.region.match) %>%
  gather(key = "hs.grad.year", value = "region.match", 2:4) %>%
  filter(region.match != "After 2019") %>%
  group_by(hs.grad.year, region.match) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(hs.grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         hs.grad.year = str_sub(hs.grad.year, 1, 14),
         hs.grad.year = str_replace(hs.grad.year, "hs.grad.year.r", "hs.grad.year"))

match.region.summary.total.region.plot <- ggplot(match.region.summary.total.region, aes(hs.grad.year, pct, fill = region.match, group = region.match)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(hs.grad.year, "\nEmployment match high school region? - ", region.match, sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  coord_flip() +
  labs(x="", y = "", color="", title = "Percent of individuals with meaningful employment in high school region")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = match.region.summary.total.region.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      



```

<br>

Okay, now differences by EDR.

Cross tabs indicate a relationship. There is quite a lot here to look at.

* hs.grad.year
    + EDR 6E: significantly higher than expected number of people with no location match. Significantly lower than expected with no MN emp record.
    + EDR 6W: lower than expected no location match and higher than expected no mn record.
    + EDR 8: Significantly lower than expected "no location match" and higher than expected "no mn record".
* hs.grad.year.2
    + EDR 6E: still higher with no location match.Significantly lower than expected no mn emp record.
    + EDR 6W: Alignment.
    + EDR 8: Sam,e as hs.grad.year
* hs.grad.year.7
    + EDR 6E: Same as previous
    + EDR 6W: Alignment
    + EDR 8: Same as before.
    
<br>

### EDR - chart

<br>

```{r summary region location match by EDR}
match.region.summary.edr.region <- master.11 %>%
  select(edr, hs.grad.year.region.match, hs.grad.year.2.region.match, hs.grad.year.7.region.match) %>%
  gather(key = "hs.grad.year", value = "region.match", 2:4) %>%
  filter(region.match != "After 2019") %>%
  group_by(edr, hs.grad.year, region.match) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(edr, hs.grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         hs.grad.year = str_sub(hs.grad.year, 1, 14),
         hs.grad.year = str_replace(hs.grad.year, "hs.grad.year.r", "hs.grad.year"))

match.region.summary.edr.region.plot <- ggplot(match.region.summary.edr.region, aes(hs.grad.year, pct, fill = region.match, group = region.match)) +
  facet_wrap(~edr, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(hs.grad.year, "\nEmployment match high school region? - ", region.match, sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  coord_flip() +
  labs(x="", y = "", color="", title = "Percent of individuals with meaningful employment in high school region")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = match.region.summary.edr.region.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      



```


<br>

### EDR - cross tabs

<br>

```{r summary region location match by EDR cross tabs}
summary <- master.11 %>%
  mutate(edr = str_sub(edr, 1, 6))

summary.2 <- master.11 %>%
  mutate(edr = str_sub(edr, 1, 6)) %>%
  filter(hs.grad.year.2.region.match != "After 2019")

summary.7 <- master.11 %>%
  mutate(edr = str_sub(edr, 1, 6)) %>%
  filter(hs.grad.year.7.region.match != "After 2019")

CrossTable(summary$edr, summary$hs.grad.year.region.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(summary.2$edr, summary.2$hs.grad.year.2.region.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(summary.7$edr, summary.7$hs.grad.year.7.region.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)


```

<br>

## {.unnumbered .unlisted .toc-ignore .tabset}

Next let's analyze by RUCA.

Relationship confirmed.

* hs.grad.year
    + Entirely rural: lower "location match". Lower "no location match". High "no emp record".
    + Town/rural mix: Higher location match. 
    + Urban/town/rural mix: Lower "location match". Higher "no emp record".
* hs.grad.year.2
    + Entirely rural: Same as previous
    + Town/rural mix: Same as previous
    + Urban/town/rural mix: Same as previous
* hs.grad.year.7: same


<br>

### RUCA - chart

<br>

```{r summary region location match by ruca}
match.region.summary.ruca.region <- master.11 %>%
  select(Dem_Desc, hs.grad.year.region.match, hs.grad.year.2.region.match, hs.grad.year.7.region.match) %>%
  gather(key = "hs.grad.year", value = "region.match", 2:4) %>%
  filter(region.match != "After 2019") %>%
  group_by(Dem_Desc, hs.grad.year, region.match) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(Dem_Desc, hs.grad.year) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(data_id = seq(n()),
         hs.grad.year = str_sub(hs.grad.year, 1, 14),
         hs.grad.year = str_replace(hs.grad.year, "hs.grad.year.r", "hs.grad.year"))

match.region.summary.ruca.region.plot <- ggplot(match.region.summary.ruca.region, aes(hs.grad.year, pct, fill = region.match, group = region.match)) +
  facet_wrap(~Dem_Desc, ncol = 2) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(hs.grad.year, "\nEmployment match high school region? - ", region.match, sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  coord_flip() +
  labs(x="", y = "", color="", title = "Percent of individuals with meaningful employment in high school region")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = match.region.summary.ruca.region.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      



```


<br>

### EDR - cross tabs

<br>

```{r summary region location match by ruca cross tabs}

CrossTable(summary$Dem_Desc, summary$hs.grad.year.region.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(summary.2$Dem_Desc, summary.2$hs.grad.year.2.region.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)

CrossTable(summary.7$Dem_Desc, summary.7$hs.grad.year.7.region.match, expected = TRUE, prop.t = FALSE, prop.c = FALSE, prop.chisq = FALSE)


```

<br>

Okay, this is all getting ridiculous. Let's just move on to industry match and only the total. 

The chart below shows that the percentage of individuals that worked in an industry that matches a CTE course the took was 7.8% at the year of graduation, 13.9% two years after graduating, and 20.8% seven years after graduation. This is after filtering out "After 2019".

<br>

```{r industry match summary total}
summary.ind.match.total <- master.11 %>%
  select(PersonID, ind.match.hs.grad.year, ind.match.hs.grad.year.2, ind.match.hs.grad.year.7) %>%
  gather(key = "hs.grad.year", value = "ind.match", 2:4) %>%
  filter(ind.match != "After 2019") %>%
  group_by(hs.grad.year, ind.match) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(hs.grad.year) %>%
  mutate(pct = n / sum(n))%>%
  ungroup() %>%
  mutate(data_id = seq(n()))

summary.ind.match.total.plot <- ggplot(summary.ind.match.total, aes(hs.grad.year, pct, fill = ind.match, group = ind.match)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(hs.grad.year, "\nIndustry match? -", ind.match, sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  coord_flip() + 
  labs(x="", y = "", color="", title = "Percent industry match")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = summary.ind.match.total.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      


```

```{r write master}
write_csv(master.11, "Data/SLEDS/Master-11.csv")

```