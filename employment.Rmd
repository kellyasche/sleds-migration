---
title: "Employment"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
library(gmodels)
```

```{r themes and join docs, include=FALSE}
theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))

```

<br>

# Data prep

Now I'm going to prep the employment data in order to join with the master dataset. So, let's import the original data.

The dataset was exported as two separate spreadsheets due to the size. So I will import both and rbind them together.

<br>

```{r employment original}
employment.original.1 <- read_csv("Data/SLEDS/Employment/Employment.csv") %>%
  mutate(PersonID = as.integer(PersonID)) 

employment.original.2 <- read_csv("Data/SLEDS/Employment/Employment2.csv") %>%
  mutate(PersonID = as.integer(PersonID)) 

employment.original <- employment.original.1 %>%
  rbind(employment.original.2) %>%
  drop_na(PersonID) %>%
  select(1:23)

head(employment.original)

names(employment.original)

```

<br>

In the original dataset we have `r employment.original %>% nrow()` rows and `r employment.original %>% ncol()` columns. Below is a description of each variable.

* Empl_TimeID: Last day of fiscal quarter
* CalendarYear: Year
* CalendarQuarter: Quarter within the year in which the data applies. Quarters are;
  + 1 = Jan - Mar
  + 2 = Apr - Jun
  + 3 = Jul - Sep
  + 4 = Oct - Dec
* EmploymentOrganizationID: An internal identification for each employer.
* EmployeeQuarterlyHoursWorked: The total number of hours worked by an employee at an employer's location during a specific calendar quarter
* EmployeeQuarterlyWages: The total wages earned by an employee at an employer's location during a specific calendar quarter
* EmployeeTenure: The total number of quarters a worker has been employeed by an organization at a specific location, up to an including the current calendar quarter
* IndustryID: Auto generated ID code for a record in the Industry dimension.
* USIndustryCode: Six-digit North American Industrial Classification System (NAICS) code
* GroupCode: Four-digit North American Industrial Classification System (NAICS) code
* IndustryGroup: Definition of GroupCode variable, the 4-digit NAICS code
* OwnershipCode: A classification system based upon the controlling interest of the establishment primarily designed to distinguish between governmental and non-governmental establishments
  + 10 = Federal government
  + 20 = State government
  + 30 = Local government
  + 50 = Private
* EmployerLocationTotalWagesPaid: The total wages paid to all workers employeed by an organization at a specific location during a specific calendar quarter
* QuarterlyAverageEmployment: The average number of workers employeed by an organization at a specific location during a specific calendar quarter
* LocationID: ???
* EconomicDevelopmentRegion: The 13 economic development regions within the state of Minnesota as defined by the Department of Employment and Economic Development (DEED).
  + R01000	EDR 1 - Northwest		
  + R02000	EDR 2 - Headwaters		
  + R03000	EDR 3 - Arrowhead		
  + R04000	EDR 4 - West Central		
  + R05000	EDR 5 - North Central		
  + R06E00	EDR 6E - Southwest Central		
  + R06W00	EDR 6W - Upper Minnesota Valley		
  + R07E00	EDR 7E - East Central		
  + R07W00	EDR 7W - Central		
  + R08000	EDR 8 - Southwest		
  + R09000	EDR 9 - South Central		
  + R10000	EDR 10 - Southeast
  + R11000	EDR 11 - 7 County Twin Cities
* EconomicDevelopmentRegionName: Name of EDR
* County: Minnesota county code to which this institution belongs. This can be used as a foreign key into the Geography dimension on MNCounty.
  + [Link to codes](https://sleds.mn.gov/dataDictionary/658)
* CountyName: The name of the county corresponding to the County and MNCounty Codes for this Location.
* MNCounty: County Code for this location as assigned by the state of Minnesota.
  + [Link to codes](https://sleds.mn.gov/dataDictionary/663)
City: All of the city data is NA

