---
title: "Analysis - local employment cross tabs"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
library(gmodels)
library(fastDummies)
library(car)
library(glmnet)
library(glmnetUtils)
library(pscl)
library(sjPlot)

```

```{r join docs, include=FALSE}
theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))


theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial") ,
        plot.title.position = "plot",
        plot.title = element_text(face = "bold"))

regions <- read_csv("Data/Join docs/county_regions.csv") %>%
    select(5,6) %>%
    unique() %>%
    mutate(edr = str_replace(edr, "  ", " "),
           planning.region = str_replace(planning.region, " Minnesota", ""),
           planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
           edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"))

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))


color.ruca <- c("Entirely rural" = "#009933", "Town/rural mix" = "#99CC33", "Urban/town/rural mix" = "#CC9966", "Entirely urban" = "#754C29", "Minnesota" = "black")

color.pr <- c("Northwest" = 	"#4575b4", "Northeast" = "grey", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black")

color.edr <- c("EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365", "Minnesota" = "black")

color.pr.edr <- c ("Northwest" = "#4575b4","Northeast" = "#e0f3f8", "Central" = "#fee090", "Seven County Mpls-St Paul" = "#d73027", "Southwest" = "#91bfdb", "Southeast" = "#fc8d59", "Minnesota" = "black", "EDR 1 - Northwest" = "#b3cde3", "EDR 2 - Headwaters" = "#8c96c6", "EDR 3 - Arrowhead" = "#fe9929", "EDR 4 - West Central" = "#8856a7", "EDR 5 - North Central" = "#810f7c", "EDR 6E- Southwest Central" = "#e5f5f9", "EDR 6W- Upper Minnesota Valley" = "#bdc9e1", "EDR 7E- East Central" = "#99d8c9", "EDR 7W- Central" = "#2ca25f", "EDR 8 - Southwest" = "#74a9cf", "EDR 9 - South Central" = "#0570b0", "EDR 10 - Southeast" = "#d7301f", "EDR 11 - 7 County Twin Cities" = "#d8b365")

mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)


```

```{r master dataset}
master.original <- read_csv("Data/SLEDS/Masters/Master.csv")

```

```{r independent and dependent variables}
updated.qual.var.names <-  c("PersonID", "LimitedEnglishProficiencyIndicator", "pseo.participant", "non.english.home", "RaceEthnicity", "Dem_Desc", "edr", "took.ACT", "ap.exam", "cte.achievement", "english.learner", "attended.ps", "ps.grad", "ps.grad.InstitutionSector", "highest.cred.level")

quan.var.names <- c("total.cte.courses.taken", "cte.0", "cte.1", "cte.2", "cte.3", "cte.4", "cte.5", "cte.6", "cte.7", "cte.8", "cte.9", "cte.10", "cte.11", "cte.12", "cte.14", "cte.21", "cte.22", "cte.23", "cte.24", "cte.25", "cte.26", "avg.cte.intensity", "MCA.M", "MCA.R", "MCA.S", "avg.unemp.rate", "wages.3year.avg")

updated.independent.var.names <- c("PersonID", "LimitedEnglishProficiencyIndicator", "pseo.participant", "non.english.home", "RaceEthnicity", "Dem_Desc", "edr", "took.ACT", "ap.exam", "cte.achievement", "english.learner", "attended.ps", "ps.grad", "ps.grad.InstitutionSector", "highest.cred.level", "total.cte.courses.taken", "cte.0", "cte.1", "cte.2", "cte.3", "cte.4", "cte.5", "cte.6", "cte.7", "cte.8", "cte.9", "cte.10", "cte.11", "cte.12", "cte.14", "cte.21", "cte.22", "cte.23", "cte.24", "cte.25", "cte.26", "avg.cte.intensity", "MCA.M", "MCA.R", "MCA.S", "avg.unemp.rate", "wages.3year.avg")

cte.cc.var.names <- c("cte.1", "cte.2", "cte.3", "cte.4", "cte.5", "cte.6", "cte.7", "cte.8", "cte.9", "cte.10", "cte.11", "cte.12", "cte.14", "cte.21", "cte.22", "cte.23", "cte.24", "cte.25")

updated.master <- master.original %>%
  select(`updated.independent.var.names`, hs.grad.year.county.match, hs.grad.year.2.county.match, hs.grad.year.7.county.match, hs.grad.year.edr.match, hs.grad.year.2.edr.match, hs.grad.year.7.edr.match, hs.grad.year.region.match, hs.grad.year.region.match, hs.grad.year.2.region.match, hs.grad.year.7.region.match, hs.grad.year.state.match, hs.grad.year.2.state.match, hs.grad.year.7.state.match) %>%
  mutate_at(2:15, as.factor)

```

<br>

The first research question is to analyze the factors that play into whether an individual has meaningful employment within their high school county, EDR, research region, and Minnesota at time X. 

There are three "times" in which we checked to see if the individual had meaningful employment within these geographies;

1. the same year as graduation
2. two years after graduation, and
3. seven years after graduation. 

Meaningful employment is determined by whether an individual worked 1,000 hours for an employer during time X. In addition, if the individual worked 1,000 hours for that employer during another year, but not for that exact "time X" year, it's still considered "meaningful". 

Due to time x potentially being passed the date of the latest data (2019) for some individuals, the analysis below will filter out all individuals where time x is after 2019. 

There are a number of independent variables in the master dataset. And they are likely to have significant colinearity, so we are going to split them up into larger "Groups" that will then have sub groups. For example, instead of modeling whether the institution sector from which an individual has graduated from impacts the dependent variable, we will just check to see if graduating from a post-seconary institution impacts the dependent variable. If so, then we will dig deeper to see if the institution type is significant.

The primary independent variables we will use in the model is the following;

```{r list of ind var}
updated.master %>%
  select(-PersonID, -hs.grad.year.county.match, -hs.grad.year.2.county.match, -hs.grad.year.7.county.match, -hs.grad.year.edr.match, -hs.grad.year.2.edr.match, -hs.grad.year.7.edr.match, -hs.grad.year.region.match, -hs.grad.year.region.match, -hs.grad.year.2.region.match, -hs.grad.year.7.region.match, -hs.grad.year.state.match, -hs.grad.year.2.state.match, -hs.grad.year.7.state.match) %>%
  lapply(class) 
```
    
<br>

# Steps in analysis

Our dependent variable - the individual has meaningful employment in same location X as their high school - has 4 different outcomes.

1. Location match: the individual has
    + a MN employment record at time X
    + has meaningful employment at time X
    + is employed in the same location X as their high school.
2. No location match: the individual has 
    + a MN employment record at time X
    + has meaningful employment at time X
    + does NOT have employment in the same location X as their high school.
3. No meaningful emp: the individual has
    + a MN employment record at time X
    + the employment is not meaningful at time X.
4. No MN emp record: the individual has
    + NO MN employment record at time X.
    
Since we are most interested in whether an individual has meaningful employment in region X at time X we will create two groups; 1. all individuals that meet the criteria/outcome 1 from list above, and 2. all remaining individuals.
    
For each time X we will analyze whether the independent variables are good at predicting whether an individual has a MN employment record AND has meaningful employment AND the meaningful employment is in the same region X as their high school.

The structure of the analysis will look like this;

* Location match - county through region
    + For each region x
      + Summary chart
    + For each time x (grad year, grad year +2, grad year +7)
      + Demographic variables
      + HS characteristic variables
      + HS enrollment variables
      + HS accomplishments
      + Post secondary (only gor grad year +2 and grad year +7)
      
I'll be using the Cramer's v-square measure of association. The V^2 value is from 0 to 1 with 0 meaning there's no association and a value closer to 1 indicates a strong association.

<br>

# Location match - county

## Summary chart

The chart below provides the percentage of individuals in the dataset that had meaningful employment in the same county as their high school the year of their graduation, graduation year +2, and graduation year +7. The percentage of individuals does increase with each subsequent time X - 12.4% the year of gradation, 17.4% two years after graduation, and 20% seven years after graduation.

<br>

```{r summary county grad year}
county.match.summary <- updated.master %>%
  select(PersonID, hs.grad.year.county.match, hs.grad.year.2.county.match, hs.grad.year.7.county.match) %>%
  gather(key = "key", value = "value", 2:4) %>%
  filter(value != "Unknown") %>%
  filter(value != "After 2019") %>%
  mutate(value = ifelse(value == "Location match", "Match", "No match")) %>%
  group_by(key, value) %>%
  summarize(n = n()) %>%
  ungroup() %>%
  group_by(key) %>%
  mutate(pct = n / sum(n)) %>%
  ungroup() %>%
  mutate(key = ifelse(str_detect(key, "2"), "grad year +2",
                      ifelse(str_detect(key, "7"), "grad year +7", "grad year +0")),
         key = fct_relevel(key, "grad year +0", "grad year +2", "grad year +7"),
         data_id = seq(n()))
                                      

county.match.summary.plot <- ggplot(county.match.summary, aes(value, pct, fill = key, group = key)) +
  geom_col_interactive(position = "dodge", aes(data_id = data_id, tooltip = paste(key, "\n", value, ": ", percent(pct, accuracy = .1), sep = ""))) +
  geom_label(aes(label = percent(pct, accuracy = .1)), show.legend = FALSE, color = "white", size = 5, position = position_dodge(width = .9)) +
  labs(x="", y = "", color="", title = "Meaningful employment in same county as high school for each\ntime X as share of total individuals", subtitle = "The percentage of individuals with meaningful employment in same county as their high\nschool increases for each subsequent Time X")+
  scale_y_continuous(labels=scales::percent)+
  theme_bar+
  scale_fill_manual(values = brewer.pal(n = 6, "RdYlBu"),
                    guide = guide_legend(ncol = 3)) +
  theme(legend.position = "bottom",
        text = element_text(size = 18))


girafe(ggobj = county.match.summary.plot, width_svg = 10, height_svg = 10) %>%
  girafe_options(opts_selection(type = "none"),
                 opts_sizing(rescale = FALSE))      

```

<br>

## Cross tabs - Time X = grad year

```{r master ct grad year}
master.grad.year.ct <- updated.master %>%
  select(hs.grad.year.county.match, updated.independent.var.names) %>% 
  rename(`County match` = 1) %>%
  mutate(`County match` = ifelse(`County match` == "Location match", "Match", "No match"))

```

Now let's examine whether there are any relationships between these individuals and the independent variables.

<br>

### Demographic variables{.tabset}

**Race/Ethnicity:** The crosstabs indicate a relationship between whether an individual has meaningful employment in the same county as their high school the year they graduate and the individual's race/ethnicy. The p-value was 0, however the Cramer's V^2 value was 0.068, indicating a weak association. Highlights in the table include;

* A larger proportion of black individuals (16.6%) had meaningful employment in their high school county compared to AI, Asian/PI and White individuals. 
* A larger observed number of Black individuals had meaningful employment in the same county as their high school than what was expected - 124 individuals vs. 93 expected.
* A larger proportion of hispanic individuals (19.9%) had meaningful employment in their high school county compared to all other races/ethnicities. 
* A larger observed number of hispanic individuals had meaningful employment in the same county as their high school than what was expected - 549 observed vs. 341 expected.

#### Race/Ethnicity

```{r ct race and ethnicity}
tab_xtab(var.row = master.grad.year.ct$`County match`, var.col = master.grad.year.ct$RaceEthnicity, 
         title = "Test", 
         show.exp = TRUE,
         show.col.prc = TRUE)
```

<br>

### High school characteristic variables{.tabset}

**Dem_Desc:** The p-value indicates that we can reject the null hypothesis and acknowledge that the variables may have a relationship. The Cramer's V^2 value is only 0.053, indicating that the relationships are weak. Highlights from the table include;

* Individuals from entirely rural high schools had a significantly lower proportion of individuals that had meaningful employment in the same county as their high school - 8.6% compared to 11.1% in urban/town/rural mix and 13.4% in town/rural mix.
* Individuals from entirely rural high schools had a significantly lower observed number of individuals that had meaningful employment in the same county as their high school - 476 observed vs. 684 expected.

<br>

**EDR:** The p-value indicates that we can reject the null hypothesis and acknowledge that the variables may have a relationship. The Cramer's V^2 value however is only 0.050, indicating the associations are weak. Highlights in the table include;

* EDR 6W had the lowest proportion of individuals that had meaningful employment in the same county as their high school the year of graduation - 9.7% compared to 12% in EDR 8 and 14.2% in EDR 6E. 
* EDR 6W had a significantly lower number of individuals that had meaningful employment in the same county as their high school the year of graduation - 714 observed vs. 911 expected.

<br>

**avg.unemployment.rate:** The ANOVA table does indicate a relationship between whether an individual has meaningful employment in the same county as their high school the year of graduation and the average unemployment rate in that county. It states that as unemployment increases, the likliness of having "match" increases as well.

<br>

**wages.3year.avg:** No relationship.



#### Dem_Desc

```{r ct Dem_Desc}
tab_xtab(var.row = master.grad.year.ct$`County match`, var.col = master.grad.year.ct$Dem_Desc, 
         title = "Test", 
         show.exp = TRUE,
         show.col.prc = TRUE)
```

<br>

#### EDR

```{r ct edr}
tab_xtab(var.row = master.grad.year.ct$`County match`, var.col = master.grad.year.ct$edr, 
         title = "Test", 
         show.exp = TRUE,
         show.col.prc = TRUE)
```

<br>

#### avg.unemployment.rate

```{r ct avg unemployment rate}
data <- master.grad.year.ct %>%
  rename(dep.var = `County match`)

summary <- aov(avg.unemp.rate ~ dep.var, 
             data = data)

summary(summary) 

TukeyHSD(summary)
```

<br>

#### wages.3yr.avg

```{r ct avg wages}
data <- master.grad.year.ct %>%
  rename(dep.var = `County match`)

summary <- aov(wages.3year.avg ~ dep.var, 
             data = data)

summary(summary) 

TukeyHSD(summary)
```


<br>


<br>

### High school enrollment variables{.tabset}

#### LimitedEnglishProficiencyIndicator

<br>

#### pseo.participant

<br>

#### non.english.home

<br>

#### english.learner

<br>

### High school accomplishments variables

<br>

## Time X = grad year +2

<br>

### Demographic variables

<br>

### High school characteristic variables

<br>

### High school enrollment variables

<br>

### High school accomplishments variables

<br>

## Time X = grad year +7

<br>

### Demographic variables

<br>

### High school characteristic variables

<br>

### High school enrollment variables

<br>

### High school accomplishments variables

<br>









