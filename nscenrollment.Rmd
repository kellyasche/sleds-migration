---
title: "National Student Clearinghouse - enrollment"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 4
runtime: shiny
resource_files:
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.cpg
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.dbf
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.prj
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbn
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.sbx
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shp.xml
- Data/Shapefiles/County shapefiles/MNCounties_MNDOT.shx
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(sf)
library(ggrepel)
library(scales)
library(shiny)
library(shinycssloaders)
library(ggiraph)
library(kableExtra)
library(rmapshaper)
library(cowplot)
library(DT)
library(htmlwidgets)
library(RColorBrewer)
library(readxl)
library(janitor)
library(lubridate)
library(systemfonts)
reset_font_cache()
library(ggtext)
library(gmodels)
```

```{r themes and join docs, include=FALSE}
theme_line <- theme_bw() +
  theme(legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.text = element_text(margin = margin(l = 2)),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_line(color = "grey70", size = 0.1),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

theme_sf <- theme_bw() +
  theme(axis.text.x=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks=element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(color = "white"),
        panel.border = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        legend.margin = margin(0,0,0,0),
        legend.key.size = unit(1, "lines"),
        text = element_text(family = "Arial"))

theme_bar <- theme_bw() +
  theme(panel.grid.major = element_line(color = "grey70", size = 0.1),
        panel.grid.minor = element_blank(),
        axis.ticks = element_blank(),
        axis.text = element_text(face = "bold"),
        panel.border = element_blank(),
        legend.background = element_rect(fill = "transparent", color = "transparent"),
        legend.key = element_rect(fill = "transparent"),
        legend.key.size = unit(1, "lines"),
        legend.margin = margin(0,0,0,0),
        legend.title = element_blank(),
        legend.text = element_text(margin = margin(l = 2)),
        text = element_text(family = "Arial"))


mn_counties <- st_read("Data/Shapefiles/county shapefiles/MNCounties_MNDOT.shp", quiet = TRUE) %>%
  ms_simplify(keep = .01, keep_shapes = TRUE) %>%
  rename(countyfp = FIPS_CODE)

counties.regions <- read_csv("Data/Join docs/county_regions.csv") %>%
  rename(mif = `MIF Region`) %>%
  mutate(countyfp = formatC(countyfp, width = 3, flag = "0"),
         Name = str_to_title(Name),
         Name = str_replace(Name, "Q", "q"),
         Name = str_replace(Name, "Of The", "of the"),
         Name = str_replace(Name, "Mcleod", "McLeod"),
         Dem_Desc = ifelse(Name == "Minnesota", "Minnesota", Dem_Desc) ,
         edr = str_replace(edr, "  ", " "),
         planning.region = str_replace(planning.region, " Minnesota", ""),
         planning.region = fct_relevel(planning.region, "Northwest", "Northeast", "Central", "Seven County Mpls-St Paul", "Southwest", "Southeast"),
         edr = fct_relevel(edr, "EDR 1 - Northwest", "EDR 2 - Headwaters", "EDR 3 - Arrowhead", "EDR 4 - West Central", "EDR 5 - North Central", "EDR 6E- Southwest Central", "EDR 6W- Upper Minnesota Valley", "EDR 7E- East Central", "EDR 7W- Central", "EDR 8 - Southwest", "EDR 9 - South Central", "EDR 10 - Southeast", "EDR 11 - 7 County Twin Cities", "Minnesota"),
         mif = ifelse(is.na(mif), "TC", mif),
         mif = as.factor(mif),
         mif = fct_relevel(mif, "NW", "NE", "WC", "EC", "SW", "SE", "TC"))

```

<br>

# Data prep - NSC enrollment

Okay, lets check out the National Student Clearinghouse enrollment data.

<br>

```{r nsc enrollment originals}
nsc.enrollment.original <- read_csv("Data/SLEDS/NSC/NSC_Enrollments.csv") %>%
  mutate(PersonID = as.integer(PersonID),
         OPEID = str_pad(OPEID, width = 8, side = "left", pad = "0"),
         OPEID.6 = str_sub(OPEID, 1, 6)) %>%
  drop_na(PersonID) %>%
  drop_na(OPEID)
  
head(nsc.enrollment.original)

names(nsc.enrollment.original)
```

<br>

The dataset has `r comma(nsc.enrollment.original %>% nrow(), accuracy = 1)` rows and `r comma(nsc.enrollment.original %>% ncol(), accuracy = 1)` columns. Here are the columns and their definitions.

* EnrollmentBeginTimeID: Begin date for the student’s period of attendance.
* EnrollmentEndTimeID: End date for the student’s period of attendance.
* OPEID: Office of Postsecondary Education (OPE)/FICE code of the college that the student attended (Foreign Key to IPEDSCharacteristics).
* InstitutionName: Name of institution
* EnrollmentStatus: The last enrollment status reported for the student. This field will have 'N/A' or "NULL" if the reporting college has not defined the student’s enrollment status as directory information. Here are the code definitions;
  + F: Full-time
  + Q: Three-quarter time
  + H: Half-time
  + L: Less than half-time
  + A: Leave of absence
  + W: Withdrawn
  + D: Deceased

Essentially, this dataset provides semester-based information - each observation is a semester/single period with the institutional information and beginning and end time of that single period (usually a semester). For example, if an individual attended South Dakota State University, attended in a "typical" fashion (fall and spring semesters), and graduated in 4 years, there would be 8 observations for that PersonID - one observation per semester.

There are a few pieces of information that I want to consolidate from this dataset;

1. Did the PersonID in the master dataset attend a college - yes or no?
2. Did the PersonID attend college during high school (PSEO), immediately after graduation or wait?
3. How many months did they attend college?
4. Did the PersonID attend multiple colleges - yes or no?
5. Did the PersonID attend a public, private not-for-profit, or private for-profit college(s)?
6. Did the PersonID attend a 2-year institution - yes or no?
7. Did the PersonID attend a 4-year institution - yes or no?
8. At any point during their college career, did the PersonID attend a college(s) inside or outside of the Southwest Region or outside the EDR of their high school?

The pieces of information missing in the original dataset is location and type of institution attended.To do this we will need to join the original dataset with an IPEDS dataset using opeid.

The IPEDS data and the NSC data will only match using the first 6 digits of the IPEDS OPEID values. So I will change that in the NSC data. Then I can join.

<br>

```{r prep ipeds}
ipeds.original <- read_csv("Data/SLEDS/IPEDS/IPEDS.csv") 

ipeds.sector <- ipeds.original %>%
  filter(!is.na(OPEID)) %>%
  mutate(OPEID = str_pad(OPEID, width = 8, side = "left", pad = "0"),
         OPEID.6 = str_sub(OPEID, 1, 6)) %>%
  select(Unitid, OPEID.6, City, State, FIPS, GeographicRegion, CountyCode, InstitutionSector) 

nsc.enrollment.ipeds<- nsc.enrollment.original %>%
  left_join(ipeds.sector, by = "OPEID.6") %>%
  drop_na(Unitid) %>%
  mutate(EnrollmentStatus = as_factor(EnrollmentStatus))

head(nsc.enrollment.ipeds)

names(nsc.enrollment.ipeds)
```

<br>

After joining these we now have `r comma(nsc.enrollment.ipeds %>% nrow(), accuracy = 1)` rows and `r comma(nsc.enrollment.ipeds %>% ncol(), accuracy = 1)` columns. This is a few less than the original enrollment document due to a few OPEIDs not aligning. But overall, the data now has the institution sector that the individual attended as well as location.

First, we will create a dataset with a column confirming their post-secondary attendance for each unique PersonID in the nsc.enrollment.ipeds.

<br>

```{r nsc attended}
nsc.enrollment.confirm <- nsc.enrollment.ipeds %>%
  distinct(PersonID) %>%
  mutate(attended.ps = "Yes")

head(nsc.enrollment.confirm)

names(nsc.enrollment.confirm)
```

<br>

There are `r comma(nsc.enrollment.confirm %>% nrow(), accuracy = 1)` rows and `r comma(nsc.enrollment.confirm %>% ncol(), accuracy = 1)` columns in the dataset. The columns provide the unique PersonID along with a newly created column confirming that they attended post-secondary education.

Next we will extract the first month and year each PersonID attended a post-secondary institution.

<br>

```{r nsc first month and year attending}
nsc.enrollment.first.attend <- nsc.enrollment.ipeds %>%
  mutate(first.year = as.integer(str_sub(EnrollmentBeginTimeID, 1,4)),
         first.month = as.integer(str_sub(EnrollmentBeginTimeID, 5,6)),
         first.day = as.integer(str_sub(EnrollmentBeginTimeID, 7, 8))) %>%
  group_by(PersonID) %>%
  filter(first.year == min(first.year)) %>%
  mutate(n = n()) %>%
  ungroup() %>%
  group_by(PersonID) %>%
  filter(first.month == min(first.month)) %>%
  ungroup() %>%
  group_by(PersonID) %>%
  filter(first.day == min(first.day)) %>%
  ungroup() %>%
  distinct(PersonID, .keep_all = TRUE) %>%
  mutate(first.month = str_pad(first.month, width = 2, side = "left", pad = "0"),
         first.day = str_pad(first.day, width = 2, side = "left", pad = "0"),
         first.attend.ps = paste(first.year, first.month, first.day, sep = "")) %>%
  select(PersonID, first.attend.ps)

head(nsc.enrollment.first.attend)

names(nsc.enrollment.first.attend)
```

<br>

This dataset has `r comma(nsc.enrollment.first.attend %>% nrow(), accuracy = 1)` rows and `r comma(nsc.enrollment.first.attend %>% ncol(), accuracy = 1)` columns. Essentially, this datset provides each unique PersonID with the earliest begin time for post-secondary education.

Now we will extract the number of total months that each PersonID attended a post-secondary institution.

<br>

```{r nsc enrollment n months attending}
nsc.enrollment.n.days.attend <- nsc.enrollment.ipeds %>%
  select(PersonID, EnrollmentBeginTimeID, EnrollmentEndTimeID) %>%
  mutate(begin = paste(str_sub(EnrollmentBeginTimeID, 1, 4), str_sub(EnrollmentBeginTimeID, 5, 6), str_sub(EnrollmentBeginTimeID, 7, 8), sep = "-"),
         begin = ymd(begin),
         end = paste(str_sub(EnrollmentEndTimeID, 1,4), str_sub(EnrollmentEndTimeID, 5,6), str_sub(EnrollmentEndTimeID, 7, 8), sep = "-"),
         end = ymd(end)) %>%
  group_by(PersonID) %>%
  distinct(begin, end, .keep_all = TRUE) %>%
  ungroup() %>%
  mutate(attend.interval = end - begin) %>%
  group_by(PersonID, begin) %>%
  mutate(duplicated = n()) %>%
  filter(attend.interval == max(attend.interval)) %>%
  ungroup() %>%
  group_by(PersonID) %>%
  summarize(n.days.attend.ps = sum(attend.interval)) %>%
  ungroup()
  
head(nsc.enrollment.n.days.attend)

names(nsc.enrollment.n.days.attend)
```

<br>

As expected, we have the same number of rows as the previous dataset - `r comma(nsc.enrollment.n.days.attend %>% nrow(), accuracy = 1)` rows. 

Here are the definitions of the institution sector;

* 0	- Administrative Unit	
* 1	- Public, 4-year or above		
* 2	- Private not-for-profit, 4-year or above		
* 3	- Private for-profit, 4-year or above		
* 4	- Public, 2-year		
* 5	- Private not-for-profit, 2-year		
* 6	- Private for-profit, 2-year		
* 7	- Public, less-than 2-year		
* 8	- Private not-for-profit, less-than 2-year		
* 9	- Private for-profit, less-than 2-year		
* 99 - Sector unknown (not active)


